================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\AccountController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Account;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Yajra\DataTables\Facades\DataTables;
use App\Http\Requests\StoreAccountRequest;
use App\Http\Requests\UpdateAccountRequest;

class AccountController extends Controller
{
    public function index(Request $request)
    {
        $viewType = $request->get('view', 'table');
        
        if ($request->ajax()) {
            return $this->getDataTableData($request);
        }
        
        if ($viewType === 'tree') {
            $accounts = $this->getTreeData();
            return view('accounts.index', compact('accounts', 'viewType'));
        }
        
        $query = Account::with('parentAccount');
        
        if ($request->filled('search')) {
            $search = $request->search;
            $query->where(function($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('code', 'like', "%{$search}%");
            });
        }
        
        if ($request->filled('type')) {
            $query->where('type', $request->type);
        }
        
        if ($request->filled('is_active')) {
            $query->where('is_active', $request->is_active);
        }
        
        $accounts = $query->paginate(15);
        
        return view('accounts.index', compact('accounts', 'viewType'));
    }

private function getDataTableData(Request $request)
{
    $query = Account::with('parentAccount')
        ->select('accounts.*');
    
    // Apply custom filters
    if ($request->filled('type')) {
        $query->where('type', $request->type);
    }
    
    if ($request->filled('is_active')) {
        $query->where('is_active', $request->is_active);
    }
    
    return DataTables::eloquent($query)
        ->filter(function ($query) use ($request) {
            // Handle DataTables search parameter
            if ($request->has('search') && !empty($request->search['value'])) {
                $search = $request->search['value'];
                $query->where(function($q) use ($search) {
                    $q->where('name', 'like', "%{$search}%")
                      ->orWhere('code', 'like', "%{$search}%")
                      ->orWhere('description', 'like', "%{$search}%");
                });
            }
        })
        ->addColumn('type_badge', function($account) {
            $colors = [
                'asset' => 'primary',
                'liability' => 'danger',
                'equity' => 'info',
                'income' => 'success',
                'expense' => 'warning'
            ];
            $color = $colors[$account->type] ?? 'secondary';
            return '<span class="badge badge-' . $color . '">' . ucfirst($account->type) . '</span>';
        })
        ->addColumn('parent_name', function($account) {
            return $account->parentAccount ? $account->parentAccount->name : '-';
        })
        ->addColumn('balance_formatted', function($account) {
            $class = $account->current_balance < 0 ? 'text-danger' : '';
            return '<span class="' . $class . '">' . number_format($account->current_balance, 2) . '</span>';
        })
        ->addColumn('status_badge', function($account) {
            return $account->is_active 
                ? '<span class="badge badge-success">Active</span>' 
                : '<span class="badge badge-secondary">Inactive</span>';
        })
        ->addColumn('actions', function ($account) {
            $viewBtn = '<a href="' . route('accounts.show', $account) . '" class="btn btn-info btn-sm" title="View"><i class="fas fa-eye"></i></a>';
            $editBtn = '<a href="' . route('accounts.edit', $account) . '" class="btn btn-warning btn-sm" title="Edit"><i class="fas fa-edit"></i></a>';
            $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-account" data-id="' . $account->id . '" title="Delete"><i class="fas fa-trash"></i></button>';
            
            return $viewBtn . ' ' . $editBtn . ' ' . $deleteBtn;
        })
        ->rawColumns(['type_badge', 'balance_formatted', 'status_badge', 'actions'])
        ->make(true);
}


    private function getTreeData()
    {
        $parentAccounts = Account::whereNull('parent_account_id')
            ->orWhere('parent_account_id', 0)
            ->with(['children' => function($query) {
                $query->with('children');
            }])
            ->orderBy('code')
            ->get();
        
        foreach ($parentAccounts as $parent) {
            $parent->total_balance = $this->calculateAccountTotal($parent);
        }
        
        return $parentAccounts;
    }
    
    private function calculateAccountTotal($account)
    {
        $total = $account->current_balance;
        
        if ($account->children && $account->children->count() > 0) {
            foreach ($account->children as $child) {
                $total += $this->calculateAccountTotal($child);
            }
        }
        
        return $total;
    }

    public function create()
    {
        $accountTypes = [
            'asset' => 'Asset',
            'liability' => 'Liability',
            'equity' => 'Equity',
            'income' => 'Income',
            'expense' => 'Expense',
        ];
        
        $parentAccounts = Account::where('is_active', true)
            ->orderBy('code')
            ->get();
        
        return view('accounts.create', compact('accountTypes', 'parentAccounts'));
    }

    public function store(StoreAccountRequest $request)
    {
        $account = Account::create($request->validated());
        
        return redirect()
            ->route('accounts.index')
            ->with('success', 'Account created successfully.');
    }

public function show(Account $account)
{
    $account->load(['parentAccount', 'childAccounts']);
    $currentBalance = $account->getCurrentBalance();
    
    return view('accounts.show', compact('account', 'currentBalance'));
}

// Add this new method
public function getTransactions(Request $request, Account $account)
{
    if ($request->ajax()) {
        $query = DB::table('transaction_entries as te')
            ->join('transactions as t', 'te.transaction_id', '=', 't.id')
            ->where('te.account_id', $account->id)
            ->select(
                't.id as transaction_id',
                't.date',
                't.reference',
                't.description',
                'te.type',
                'te.amount',
                'te.memo',
                't.status'
            )
            ->orderBy('t.date', 'desc')
            ->orderBy('t.id', 'desc');

        // Apply filters
        if ($request->filled('date_from')) {
            $query->where('t.date', '>=', $request->date_from);
        }
        
        if ($request->filled('date_to')) {
            $query->where('t.date', '<=', $request->date_to);
        }
        
        if ($request->filled('transaction_type')) {
            $query->where('te.type', $request->transaction_type);
        }

        if ($request->filled('other_account_id')) {
            $otherAccountId = $request->other_account_id;
            $query->whereExists(function($q) use ($account, $otherAccountId) {
                $q->select(DB::raw(1))
                  ->from('transaction_entries as te2')
                  ->whereRaw('te2.transaction_id = te.transaction_id')
                  ->where('te2.account_id', '!=', $account->id)
                  ->where('te2.account_id', $otherAccountId);
            });
        }

        return DataTables::of($query)
            ->editColumn('date', function ($entry) {
                return date('d M Y', strtotime($entry->date));
            })
            ->editColumn('reference', function ($entry) {
                return $entry->reference ?? '-';
            })
            ->addColumn('other_account', function ($entry) use ($account) {
                // Get the other account(s) in this transaction
                $otherEntries = DB::table('transaction_entries')
                    ->join('accounts', 'transaction_entries.account_id', '=', 'accounts.id')
                    ->where('transaction_entries.transaction_id', $entry->transaction_id)
                    ->where('transaction_entries.account_id', '!=', $account->id)
                    ->select('accounts.code', 'accounts.name', 'accounts.id')
                    ->get();
                
                if ($otherEntries->count() === 1) {
                    $other = $otherEntries->first();
                    return '<a href="' . route('accounts.show', $other->id) . '">' . 
                           '<span class="badge badge-info">' . e($other->code) . '</span> ' . 
                           e($other->name) . '</a>';
                } elseif ($otherEntries->count() > 1) {
                    return '<span class="text-muted"><i>Split (' . $otherEntries->count() . ' accounts)</i></span>';
                }
                return '<span class="text-muted">-</span>';
            })
            ->addColumn('debit', function ($entry) {
                return $entry->type === 'debit' 
                    ? '<span class="text-danger font-weight-bold">' . number_format($entry->amount, 2) . '</span>' 
                    : '<span class="text-muted">-</span>';
            })
            ->addColumn('credit', function ($entry) {
                return $entry->type === 'credit' 
                    ? '<span class="text-success font-weight-bold">' . number_format($entry->amount, 2) . '</span>' 
                    : '<span class="text-muted">-</span>';
            })
            ->addColumn('actions', function ($entry) {
                $viewBtn = '<a href="' . route('transactions.show', $entry->transaction_id) . '" 
                            class="btn btn-sm btn-info" title="View Transaction">
                            <i class="fas fa-eye"></i>
                            </a>';
                
                $deleteBtn = '<button type="button" 
                                class="btn btn-sm btn-danger delete-transaction" 
                                data-id="' . $entry->transaction_id . '" 
                                title="Delete Transaction">
                                <i class="fas fa-trash"></i>
                                </button>';
                
                return $viewBtn . ' ' . $deleteBtn;
            })

            ->rawColumns(['other_account', 'debit', 'credit', 'actions'])
            ->make(true);
    }
}




    public function edit(Account $account)
    {
        $accountTypes = [
            'asset' => 'Asset',
            'liability' => 'Liability',
            'equity' => 'Equity',
            'income' => 'Income',
            'expense' => 'Expense',
        ];
        
        $parentAccounts = Account::where('is_active', true)
            ->where('id', '!=', $account->id)
            ->orderBy('code')
            ->get();
        
        return view('accounts.edit', compact('account', 'accountTypes', 'parentAccounts'));
    }

    public function update(UpdateAccountRequest $request, Account $account)
    {
        $account->update($request->validated());
        
        return redirect()
            ->route('accounts.index')
            ->with('success', 'Account updated successfully.');
    }

    public function destroy(Account $account)
    {
        if ($account->transactionEntries()->count() > 0) {
            return redirect()
                ->route('accounts.index')
                ->with('error', 'Cannot delete account with existing transactions.');
        }
        
        if ($account->childAccounts()->count() > 0) {
            return redirect()
                ->route('accounts.index')
                ->with('error', 'Cannot delete account with child accounts.');
        }
        
        $account->delete();
        
        return redirect()
            ->route('accounts.index')
            ->with('success', 'Account deleted successfully.');
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\CompanySettingController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\CompanySetting;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Storage;

class CompanySettingController extends Controller
{
    /**
     * Display company settings
     */
    public function index()
    {
        $settings = CompanySetting::getInstance();
        
        return view('settings.company.index', compact('settings'));
    }

    /**
     * Update company settings
     */
public function update(Request $request)
{
    $validated = $request->validate([
        // Company Information
        'company_name' => 'required|string|max:255',
        'company_name_bangla' => 'nullable|string|max:255',
        'tagline' => 'nullable|string|max:255',
        'logo' => 'nullable|image|mimes:jpeg,png,jpg,svg|max:2048',
        'favicon' => 'nullable|image|mimes:png,ico|max:512',
        
        // Contact Information
        'email' => 'nullable|email|max:255',
        'phone' => 'nullable|string|max:50',
        'mobile' => 'nullable|string|max:50',
        'fax' => 'nullable|string|max:50',
        'website' => 'nullable|url|max:255',
        
        // Address Information
        'address' => 'required|string',
        'city' => 'nullable|string|max:100',
        'state' => 'nullable|string|max:100',
        'postal_code' => 'nullable|string|max:20',
        'country' => 'required|string|max:100',
        
        // Business Information
        'bin' => 'nullable|string|max:50',
        'tin' => 'nullable|string|max:50',
        'trade_license' => 'nullable|string|max:50',
        'vat_registration' => 'nullable|string|max:50',
        
        // Bank Accounts (handled separately)
        'bank_accounts' => 'nullable|json',
        
        // Document Settings
        'terms_and_conditions' => 'nullable|string',
        'invoice_footer' => 'nullable|string|max:500',
        'quotation_footer' => 'nullable|string|max:500',
        'receipt_footer' => 'nullable|string|max:500',
        
        // Fiscal Year
        'fiscal_year_start' => 'nullable|date',
        'fiscal_year_end' => 'nullable|date|after:fiscal_year_start',
        
        // Currency Settings
        'currency_code' => 'required|string|max:10',
        'currency_symbol' => 'required|string|max:10',
        'currency_position' => 'required|in:left,right',
        
        // Print Settings - Remove validation for boolean fields
        'print_paper_size' => 'required|in:A4,Letter,Legal',
    ]);

    DB::beginTransaction();
    try {
        $settings = CompanySetting::getInstance();
        
        // Handle logo upload
        if ($request->hasFile('logo')) {
            // Delete old logo
            if ($settings->logo && Storage::disk('public')->exists($settings->logo)) {
                Storage::disk('public')->delete($settings->logo);
            }
            
            $logoPath = $request->file('logo')->store('company', 'public');
            $validated['logo'] = $logoPath;
        }
        
        // Handle favicon upload
        if ($request->hasFile('favicon')) {
            // Delete old favicon
            if ($settings->favicon && Storage::disk('public')->exists($settings->favicon)) {
                Storage::disk('public')->delete($settings->favicon);
            }
            
            $faviconPath = $request->file('favicon')->store('company', 'public');
            $validated['favicon'] = $faviconPath;
        }
        
        // Handle bank accounts
        if ($request->filled('bank_accounts')) {
            $validated['bank_accounts'] = json_decode($request->bank_accounts, true);
        }
        
        // Convert checkboxes to proper boolean using Laravel's boolean() method
        $validated['show_logo_in_print'] = $request->boolean('show_logo_in_print');
        $validated['show_company_info_in_print'] = $request->boolean('show_company_info_in_print');
        
        $settings->update($validated);
        
        // Clear cache
        \App\Helpers\CompanyHelper::clearCache();
        
        DB::commit();
        
        Log::info('Company settings updated', [
            'user_id' => auth()->id(),
            'company_name' => $validated['company_name']
        ]);
        
        if ($request->ajax()) {
            return response()->json([
                'success' => true,
                'message' => 'Company settings updated successfully!',
                'data' => $settings,
            ]);
        }
        
        return redirect()
            ->route('settings.company.index')
            ->with('success', 'Company settings updated successfully!');
            
    } catch (\Exception $e) {
        DB::rollBack();
        Log::error('Company settings update error: ' . $e->getMessage(), [
            'trace' => $e->getTraceAsString()
        ]);
        
        if ($request->ajax()) {
            return response()->json([
                'success' => false,
                'message' => 'Error updating settings: ' . $e->getMessage(),
            ], 500);
        }
        
        return redirect()
            ->back()
            ->withInput()
            ->with('error', 'Error updating settings: ' . $e->getMessage());
    }
}


    /**
     * Delete logo
     */
    public function deleteLogo()
    {
        try {
            $settings = CompanySetting::getInstance();
            
            if ($settings->logo && Storage::disk('public')->exists($settings->logo)) {
                Storage::disk('public')->delete($settings->logo);
                $settings->update(['logo' => null]);
            }
            
            return response()->json([
                'success' => true,
                'message' => 'Logo deleted successfully!',
            ]);
            
        } catch (\Exception $e) {
            Log::error('Logo deletion error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error deleting logo: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Delete favicon
     */
    public function deleteFavicon()
    {
        try {
            $settings = CompanySetting::getInstance();
            
            if ($settings->favicon && Storage::disk('public')->exists($settings->favicon)) {
                Storage::disk('public')->delete($settings->favicon);
                $settings->update(['favicon' => null]);
            }
            
            return response()->json([
                'success' => true,
                'message' => 'Favicon deleted successfully!',
            ]);
            
        } catch (\Exception $e) {
            Log::error('Favicon deletion error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error deleting favicon: ' . $e->getMessage(),
            ], 500);
        }
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\ContraVoucherController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\ContraVoucher;
use App\Models\Account;
use App\Models\Transaction;
use App\Models\TransactionEntry;
use App\Observers\TransactionObserver;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Yajra\DataTables\Facades\DataTables;

class ContraVoucherController extends Controller
{
    /**
     * Display a listing of contra vouchers with server-side DataTables
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $query = ContraVoucher::with(['fromAccount', 'toAccount'])
                ->select('contra_vouchers.*');
            
            // Filter by date range
            if ($request->filled('start_date')) {
                $query->whereDate('contra_date', '>=', $request->start_date);
            }
            if ($request->filled('end_date')) {
                $query->whereDate('contra_date', '<=', $request->end_date);
            }
            
            // Filter by status
            if ($request->filled('status')) {
                $query->where('status', $request->status);
            }
            
            // Filter by transfer method
            if ($request->filled('transfer_method')) {
                $query->where('transfer_method', $request->transfer_method);
            }
            
            return DataTables::eloquent($query)
                ->addIndexColumn()
                ->addColumn('voucher_number', function ($row) {
                    return '<a href="' . route('vouchers.contra.show', $row->id) . '">' .
                           '<strong>' . $row->voucher_number . '</strong></a>';
                })
                ->addColumn('contra_date', function ($row) {
                    return $row->contra_date->format('d M Y');
                })
                ->addColumn('from_account', function ($row) {
                    return '<span class="badge badge-danger">' . 
                           $row->fromAccount->name . '</span>';
                })
                ->addColumn('to_account', function ($row) {
                    return '<span class="badge badge-success">' . 
                           $row->toAccount->name . '</span>';
                })
                ->addColumn('amount', function ($row) {
                    return '<strong>' . number_format($row->amount, 2) . '</strong>';
                })
                ->addColumn('transfer_method', function ($row) {
                    $badges = [
                        'cash' => 'badge-success',
                        'bank_transfer' => 'badge-primary',
                        'cheque' => 'badge-info',
                        'online' => 'badge-warning',
                    ];
                    $badge = $badges[$row->transfer_method] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . 
                           ucfirst(str_replace('_', ' ', $row->transfer_method)) . '</span>';
                })
                ->addColumn('status', function ($row) {
                    $badges = [
                        'draft' => 'badge-secondary',
                        'posted' => 'badge-success',
                        'cancelled' => 'badge-danger',
                    ];
                    $badge = $badges[$row->status] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . 
                           ucfirst($row->status) . '</span>';
                })
                ->addColumn('action', function ($row) {
                    $viewBtn = '<a href="' . route('vouchers.contra.show', $row->id) . '" ' .
                               'class="btn btn-info btn-sm" title="View">' .
                               '<i class="fas fa-eye"></i></a>';
                    
                    $editBtn = '';
                    if ($row->can_edit) {
                        $editBtn = '<a href="' . route('vouchers.contra.edit', $row->id) . '" ' .
                                   'class="btn btn-primary btn-sm" title="Edit">' .
                                   '<i class="fas fa-edit"></i></a>';
                    }
                    
                    $cancelBtn = '';
                    if ($row->can_cancel) {
                        $cancelBtn = '<button type="button" class="btn btn-warning btn-sm cancel-btn" ' .
                                     'data-id="' . $row->id . '" title="Cancel">' .
                                     '<i class="fas fa-ban"></i></button>';
                    }
                    
                    $deleteBtn = '';
                    if ($row->status === 'draft') {
                        $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-btn" ' .
                                     'data-id="' . $row->id . '" title="Delete">' .
                                     '<i class="fas fa-trash"></i></button>';
                    }
                    
                    return '<div class="btn-group">' . $viewBtn . $editBtn . $cancelBtn . $deleteBtn . '</div>';
                })
                ->rawColumns(['voucher_number', 'from_account', 'to_account', 'amount', 'transfer_method', 'status', 'action'])
                ->make(true);
        }
        
        return view('vouchers.contra.index');
    }

    /**
     * Show the form for creating a new contra voucher
     */
    public function create(Request $request)
    {
        // Get Cash and Bank accounts only
        $cashBankAccounts = Account::where('is_active', true)
            ->where(function($query) {
                $query->where('name', 'LIKE', '%Cash%')
                      ->orWhere('name', 'LIKE', '%Bank%')
                      ->orWhere('code', 'LIKE', '11%'); // Asset accounts starting with 11
            })
            ->orderBy('name')
            ->get();
        
        // Pre-fill from request parameters
        $preselectedFromAccount = null;
        $preselectedToAccount = null;
        
        if ($request->filled('from_account_id')) {
            $preselectedFromAccount = Account::find($request->from_account_id);
        }
        
        if ($request->filled('to_account_id')) {
            $preselectedToAccount = Account::find($request->to_account_id);
        }
        
        // Generate voucher number
        $voucherNumber = ContraVoucher::generateVoucherNumber();
        
        return view('vouchers.contra.create', compact(
            'cashBankAccounts',
            'preselectedFromAccount',
            'preselectedToAccount',
            'voucherNumber'
        ));
    }

    /**
     * Store a newly created contra voucher in storage
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'contra_date' => 'required|date',
            'transfer_method' => 'required|in:cash,bank_transfer,cheque,online',
            'amount' => 'required|numeric|min:0.01',
            'from_account_id' => 'required|exists:accounts,id',
            'to_account_id' => 'required|exists:accounts,id',
            'cheque_number' => 'nullable|string|max:100',
            'cheque_date' => 'nullable|date',
            'bank_name' => 'nullable|string|max:255',
            'reference_number' => 'nullable|string|max:255',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
        ]);
        
        // Validate accounts are different
        if ($validated['from_account_id'] === $validated['to_account_id']) {
            return response()->json([
                'success' => false,
                'message' => 'Source and destination accounts must be different.',
            ], 422);
        }
        
        // Validate both accounts are cash/bank accounts
        $fromAccount = Account::find($validated['from_account_id']);
        $toAccount = Account::find($validated['to_account_id']);
        
        if (!$this->isCashOrBankAccount($fromAccount) || !$this->isCashOrBankAccount($toAccount)) {
            return response()->json([
                'success' => false,
                'message' => 'Contra vouchers can only be used between Cash and Bank accounts.',
            ], 422);
        }
        
        DB::beginTransaction();
        try {
            // Generate voucher number
            $voucherNumber = ContraVoucher::generateVoucherNumber();
            
            // Create transaction for double-entry
            $transaction = Transaction::create([
                'date' => $validated['contra_date'],
                'type' => 'contra',
                'reference' => $voucherNumber,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);
            
            Log::info('Contra Voucher: Transaction created', [
                'transaction_id' => $transaction->id,
                'reference' => $voucherNumber,
                'status' => $validated['status']
            ]);
            
            // Create transaction entries (double-entry bookkeeping)
            
            // 1. Debit To Account (increases cash/bank)
            $debitEntry = TransactionEntry::create([
                'transaction_id' => $transaction->id,
                'account_id' => $validated['to_account_id'],
                'type' => 'debit',
                'amount' => $validated['amount'],
                'memo' => 'Contra: Transfer received in ' . $toAccount->name,
            ]);
            
            Log::info('Contra Voucher: Debit entry created', [
                'entry_id' => $debitEntry->id,
                'account' => $toAccount->name,
                'amount' => $validated['amount']
            ]);
            
            // 2. Credit From Account (decreases cash/bank)
            $creditEntry = TransactionEntry::create([
                'transaction_id' => $transaction->id,
                'account_id' => $validated['from_account_id'],
                'type' => 'credit',
                'amount' => $validated['amount'],
                'memo' => 'Contra: Transfer sent from ' . $fromAccount->name,
            ]);
            
            Log::info('Contra Voucher: Credit entry created', [
                'entry_id' => $creditEntry->id,
                'account' => $fromAccount->name,
                'amount' => $validated['amount']
            ]);
            
            // Create contra voucher
            $contraVoucher = ContraVoucher::create([
                'voucher_number' => $voucherNumber,
                'contra_date' => $validated['contra_date'],
                'amount' => $validated['amount'],
                'from_account_id' => $validated['from_account_id'],
                'to_account_id' => $validated['to_account_id'],
                'transaction_id' => $transaction->id,
                'transfer_method' => $validated['transfer_method'],
                'cheque_number' => $validated['cheque_number'] ?? null,
                'cheque_date' => $validated['cheque_date'] ?? null,
                'bank_name' => $validated['bank_name'] ?? null,
                'reference_number' => $validated['reference_number'] ?? null,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
                'created_by' => Auth::id(),
            ]);
            
            Log::info('Contra Voucher: Voucher created', [
                'voucher_id' => $contraVoucher->id,
                'voucher_number' => $voucherNumber
            ]);
            
            // Manually trigger observer sync if status is posted
            if ($transaction->status === 'posted') {
                Log::info('Contra Voucher: Triggering observer sync', [
                    'transaction_id' => $transaction->id
                ]);
                
                TransactionObserver::syncToCustomerLedger($transaction);
                
                Log::info('Contra Voucher: Observer sync completed');
            }
            
            DB::commit();
            
            Log::info('Contra Voucher: Transaction committed successfully', [
                'voucher_id' => $contraVoucher->id
            ]);
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Contra voucher created successfully!',
                    'data' => $contraVoucher->load(['fromAccount', 'toAccount', 'transaction']),
                ]);
            }
            
            return redirect()
                ->route('vouchers.contra.show', $contraVoucher->id)
                ->with('success', 'Contra voucher created successfully!');
                
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Contra voucher creation error: ' . $e->getMessage(), [
                'trace' => $e->getTraceAsString()
            ]);
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error creating contra voucher: ' . $e->getMessage(),
                ], 500);
            }
            
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error creating contra voucher: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified contra voucher
     */
    public function show(ContraVoucher $contraVoucher)
    {
        $contraVoucher->load(['fromAccount', 'toAccount', 'transaction.entries.account', 'createdBy']);
        
        return view('vouchers.contra.show', compact('contraVoucher'));
    }

    /**
     * Show the form for editing the specified contra voucher
     */
    public function edit(ContraVoucher $contraVoucher)
    {
        if (!$contraVoucher->can_edit) {
            return redirect()
                ->route('vouchers.contra.show', $contraVoucher->id)
                ->with('error', 'Only draft vouchers can be edited.');
        }
        
        $contraVoucher->load(['fromAccount', 'toAccount']);
        
        // Get Cash and Bank accounts
        $cashBankAccounts = Account::where('is_active', true)
            ->where(function($query) {
                $query->where('name', 'LIKE', '%Cash%')
                      ->orWhere('name', 'LIKE', '%Bank%')
                      ->orWhere('code', 'LIKE', '11%');
            })
            ->orderBy('name')
            ->get();
        
        return view('vouchers.contra.edit', compact('contraVoucher', 'cashBankAccounts'));
    }

    /**
     * Update the specified contra voucher in storage
     */
    public function update(Request $request, ContraVoucher $contraVoucher)
    {
        if (!$contraVoucher->can_edit) {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be edited.',
            ], 422);
        }
        
        $validated = $request->validate([
            'contra_date' => 'required|date',
            'transfer_method' => 'required|in:cash,bank_transfer,cheque,online',
            'amount' => 'required|numeric|min:0.01',
            'from_account_id' => 'required|exists:accounts,id',
            'to_account_id' => 'required|exists:accounts,id',
            'cheque_number' => 'nullable|string|max:100',
            'cheque_date' => 'nullable|date',
            'bank_name' => 'nullable|string|max:255',
            'reference_number' => 'nullable|string|max:255',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
        ]);
        
        // Validate accounts are different
        if ($validated['from_account_id'] === $validated['to_account_id']) {
            return response()->json([
                'success' => false,
                'message' => 'Source and destination accounts must be different.',
            ], 422);
        }
        
        // Validate both accounts are cash/bank accounts
        $fromAccount = Account::find($validated['from_account_id']);
        $toAccount = Account::find($validated['to_account_id']);
        
        if (!$this->isCashOrBankAccount($fromAccount) || !$this->isCashOrBankAccount($toAccount)) {
            return response()->json([
                'success' => false,
                'message' => 'Contra vouchers can only be used between Cash and Bank accounts.',
            ], 422);
        }
        
        DB::beginTransaction();
        try {
            $oldStatus = $contraVoucher->status;
            
            // Update transaction
            if ($contraVoucher->transaction) {
                $contraVoucher->transaction->update([
                    'date' => $validated['contra_date'],
                    'description' => $validated['description'],
                    'notes' => $validated['notes'] ?? null,
                    'status' => $validated['status'],
                ]);
                
                Log::info('Contra Voucher Update: Transaction updated', [
                    'transaction_id' => $contraVoucher->transaction->id,
                    'old_status' => $oldStatus,
                    'new_status' => $validated['status']
                ]);
                
                // Delete old customer ledger entries before deleting transaction entries
                if ($oldStatus === 'posted') {
                    TransactionObserver::deleteCustomerLedger($contraVoucher->transaction);
                }
                
                // Delete old entries
                $contraVoucher->transaction->entries()->delete();
                
                // Create new transaction entries
                TransactionEntry::create([
                    'transaction_id' => $contraVoucher->transaction->id,
                    'account_id' => $validated['to_account_id'],
                    'type' => 'debit',
                    'amount' => $validated['amount'],
                    'memo' => 'Contra: Transfer received in ' . $toAccount->name,
                ]);
                
                TransactionEntry::create([
                    'transaction_id' => $contraVoucher->transaction->id,
                    'account_id' => $validated['from_account_id'],
                    'type' => 'credit',
                    'amount' => $validated['amount'],
                    'memo' => 'Contra: Transfer sent from ' . $fromAccount->name,
                ]);
                
                Log::info('Contra Voucher Update: New entries created');
            }
            
            // Update contra voucher
            $contraVoucher->update([
                'contra_date' => $validated['contra_date'],
                'amount' => $validated['amount'],
                'from_account_id' => $validated['from_account_id'],
                'to_account_id' => $validated['to_account_id'],
                'transfer_method' => $validated['transfer_method'],
                'cheque_number' => $validated['cheque_number'] ?? null,
                'cheque_date' => $validated['cheque_date'] ?? null,
                'bank_name' => $validated['bank_name'] ?? null,
                'reference_number' => $validated['reference_number'] ?? null,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);
            
            // Manually trigger observer sync if status is posted
            if ($contraVoucher->transaction && $validated['status'] === 'posted') {
                Log::info('Contra Voucher Update: Triggering observer sync');
                TransactionObserver::syncToCustomerLedger($contraVoucher->transaction);
            }
            
            DB::commit();
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Contra voucher updated successfully!',
                    'data' => $contraVoucher->load(['fromAccount', 'toAccount', 'transaction']),
                ]);
            }
            
            return redirect()
                ->route('vouchers.contra.show', $contraVoucher->id)
                ->with('success', 'Contra voucher updated successfully!');
                
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Contra voucher update error: ' . $e->getMessage(), [
                'trace' => $e->getTraceAsString()
            ]);
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error updating contra voucher: ' . $e->getMessage(),
                ], 500);
            }
            
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error updating contra voucher: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified contra voucher from storage
     */
    public function destroy(ContraVoucher $contraVoucher)
    {
        if ($contraVoucher->status !== 'draft') {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be deleted.',
            ], 422);
        }
        
        try {
            DB::beginTransaction();
            
            // Delete transaction entries
            if ($contraVoucher->transaction) {
                $contraVoucher->transaction->entries()->delete();
                $contraVoucher->transaction->delete();
            }
            
            // Delete contra voucher
            $contraVoucher->delete();
            
            DB::commit();
            
            return response()->json([
                'success' => true,
                'message' => 'Contra voucher deleted successfully!',
            ]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Contra voucher deletion error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error deleting contra voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Cancel a posted contra voucher
     */
    public function cancel(ContraVoucher $contraVoucher)
    {
        if (!$contraVoucher->can_cancel) {
            return response()->json([
                'success' => false,
                'message' => 'Only posted vouchers can be cancelled.',
            ], 422);
        }
        
        try {
            DB::beginTransaction();
            
            // Delete customer ledger entries before cancelling
            if ($contraVoucher->transaction) {
                TransactionObserver::deleteCustomerLedger($contraVoucher->transaction);
                
                // Void the transaction
                $contraVoucher->transaction->update(['status' => 'voided']);
            }
            
            // Update voucher status
            $contraVoucher->update(['status' => 'cancelled']);
            
            DB::commit();
            
            return response()->json([
                'success' => true,
                'message' => 'Contra voucher cancelled successfully!',
            ]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Contra voucher cancellation error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error cancelling contra voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Quick create account via AJAX (TallyERP-style)
     */
    public function quickCreateAccount(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:255|unique:accounts,name',
            'account_type' => 'required|in:cash,bank',
            'opening_balance' => 'nullable|numeric|min:0',
        ]);
        
        DB::beginTransaction();
        try {
            // Determine parent account based on type
            $parentAccount = null;
            if ($validated['account_type'] === 'cash') {
                $parentAccount = Account::where('code', 'LIKE', '1110%')
                    ->orWhere('name', 'LIKE', '%Cash%')
                    ->where('parent_account_id', null)
                    ->first();
            } else {
                $parentAccount = Account::where('code', 'LIKE', '1120%')
                    ->orWhere('name', 'LIKE', '%Bank%')
                    ->where('parent_account_id', null)
                    ->first();
            }
            
            // Generate account code
            $prefix = $validated['account_type'] === 'cash' ? '1110' : '1120';
            $lastAccount = Account::where('code', 'LIKE', $prefix . '%')
                ->orderBy('code', 'desc')
                ->first();
            
            if ($lastAccount) {
                $lastNumber = (int) substr($lastAccount->code, -3);
                $newCode = $prefix . str_pad($lastNumber + 1, 3, '0', STR_PAD_LEFT);
            } else {
                $newCode = $prefix . '001';
            }
            
            // Create account
            $account = Account::create([
                'code' => $newCode,
                'name' => $validated['name'],
                'type' => 'asset',
                'description' => ucfirst($validated['account_type']) . ' account',
                'parent_account_id' => $parentAccount ? $parentAccount->id : null,
                'opening_balance' => $validated['opening_balance'] ?? 0,
                'is_active' => true,
            ]);
            
            DB::commit();
            
            return response()->json([
                'success' => true,
                'message' => 'Account created successfully!',
                'data' => [
                    'id' => $account->id,
                    'name' => $account->name,
                    'code' => $account->code,
                    'type' => $validated['account_type'],
                ],
            ]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Quick account creation error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error creating account: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Search accounts via AJAX for Select2
     */
    public function searchAccounts(Request $request)
    {
        $search = $request->get('q', '');
        $page = $request->get('page', 1);
        $perPage = 20;
        
        $query = Account::where('is_active', true)
            ->where(function($q) {
                $q->where('name', 'LIKE', '%Cash%')
                  ->orWhere('name', 'LIKE', '%Bank%')
                  ->orWhere('code', 'LIKE', '11%');
            });
        
        if (!empty($search)) {
            $query->where(function($q) use ($search) {
                $q->where('name', 'LIKE', "%$search%")
                  ->orWhere('code', 'LIKE', "%$search%");
            });
        }
        
        $total = $query->count();
        $accounts = $query->orderBy('name')
            ->skip(($page - 1) * $perPage)
            ->take($perPage)
            ->get();
        
        $results = $accounts->map(function($account) {
            return [
                'id' => $account->id,
                'text' => $account->code . ' - ' . $account->name,
                'code' => $account->code,
                'name' => $account->name,
            ];
        });
        
        return response()->json([
            'results' => $results,
            'pagination' => [
                'more' => ($page * $perPage) < $total
            ]
        ]);
    }

    /**
     * Helper: Check if account is Cash or Bank account
     */
    private function isCashOrBankAccount(Account $account): bool
    {
        $isCashOrBank = (
            stripos($account->name, 'cash') !== false ||
            stripos($account->name, 'bank') !== false ||
            str_starts_with($account->code, '11')
        );
        
        return $isCashOrBank && $account->type === 'asset';
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Controller.php
================================================================================

<?php

namespace App\Http\Controllers;

abstract class Controller
{
    //
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\CustomerController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Account;
use App\Models\Customer;
use Illuminate\Http\Request;
use App\Models\CustomerGroup;
use Illuminate\Validation\Rule;
use App\Models\TransactionEntry; 
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use App\Models\Transaction;  // ADD THIS

class CustomerController extends Controller
{
    public function index()
    {
        $groups = CustomerGroup::where('is_active', true)->get();
        return view('customers.index', compact('groups'));
    }

public function getData(Request $request)
{
    $query = Customer::with(['group', 'ledgerAccount'])
        ->select('customers.*')
        ->selectRaw('(SELECT SUM(debit - credit) FROM customer_ledger_transactions WHERE customer_id = customers.id) + 
            CASE WHEN customers.opening_balance_type = "debit" THEN customers.opening_balance ELSE -customers.opening_balance END as current_balance');

    // Search functionality
    if ($request->has('search') && !empty($request->search['value'])) {
        $search = $request->search['value'];
        $query->where(function($q) use ($search) {
            $q->where('name', 'like', "%{$search}%")
              ->orWhere('phone', 'like', "%{$search}%")
              ->orWhere('email', 'like', "%{$search}%")
              ->orWhere('address', 'like', "%{$search}%")
              ->orWhere('city', 'like', "%{$search}%")
              ->orWhere('customer_code', 'like', "%{$search}%");
        });
    }

    // Filter by group
    if ($request->filled('group_id')) {
        $query->where('customer_group_id', $request->group_id);
    }

    // Filter by status
    if ($request->filled('status')) {
        $query->where('is_active', $request->status);
    }

    // Filter by overdue
    if ($request->filled('overdue') && $request->overdue == 1) {
        $query->whereNotNull('current_due_date')
              ->whereDate('current_due_date', '<', now())
              ->having('current_balance', '>', 0);
    }

    $totalRecords = Customer::count();
    $filteredRecords = $query->count();

    // Sorting
    $orderColumn = $request->order[0]['column'] ?? 0;
    $orderDir = $request->order[0]['dir'] ?? 'asc';
    
    $columns = ['customer_code', 'name', 'phone', 'address', 'current_balance'];
    if (isset($columns[$orderColumn])) {
        $query->orderBy($columns[$orderColumn], $orderDir);
    }

    // Pagination
    $start = $request->start ?? 0;
    $length = $request->length ?? 10;
    $customers = $query->skip($start)->take($length)->get();

    $data = [];
    
    foreach ($customers as $customer) {
        $overdueBadge = '';
        
        // Check for overdue
        if ($customer->current_due_date) {
            $dueDate = \Carbon\Carbon::parse($customer->current_due_date);
            $today = \Carbon\Carbon::today();
            
            // Customer is overdue if: due date is before today AND has positive balance
            if ($dueDate->lt($today) && floatval($customer->current_balance) > 0) {
                $overdueDays = $today->diffInDays($dueDate);
                
                if ($overdueDays > 0) {
                    $overdueBadge = '<br><span class="badge badge-danger">Overdue: ' . $overdueDays . ' ' . 
                                    ($overdueDays == 1 ? 'day' : 'days') . '</span>';
                }
            }
        }

        $balanceClass = $customer->current_balance >= 0 ? 'text-danger' : 'text-success';
        $balanceLabel = $customer->current_balance >= 0 ? 'Dr' : 'Cr';
        $balanceAmount = abs($customer->current_balance);

        $data[] = [
            'id' => $customer->id,
            'customer_code' => $customer->customer_code,
            'name' => $customer->name . ($customer->group ? '<br><small class="text-muted">' . $customer->group->name . '</small>' : ''),
            'phone' => $customer->phone,
            'address' => $customer->address ? (strlen($customer->address) > 50 ? substr($customer->address, 0, 50) . '...' : $customer->address) : '-',
            'current_balance' => '<span class="' . $balanceClass . '"> ' . number_format($balanceAmount, 2) . ' ' . $balanceLabel . '</span>' . $overdueBadge,
            'actions' => view('customers.partials.actions', compact('customer'))->render()
        ];
    }

    return response()->json([
        'draw' => intval($request->draw),
        'recordsTotal' => $totalRecords,
        'recordsFiltered' => $filteredRecords,
        'data' => $data
    ]);
}




    public function create()
    {
        $groups = CustomerGroup::where('is_active', true)->get();
        // Get Sundry Debtors parent account (from your default accounts structure)
        $sundryDebtorsAccount = Account::where('code', '1130')->first(); // Accounts Receivable
        
        return view('customers.create', compact('groups', 'sundryDebtorsAccount'));
    }

public function store(Request $request)
{
    $request->validate([
        'name' => 'required|string|max:255|unique:customers,name',
        'phone' => 'required|string|max:20|unique:customers,phone',
        'email' => 'nullable|email|unique:customers,email',
        'address' => 'nullable|string',
        'city' => 'nullable|string|max:100',
        'state' => 'nullable|string|max:100',
        'postal_code' => 'nullable|string|max:20',
        'customer_group_id' => 'nullable|exists:customer_groups,id',
        'opening_balance' => 'required|numeric|min:0',
        'opening_balance_type' => 'required|in:debit,credit',
        'opening_balance_date' => 'nullable|date',
        'credit_limit' => 'nullable|numeric|min:0',
        'credit_period_days' => 'nullable|integer|min:0',
    ]);

    DB::beginTransaction();
    try {
        // Get Sundry Debtors/Accounts Receivable parent account
        $sundryDebtorsAccount = Account::where('code', '1130')
            ->orWhere('name', 'like', '%Accounts Receivable%')
            ->orWhere('name', 'like', '%Sundry Debtors%')
            ->first();
        
        if (!$sundryDebtorsAccount) {
            throw new \Exception('Sundry Debtors/Accounts Receivable account not found. Please create it first with code 1130.');
        }

        // Create ledger account for this customer under Sundry Debtors
        $ledgerAccount = Account::create([
            'code' => 'CUST-' . time() . '-' . rand(100, 999),
            'name' => $request->name,
            'type' => 'asset',
            'description' => 'Customer ledger account - ' . $request->name,
            'parent_account_id' => $sundryDebtorsAccount->id,
            'opening_balance' => $request->opening_balance_type === 'debit' 
                ? $request->opening_balance 
                : -$request->opening_balance,
            'opening_balance_date' => $request->opening_balance_date,
            'is_active' => true,
        ]);

        // Create customer record
        $customer = Customer::create([
            'name' => $request->name,
            'phone' => $request->phone,
            'email' => $request->email,
            'address' => $request->address,
            'city' => $request->city,
            'state' => $request->state,
            'postal_code' => $request->postal_code,
            'country' => $request->country ?? 'Bangladesh',
            'customer_group_id' => $request->customer_group_id,
            'ledger_account_id' => $ledgerAccount->id,
            'opening_balance' => $request->opening_balance,
            'opening_balance_type' => $request->opening_balance_type,
            'opening_balance_date' => $request->opening_balance_date ?? now(),
            'credit_limit' => $request->credit_limit ?? 0,
            'credit_period_days' => $request->credit_period_days ?? 0,
            'notes' => $request->notes,
            'is_active' => true,
        ]);

        // Create opening balance transaction if opening balance exists
        if ($request->opening_balance > 0) {
            // Get Opening Balance Equity account (contra account for opening balances)
            $equityAccount = Account::where('code', '3100')
                ->orWhere('name', 'like', '%Opening Balance Equity%')
                ->orWhere('name', 'like', '%Retained Earnings%')
                ->first();
            
            if (!$equityAccount) {
                // Try to find any equity account as fallback
                $equityAccount = Account::where('type', 'equity')
                    ->where('is_active', true)
                    ->first();
            }

            if (!$equityAccount) {
                throw new \Exception('Equity account not found for opening balance contra entry. Please create an Opening Balance Equity account with code 3100.');
            }

            // Create the opening balance transaction
            $transaction = Transaction::create([
                'date' => $request->opening_balance_date ?? now(),
                'reference' => 'OB-' . $customer->customer_code,
                'description' => 'Opening balance for customer: ' . $customer->name,
                'notes' => 'System generated opening balance entry',
                'status' => 'posted',
            ]);

            if ($request->opening_balance_type === 'debit') {
                // Outstanding amount (Customer owes us)
                // Dr. Customer Account (Asset increases)
                $transaction->entries()->create([
                    'account_id' => $ledgerAccount->id,
                    'amount' => $request->opening_balance,
                    'type' => 'debit',
                    'memo' => 'Opening balance - Amount receivable from ' . $customer->name,
                ]);

                // Cr. Opening Balance Equity (Equity increases)
                $transaction->entries()->create([
                    'account_id' => $equityAccount->id,
                    'amount' => $request->opening_balance,
                    'type' => 'credit',
                    'memo' => 'Opening balance contra entry for ' . $customer->name,
                ]);

                // Set due date for outstanding amount
                if ($request->credit_period_days > 0) {
                    $dueDate = now()->addDays($request->credit_period_days);
                    $customer->update([
                        'current_due_date' => $dueDate
                    ]);
                } else {
                    // If no credit period, due immediately
                    $customer->update([
                        'current_due_date' => now()
                    ]);
                }
            } else {
                // Advance payment (Customer paid in advance)
                // Cr. Customer Account (Liability increases - we owe them goods/services)
                $transaction->entries()->create([
                    'account_id' => $ledgerAccount->id,
                    'amount' => $request->opening_balance,
                    'type' => 'credit',
                    'memo' => 'Opening balance - Advance payment from ' . $customer->name,
                ]);

                // Dr. Opening Balance Equity (Equity decreases)
                $transaction->entries()->create([
                    'account_id' => $equityAccount->id,
                    'amount' => $request->opening_balance,
                    'type' => 'debit',
                    'memo' => 'Opening balance contra entry for ' . $customer->name,
                ]);
            }
            \App\Observers\TransactionObserver::syncToCustomerLedger($transaction);

            // The TransactionObserver will automatically create the 
            // CustomerLedgerTransaction entry when the transaction is posted
        }

        DB::commit();

        return response()->json([
            'success' => true,
            'message' => 'Customer created successfully!',
            'customer_id' => $customer->id,
            'redirect_url' => route('customers.show', $customer->id)
        ]);

    } catch (\Exception $e) {
        DB::rollBack();
        
        Log::error('Customer creation failed', [
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString(),
            'request' => $request->all()
        ]);

        return response()->json([
            'success' => false,
            'message' => 'Error creating customer: ' . $e->getMessage()
        ], 500);
    }
}


    public function show(Customer $customer)
    {
        $customer->load(['group', 'ledgerAccount', 'dueExtensions.extendedBy']);
        return view('customers.show', compact('customer'));
    }

    public function ledger(Customer $customer)
    {
        return view('customers.ledger', compact('customer'));
    }

    public function getLedgerData(Request $request, Customer $customer)
    {
        $query = $customer->transactions();

        // Date filter
        if ($request->filled('start_date') && $request->filled('end_date')) {
            $query->whereBetween('transaction_date', [$request->start_date, $request->end_date]);
        }

        $totalRecords = $query->count();

        // Sorting
        $orderColumn = $request->order[0]['column'] ?? 0;
        $orderDir = $request->order[0]['dir'] ?? 'desc';
        
        $columns = ['transaction_date', 'voucher_type', 'voucher_number', 'debit', 'credit', 'balance'];
        if (isset($columns[$orderColumn])) {
            $query->orderBy($columns[$orderColumn], $orderDir);
        }

        // Pagination
        $start = $request->start ?? 0;
        $length = $request->length ?? 10;
        $transactions = $query->skip($start)->take($length)->get();

        $data = $transactions->map(function($transaction) {
            return [
                'transaction_date' => $transaction->transaction_date->format('d/m/Y'),
                'voucher_type' => '<span class="badge badge-info">' . $transaction->voucher_type . '</span>',
                'voucher_number' => $transaction->voucher_number,
                'debit' => $transaction->debit > 0 ? ' ' . number_format($transaction->debit, 2) : '-',
                'credit' => $transaction->credit > 0 ? ' ' . number_format($transaction->credit, 2) : '-',
                'balance' => '<span class="' . ($transaction->balance >= 0 ? 'text-danger' : 'text-success') . '"> ' . number_format(abs($transaction->balance), 2) . ' ' . ($transaction->balance >= 0 ? 'Dr' : 'Cr') . '</span>',
                'narration' => $transaction->narration ?? '-',
                'due_date' => $transaction->due_date ? $transaction->due_date->format('d/m/Y') : '-',
            ];
        });

        return response()->json([
            'draw' => intval($request->draw),
            'recordsTotal' => $totalRecords,
            'recordsFiltered' => $totalRecords,
            'data' => $data
        ]);
    }

    public function edit(Customer $customer)
    {
        $groups = CustomerGroup::where('is_active', true)->get();
        return view('customers.edit', compact('customer', 'groups'));
    }

    public function update(Request $request, Customer $customer)
    {
        $request->validate([
            'name' => ['required', 'string', 'max:255', Rule::unique('customers')->ignore($customer->id)],
            'phone' => ['required', 'string', 'max:20', Rule::unique('customers')->ignore($customer->id)],
            'email' => ['nullable', 'email', Rule::unique('customers')->ignore($customer->id)],
            'address' => 'nullable|string',
            'city' => 'nullable|string|max:100',
            'customer_group_id' => 'nullable|exists:customer_groups,id',
            'credit_limit' => 'nullable|numeric|min:0',
            'credit_period_days' => 'nullable|integer|min:0',
        ]);

        DB::beginTransaction();
        try {
            $customer->update($request->only([
                'name', 'phone', 'email', 'address', 'city', 'state', 
                'postal_code', 'customer_group_id', 'credit_limit', 
                'credit_period_days', 'notes', 'is_active'
            ]));

            // Update ledger account name
            $customer->ledgerAccount->update([
                'name' => $request->name,
                'description' => 'Customer account - ' . $request->name,
            ]);

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Customer updated successfully!'
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json([
                'success' => false,
                'message' => 'Error updating customer: ' . $e->getMessage()
            ], 500);
        }
    }

    public function extendDueDate(Request $request, Customer $customer)
    {
        $request->validate([
            'extended_due_date' => 'required|date|after:' . $customer->current_due_date,
            'reason' => 'nullable|string|max:500'
        ]);

        try {
            $customer->extendDueDate($request->extended_due_date, $request->reason);

            return response()->json([
                'success' => true,
                'message' => 'Due date extended successfully!'
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error extending due date: ' . $e->getMessage()
            ], 500);
        }
    }

public function destroy(Customer $customer)
{
    try {
        DB::beginTransaction();
        
        // Check if customer has any ledger transactions
        if ($customer->transactions()->count() > 0) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete customer with existing transactions! Please delete all transactions first or contact administrator.'
            ], 400);
        }

        // Check if the ledger account has any transaction entries
        if ($customer->ledgerAccount->transactionEntries()->count() > 0) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete customer with existing accounting entries! This customer has ' . 
                            $customer->ledgerAccount->transactionEntries()->count() . ' transaction(s) recorded.'
            ], 400);
        }

        // Safe to delete - no transactions exist
        $ledgerAccountId = $customer->ledger_account_id;
        
        // Delete customer first (will cascade delete customer_ledger_transactions)
        $customer->delete();
        
        // Then delete the ledger account
        Account::find($ledgerAccountId)->delete();
        
        DB::commit();

        return response()->json([
            'success' => true,
            'message' => 'Customer deleted successfully!'
        ]);

    } catch (\Exception $e) {
        DB::rollBack();
        
        \Log::error('Customer deletion failed', [
            'customer_id' => $customer->id,
            'error' => $e->getMessage(),
            'trace' => $e->getTraceAsString()
        ]);
        
        return response()->json([
            'success' => false,
            'message' => 'Error deleting customer: ' . $e->getMessage()
        ], 500);
    }
}

public function deactivate(Customer $customer)
{
    try {
        DB::beginTransaction();
        
        $customer->update(['is_active' => false]);
        $customer->ledgerAccount->update(['is_active' => false]);
        
        DB::commit();

        return response()->json([
            'success' => true,
            'message' => 'Customer deactivated successfully! The customer will no longer appear in active lists.'
        ]);

    } catch (\Exception $e) {
        DB::rollBack();
        
        return response()->json([
            'success' => false,
            'message' => 'Error deactivating customer: ' . $e->getMessage()
        ], 500);
    }
}
public function getChartData(Customer $customer)
{
    $months = [];
    $sales = [];
    $payments = [];
    $balance = [];
    
    // Get opening balance
    $runningBalance = $customer->opening_balance_type === 'debit' 
        ? $customer->opening_balance 
        : -$customer->opening_balance;

    // Get last 12 months data
    for ($i = 11; $i >= 0; $i--) {
        $date = now()->subMonths($i);
        $monthStart = $date->copy()->startOfMonth();
        $monthEnd = $date->copy()->endOfMonth();
        
        // Get sales (debit) for this month
        $monthSales = $customer->transactions()
            ->whereBetween('transaction_date', [$monthStart, $monthEnd])
            ->sum('debit');
            
        // Get payments (credit) for this month
        $monthPayments = $customer->transactions()
            ->whereBetween('transaction_date', [$monthStart, $monthEnd])
            ->sum('credit');
        
        // Calculate running balance
        $runningBalance += ($monthSales - $monthPayments);
        
        $months[] = $date->format('M Y');
        $sales[] = round($monthSales, 2);
        $payments[] = round($monthPayments, 2);
        $balance[] = round($runningBalance, 2);
    }

    return response()->json([
        'labels' => $months,
        'sales' => $sales,
        'payments' => $payments,
        'balance' => $balance
    ]);
}



}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\CustomerGroupController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\CustomerGroup;
use Illuminate\Http\Request;
use Illuminate\Validation\Rule;

class CustomerGroupController extends Controller
{
    public function index()
    {
        return view('customer-groups.index');
    }

    public function getData(Request $request)
    {
        $query = CustomerGroup::withCount('customers');

        // Search
        if ($request->has('search') && !empty($request->search['value'])) {
            $search = $request->search['value'];
            $query->where(function($q) use ($search) {
                $q->where('name', 'like', "%{$search}%")
                  ->orWhere('description', 'like', "%{$search}%");
            });
        }

        // Filter by status
        if ($request->filled('status')) {
            $query->where('is_active', $request->status);
        }

        $totalRecords = CustomerGroup::count();
        $filteredRecords = $query->count();

        // Sorting
        $orderColumn = $request->order[0]['column'] ?? 0;
        $orderDir = $request->order[0]['dir'] ?? 'asc';
        
        $columns = ['name', 'description', 'customers_count', 'is_active'];
        if (isset($columns[$orderColumn])) {
            $query->orderBy($columns[$orderColumn], $orderDir);
        }

        // Pagination
        $start = $request->start ?? 0;
        $length = $request->length ?? 10;
        $groups = $query->skip($start)->take($length)->get();

        $data = $groups->map(function($group) {
            $statusBadge = $group->is_active 
                ? '<span class="badge badge-success">Active</span>'
                : '<span class="badge badge-secondary">Inactive</span>';

            return [
                'id' => $group->id,
                'name' => $group->name,
                'description' => $group->description ?? '-',
                'customers_count' => '<span class="badge badge-info">' . $group->customers_count . ' customers</span>',
                'status' => $statusBadge,
                'actions' => view('customer-groups.partials.actions', compact('group'))->render()
            ];
        });

        return response()->json([
            'draw' => intval($request->draw),
            'recordsTotal' => $totalRecords,
            'recordsFiltered' => $filteredRecords,
            'data' => $data
        ]);
    }

    public function create()
    {
        return view('customer-groups.create');
    }

public function store(Request $request)
{
    $request->validate([
        'name' => 'required|string|max:255|unique:customer_groups,name',
        'description' => 'nullable|string',
    ]);

    try {
        CustomerGroup::create([
            'name' => $request->name,
            'description' => $request->description,
            'is_active' => $request->boolean('is_active'), // Properly handle checkbox as boolean
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Customer group created successfully!'
        ]);

    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => 'Error creating customer group: ' . $e->getMessage()
        ], 500);
    }
}


    public function edit(CustomerGroup $customerGroup)
    {
        return view('customer-groups.edit', compact('customerGroup'));
    }

public function update(Request $request, CustomerGroup $customerGroup)
{
    $request->validate([
        'name' => ['required', 'string', 'max:255', Rule::unique('customer_groups')->ignore($customerGroup->id)],
        'description' => 'nullable|string',
    ]);

    try {
        $customerGroup->update([
            'name' => $request->name,
            'description' => $request->description,
            'is_active' => $request->boolean('is_active'), // Properly handle checkbox as boolean
        ]);

        return response()->json([
            'success' => true,
            'message' => 'Customer group updated successfully!'
        ]);

    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => 'Error updating customer group: ' . $e->getMessage()
        ], 500);
    }
}


    public function destroy(CustomerGroup $customerGroup)
    {
        try {
            // Check if group has customers
            if ($customerGroup->customers()->count() > 0) {
                return response()->json([
                    'success' => false,
                    'message' => 'Cannot delete group with existing customers!'
                ], 400);
            }

            $customerGroup->delete();

            return response()->json([
                'success' => true,
                'message' => 'Customer group deleted successfully!'
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error deleting customer group: ' . $e->getMessage()
            ], 500);
        }
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\DeliveryController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\User;
use App\Models\Invoice;
use App\Models\Delivery;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Services\Sales\DeliveryService;

class DeliveryController extends Controller
{
    protected $deliveryService;

    public function __construct(DeliveryService $deliveryService)
    {
        $this->deliveryService = $deliveryService;
    }

    /**
     * Show delivery creation modal data
     */
    public function create(Request $request)
    {
        $invoiceId = $request->get('invoice_id');
        $invoice = Invoice::with('items')->findOrFail($invoiceId);

        // Get undelivered items
        $items = $invoice->items()
            ->where('delivered_quantity', '<', DB::raw('quantity'))
            ->get()
            ->map(function($item) {
                return [
                    'id' => $item->id,
                    'description' => $item->description,
                    'quantity' => $item->quantity,
                    'delivered_quantity' => $item->delivered_quantity,
                    'remaining' => $item->quantity - $item->delivered_quantity,
                    'unit' => $item->unit ? $item->unit->symbol : '',
                    'unit_price' => $item->unit_price,
                ];
            });

        $users = User::where('is_active', true)->get();

        return response()->json([
            'invoice' => $invoice->toArray(),
            'items' => $items,
            'users' => $users,
        ]);
    }

    /**
     * Store delivery
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'invoice_id' => 'required|exists:invoices,id',
            'delivery_date' => 'required|date',
            'delivery_method' => 'nullable|string',
            'driver_name' => 'nullable|string',
            'delivered_by_user_id' => 'required|exists:users,id',
            'items' => 'required|array|min:1',
            'items.*.invoice_item_id' => 'required|exists:invoice_items,id',
            'items.*.delivered_quantity' => 'required|numeric|min:0.01',
            'notes' => 'nullable|string',
        ]);

        try {
            $invoice = Invoice::find($validated['invoice_id']);
            $delivery = $this->deliveryService->createDelivery($invoice, $validated);

            return response()->json([
                'success' => true,
                'message' => 'Delivery created successfully!',
                'delivery' => $delivery,
                'challan_number' => $delivery->challan_number,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error creating delivery: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Delete delivery
     */
    public function destroy(Delivery $delivery)
    {
        try {
            $this->deliveryService->deleteDelivery($delivery);

            return response()->json([
                'success' => true,
                'message' => 'Delivery deleted and reversed successfully!',
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error deleting delivery: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Print delivery challan
     */
    public function print(Delivery $delivery)
    {
        $delivery->load(['invoice.customer', 'items.invoiceItem']);

        return view('sales.delivery.print', compact('delivery'));
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\JournalVoucherController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\JournalVoucher;
use App\Models\Account;
use App\Models\Transaction;
use App\Models\TransactionEntry;
use App\Observers\TransactionObserver;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\Auth;
use Yajra\DataTables\Facades\DataTables;

class JournalVoucherController extends Controller
{
    /**
     * Display a listing of journal vouchers with server-side DataTables
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $query = JournalVoucher::with(['transaction'])
                ->select('journal_vouchers.*');
            
            // Filter by date range
            if ($request->filled('start_date')) {
                $query->whereDate('journal_date', '>=', $request->start_date);
            }
            if ($request->filled('end_date')) {
                $query->whereDate('journal_date', '<=', $request->end_date);
            }
            
            // Filter by status
            if ($request->filled('status')) {
                $query->where('status', $request->status);
            }
            
            return DataTables::eloquent($query)
                ->addIndexColumn()
                ->addColumn('voucher_number', function ($row) {
                    return '<a href="' . route('vouchers.journal.show', $row->id) . '">' .
                           '<strong>' . $row->voucher_number . '</strong></a>';
                })
                ->addColumn('journal_date', function ($row) {
                    return $row->journal_date->format('d M Y');
                })
                ->addColumn('description', function ($row) {
                    return \Str::limit($row->description, 50);
                })
                ->addColumn('debit', function ($row) {
                    return '<strong class="text-danger">' . number_format($row->total_debit, 2) . '</strong>';
                })
                ->addColumn('credit', function ($row) {
                    return '<strong class="text-success">' . number_format($row->total_credit, 2) . '</strong>';
                })
                ->addColumn('status', function ($row) {
                    $badges = [
                        'draft' => 'badge-secondary',
                        'posted' => 'badge-success',
                        'cancelled' => 'badge-danger',
                    ];
                    $badge = $badges[$row->status] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . 
                           ucfirst($row->status) . '</span>';
                })
                ->addColumn('action', function ($row) {
                    $viewBtn = '<a href="' . route('vouchers.journal.show', $row->id) . '" ' .
                               'class="btn btn-info btn-sm" title="View">' .
                               '<i class="fas fa-eye"></i></a>';
                    
                    $editBtn = '';
                    if ($row->can_edit) {
                        $editBtn = '<a href="' . route('vouchers.journal.edit', $row->id) . '" ' .
                                   'class="btn btn-primary btn-sm" title="Edit">' .
                                   '<i class="fas fa-edit"></i></a>';
                    }
                    
                    $cancelBtn = '';
                    if ($row->can_cancel) {
                        $cancelBtn = '<button type="button" class="btn btn-warning btn-sm cancel-btn" ' .
                                     'data-id="' . $row->id . '" title="Cancel">' .
                                     '<i class="fas fa-ban"></i></button>';
                    }
                    
                    $deleteBtn = '';
                    if ($row->status === 'draft') {
                        $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-btn" ' .
                                     'data-id="' . $row->id . '" title="Delete">' .
                                     '<i class="fas fa-trash"></i></button>';
                    }
                    
                    return '<div class="btn-group">' . $viewBtn . $editBtn . $cancelBtn . $deleteBtn . '</div>';
                })
                ->rawColumns(['voucher_number', 'debit', 'credit', 'status', 'action'])
                ->make(true);
        }
        
        return view('vouchers.journal.index');
    }

    /**
     * Show the form for creating a new journal voucher
     */
    public function create(Request $request)
    {
        // Get all active accounts
        $accounts = Account::where('is_active', true)
            ->orderBy('code')
            ->get();
        
        // Generate voucher number
        $voucherNumber = JournalVoucher::generateVoucherNumber();
        
        return view('vouchers.journal.create', compact('accounts', 'voucherNumber'));
    }

    /**
     * Store a newly created journal voucher in storage
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'journal_date' => 'required|date',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
            'entries' => 'required|array|min:2',
            'entries.*.account_id' => 'required|exists:accounts,id',
            'entries.*.type' => 'required|in:debit,credit',
            'entries.*.amount' => 'required|numeric|min:0.01',
            'entries.*.memo' => 'nullable|string|max:255',
        ]);

        // Calculate totals
        $totalDebit = 0;
        $totalCredit = 0;

        foreach ($validated['entries'] as $entry) {
            if ($entry['type'] === 'debit') {
                $totalDebit += $entry['amount'];
            } else {
                $totalCredit += $entry['amount'];
            }
        }

        // Validate balanced entries
        if (abs($totalDebit - $totalCredit) > 0.01) {
            return response()->json([
                'success' => false,
                'message' => 'Journal entries must be balanced! Debit: ' . number_format($totalDebit, 2) . ', Credit: ' . number_format($totalCredit, 2),
            ], 422);
        }

        DB::beginTransaction();
        try {
            // Generate voucher number
            $voucherNumber = JournalVoucher::generateVoucherNumber();
            
            // Create transaction
            $transaction = Transaction::create([
                'date' => $validated['journal_date'],
                'type' => 'journal',
                'reference' => $voucherNumber,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);
            
            Log::info('Journal Voucher: Transaction created', [
                'transaction_id' => $transaction->id,
                'reference' => $voucherNumber
            ]);
            
            // Create transaction entries
            foreach ($validated['entries'] as $entryData) {
                TransactionEntry::create([
                    'transaction_id' => $transaction->id,
                    'account_id' => $entryData['account_id'],
                    'type' => $entryData['type'],
                    'amount' => $entryData['amount'],
                    'memo' => $entryData['memo'] ?? null,
                ]);
            }
            
            Log::info('Journal Voucher: Entries created', [
                'count' => count($validated['entries'])
            ]);
            
            // Create journal voucher
            $journalVoucher = JournalVoucher::create([
                'voucher_number' => $voucherNumber,
                'journal_date' => $validated['journal_date'],
                'transaction_id' => $transaction->id,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
                'created_by' => Auth::id(),
            ]);
            
            Log::info('Journal Voucher: Voucher created', [
                'voucher_id' => $journalVoucher->id,
                'voucher_number' => $voucherNumber
            ]);
            
            // Manually trigger observer sync if status is posted
            if ($transaction->status === 'posted') {
                Log::info('Journal Voucher: Triggering observer sync');
                TransactionObserver::syncToCustomerLedger($transaction);
            }
            
            DB::commit();
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Journal voucher created successfully!',
                    'data' => $journalVoucher->load(['transaction']),
                ]);
            }
            
            return redirect()
                ->route('vouchers.journal.show', $journalVoucher->id)
                ->with('success', 'Journal voucher created successfully!');
                
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Journal voucher creation error: ' . $e->getMessage(), [
                'trace' => $e->getTraceAsString()
            ]);
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error creating journal voucher: ' . $e->getMessage(),
                ], 500);
            }
            
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error creating journal voucher: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified journal voucher
     */
    public function show(JournalVoucher $journalVoucher)
    {
        $journalVoucher->load(['transaction.entries.account', 'createdBy']);
        
        return view('vouchers.journal.show', compact('journalVoucher'));
    }

    /**
     * Show the form for editing the specified journal voucher
     */
    public function edit(JournalVoucher $journalVoucher)
    {
        if (!$journalVoucher->can_edit) {
            return redirect()
                ->route('vouchers.journal.show', $journalVoucher->id)
                ->with('error', 'Only draft vouchers can be edited.');
        }
        
        $journalVoucher->load(['transaction.entries.account']);
        
        // Get all active accounts
        $accounts = Account::where('is_active', true)
            ->orderBy('code')
            ->get();
        
        return view('vouchers.journal.edit', compact('journalVoucher', 'accounts'));
    }

    /**
     * Update the specified journal voucher in storage
     */
    public function update(Request $request, JournalVoucher $journalVoucher)
    {
        if (!$journalVoucher->can_edit) {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be edited.',
            ], 422);
        }
        
        $validated = $request->validate([
            'journal_date' => 'required|date',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
            'entries' => 'required|array|min:2',
            'entries.*.account_id' => 'required|exists:accounts,id',
            'entries.*.type' => 'required|in:debit,credit',
            'entries.*.amount' => 'required|numeric|min:0.01',
            'entries.*.memo' => 'nullable|string|max:255',
        ]);

        // Calculate totals
        $totalDebit = 0;
        $totalCredit = 0;

        foreach ($validated['entries'] as $entry) {
            if ($entry['type'] === 'debit') {
                $totalDebit += $entry['amount'];
            } else {
                $totalCredit += $entry['amount'];
            }
        }

        // Validate balanced entries
        if (abs($totalDebit - $totalCredit) > 0.01) {
            return response()->json([
                'success' => false,
                'message' => 'Journal entries must be balanced! Debit: ' . number_format($totalDebit, 2) . ', Credit: ' . number_format($totalCredit, 2),
            ], 422);
        }

        DB::beginTransaction();
        try {
            $oldStatus = $journalVoucher->status;
            
            // Update transaction
            if ($journalVoucher->transaction) {
                $journalVoucher->transaction->update([
                    'date' => $validated['journal_date'],
                    'description' => $validated['description'],
                    'notes' => $validated['notes'] ?? null,
                    'status' => $validated['status'],
                ]);
                
                // Delete old customer ledger entries
                if ($oldStatus === 'posted') {
                    TransactionObserver::deleteCustomerLedger($journalVoucher->transaction);
                }
                
                // Delete old entries
                $journalVoucher->transaction->entries()->delete();
                
                // Create new entries
                foreach ($validated['entries'] as $entryData) {
                    TransactionEntry::create([
                        'transaction_id' => $journalVoucher->transaction->id,
                        'account_id' => $entryData['account_id'],
                        'type' => $entryData['type'],
                        'amount' => $entryData['amount'],
                        'memo' => $entryData['memo'] ?? null,
                    ]);
                }
            }
            
            // Update journal voucher
            $journalVoucher->update([
                'journal_date' => $validated['journal_date'],
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);
            
            // Manually trigger observer sync if status is posted
            if ($journalVoucher->transaction && $validated['status'] === 'posted') {
                TransactionObserver::syncToCustomerLedger($journalVoucher->transaction);
            }
            
            DB::commit();
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Journal voucher updated successfully!',
                    'data' => $journalVoucher->load(['transaction']),
                ]);
            }
            
            return redirect()
                ->route('vouchers.journal.show', $journalVoucher->id)
                ->with('success', 'Journal voucher updated successfully!');
                
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Journal voucher update error: ' . $e->getMessage());
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error updating journal voucher: ' . $e->getMessage(),
                ], 500);
            }
            
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error updating journal voucher: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified journal voucher from storage
     */
    public function destroy(JournalVoucher $journalVoucher)
    {
        if ($journalVoucher->status !== 'draft') {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be deleted.',
            ], 422);
        }
        
        try {
            DB::beginTransaction();
            
            // Delete transaction entries
            if ($journalVoucher->transaction) {
                $journalVoucher->transaction->entries()->delete();
                $journalVoucher->transaction->delete();
            }
            
            // Delete journal voucher
            $journalVoucher->delete();
            
            DB::commit();
            
            return response()->json([
                'success' => true,
                'message' => 'Journal voucher deleted successfully!',
            ]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Journal voucher deletion error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error deleting journal voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Cancel a posted journal voucher
     */
    public function cancel(JournalVoucher $journalVoucher)
    {
        if (!$journalVoucher->can_cancel) {
            return response()->json([
                'success' => false,
                'message' => 'Only posted vouchers can be cancelled.',
            ], 422);
        }
        
        try {
            DB::beginTransaction();
            
            // Delete customer ledger entries
            if ($journalVoucher->transaction) {
                TransactionObserver::deleteCustomerLedger($journalVoucher->transaction);
                
                // Void the transaction
                $journalVoucher->transaction->update(['status' => 'voided']);
            }
            
            // Update voucher status
            $journalVoucher->update(['status' => 'cancelled']);
            
            DB::commit();
            
            return response()->json([
                'success' => true,
                'message' => 'Journal voucher cancelled successfully!',
            ]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Journal voucher cancellation error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error cancelling journal voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Search accounts via AJAX for Select2
     */
    public function searchAccounts(Request $request)
    {
        $search = $request->get('q', '');
        $page = $request->get('page', 1);
        $perPage = 20;
        
        $query = Account::where('is_active', true);
        
        if (!empty($search)) {
            $query->where(function($q) use ($search) {
                $q->where('name', 'LIKE', "%$search%")
                  ->orWhere('code', 'LIKE', "%$search%");
            });
        }
        
        $total = $query->count();
        $accounts = $query->orderBy('code')
            ->skip(($page - 1) * $perPage)
            ->take($perPage)
            ->get();
        
        $results = $accounts->map(function($account) {
            return [
                'id' => $account->id,
                'text' => $account->code . ' - ' . $account->name,
                'code' => $account->code,
                'name' => $account->name,
            ];
        });
        
        return response()->json([
            'results' => $results,
            'pagination' => [
                'more' => ($page * $perPage) < $total
            ]
        ]);
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\PaymentController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Invoice;
use App\Models\InvoicePayment;
use App\Models\Account;
use App\Services\Sales\PaymentService;
use Illuminate\Http\Request;

class PaymentController extends Controller
{
    protected $paymentService;

    public function __construct(PaymentService $paymentService)
    {
        $this->paymentService = $paymentService;
    }

    /**
     * Show payment form data (AJAX)
     */
    public function create(Request $request)
    {
        $invoiceId = $request->get('invoice_id');
        $invoice = Invoice::find($invoiceId);

        if (!$invoice) {
            return response()->json(['error' => 'Invoice not found'], 404);
        }

        $cashBankAccounts = Account::whereIn('code', ['1110', '1120'])
            ->where('is_active', true)
            ->get();

        return response()->json([
            'invoice' => [
                'id' => $invoice->id,
                'invoice_number' => $invoice->invoice_number,
                'outstanding_balance' => $invoice->outstanding_balance,
            ],
            'accounts' => $cashBankAccounts,
            'payment_methods' => ['cash', 'bank', 'cheque', 'online'],
        ]);
    }

    /**
     * Record payment (AJAX)
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'invoice_id'      => 'required|exists:invoices,id',
            'payment_date'    => 'required|date',
            'amount'          => 'required|numeric|min:0.01',
            'payment_method'  => 'required|in:cash,bank,cheque,online',
            'account_id'      => 'required|exists:accounts,id',
            'cheque_number'   => 'nullable|string',
            'cheque_date'     => 'nullable|date',
            'bank_name'       => 'nullable|string',
            'notes'           => 'nullable|string',
        ]);

        try {
            $invoice = Invoice::find($validated['invoice_id']);
            $payment = $this->paymentService->recordPayment($invoice, $validated);

            return response()->json([
                'success'         => true,
                'message'         => 'Payment recorded successfully!',
                'payment'         => $payment,
                'new_outstanding' => $invoice->outstanding_balance,
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Delete payment (AJAX, reverse transaction)
     */
    public function destroy(InvoicePayment $payment)
    {
        try {
            $this->paymentService->deletePayment($payment);

            return response()->json([
                'success' => true,
                'message' => 'Payment deleted and reversed successfully!',
            ]);
        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error deleting payment: ' . $e->getMessage(),
            ], 500);
        }
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\PaymentVoucherController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\PaymentVoucher;
use App\Models\Account;
use App\Models\Vendor;
use App\Models\Customer;
use App\Models\Transaction;
use App\Models\TransactionEntry;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Yajra\DataTables\Facades\DataTables;

class PaymentVoucherController extends Controller
{
    /**
     * Display a listing of payment vouchers with server-side DataTables
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $query = PaymentVoucher::with(['paidFromAccount', 'paidToAccount'])
                ->select('payment_vouchers.*');
            
            // Filter by date range
            if ($request->filled('start_date')) {
                $query->whereDate('payment_date', '>=', $request->start_date);
            }
            if ($request->filled('end_date')) {
                $query->whereDate('payment_date', '<=', $request->end_date);
            }
            
            // Filter by status
            if ($request->filled('status')) {
                $query->where('status', $request->status);
            }
            
            // Filter by payment method
            if ($request->filled('payment_method')) {
                $query->where('payment_method', $request->payment_method);
            }
            
            return DataTables::eloquent($query)
                ->addIndexColumn()
                ->addColumn('voucher_number', function ($row) {
                    return '<a href="' . route('vouchers.payment.show', $row->id) . '">' .
                           '<strong>' . $row->voucher_number . '</strong></a>';
                })
                ->addColumn('payment_date', function ($row) {
                    return $row->payment_date->format('d M Y');
                })
                ->addColumn('payee', function ($row) {
                    if ($row->payee_type && $row->payee_id) {
                        $payeeName = $this->getPayeeName($row->payee_type, $row->payee_id);
                        $badge = $row->payee_type === 'vendor' ? 'badge-warning' : 'badge-info';
                        return '<span class="badge ' . $badge . '">' . ucfirst($row->payee_type) . '</span><br>' .
                               '<small>' . $payeeName . '</small>';
                    }
                    return '<span class="badge badge-secondary">N/A</span>';
                })
                ->addColumn('paid_from', function ($row) {
                    return '<span class="badge badge-primary">' . $row->paidFromAccount->name . '</span>';
                })
                ->addColumn('paid_to', function ($row) {
                    return '<span class="badge badge-success">' . $row->paidToAccount->name . '</span>';
                })
                ->addColumn('amount', function ($row) {
                    return '<strong> ' . number_format($row->amount, 2) . '</strong>';
                })
                ->addColumn('payment_method', function ($row) {
                    $badges = [
                        'cash' => 'badge-success',
                        'bank' => 'badge-primary',
                        'cheque' => 'badge-info',
                        'mobile_banking' => 'badge-warning',
                    ];
                    $badge = $badges[$row->payment_method] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . ucfirst(str_replace('_', ' ', $row->payment_method)) . '</span>';
                })
                ->addColumn('status', function ($row) {
                    $badges = [
                        'draft' => 'badge-secondary',
                        'posted' => 'badge-success',
                        'cancelled' => 'badge-danger',
                    ];
                    $badge = $badges[$row->status] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . ucfirst($row->status) . '</span>';
                })
                ->addColumn('action', function ($row) {
                    $viewBtn = '<a href="' . route('vouchers.payment.show', $row->id) . '" class="btn btn-info btn-sm" title="View">
                                    <i class="fas fa-eye"></i>
                                </a>';
                    
                    $editBtn = '';
                    if ($row->canEdit()) {
                        $editBtn = '<a href="' . route('vouchers.payment.edit', $row->id) . '" class="btn btn-primary btn-sm" title="Edit">
                                        <i class="fas fa-edit"></i>
                                    </a>';
                    }
                    
                    $cancelBtn = '';
                    if ($row->canCancel()) {
                        $cancelBtn = '<button type="button" class="btn btn-warning btn-sm cancel-btn" data-id="' . $row->id . '" title="Cancel">
                                        <i class="fas fa-ban"></i>
                                    </button>';
                    }
                    
                    $deleteBtn = '';
                    if ($row->status === 'draft') {
                        $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-btn" data-id="' . $row->id . '" title="Delete">
                                        <i class="fas fa-trash"></i>
                                    </button>';
                    }
                    
                    return '<div class="btn-group">' . $viewBtn . ' ' . $editBtn . ' ' . $cancelBtn . ' ' . $deleteBtn . '</div>';
                })
                ->rawColumns(['voucher_number', 'payee', 'paid_from', 'paid_to', 'amount', 'payment_method', 'status', 'action'])
                ->make(true);
        }
        
        return view('vouchers.payment.index');
    }

    /**
     * Show the form for creating a new payment voucher
     */
    public function create(Request $request)
    {
        // Get accounts for payment source (Cash, Bank accounts)
        $paymentAccounts = Account::where('is_active', true)
            ->whereIn('type', ['asset'])
            ->where(function($query) {
                $query->where('name', 'LIKE', '%Cash%')
                      ->orWhere('name', 'LIKE', '%Bank%')
                      ->orWhere('code', 'LIKE', '1%');
            })
            ->orderBy('name')
            ->get();
        
        // Get all active accounts for payment recipient
        $allAccounts = Account::where('is_active', true)
            ->orderBy('code')
            ->get();
        
        // Get vendors and customers for quick selection
        $vendors = Vendor::where('is_active', true)->orderBy('name')->get();
        $customers = Customer::where('is_active', true)->orderBy('name')->get();
        
        // Pre-fill from request parameters
        $preselectedVendor = null;
        $preselectedAccount = null;
        $payeeType = $request->get('payee_type', 'vendor');
        
        if ($request->filled('vendor_id')) {
            $preselectedVendor = Vendor::find($request->vendor_id);
            if ($preselectedVendor) {
                $preselectedAccount = $preselectedVendor->ledger_account_id;
            }
        }
        
        // Generate voucher number
        $voucherNumber = PaymentVoucher::generateVoucherNumber();
        
        return view('vouchers.payment.create', compact(
            'paymentAccounts',
            'allAccounts',
            'vendors',
            'customers',
            'preselectedVendor',
            'preselectedAccount',
            'payeeType',
            'voucherNumber'
        ));
    }

    /**
     * Store a newly created payment voucher in storage
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'payment_date' => 'required|date',
            'payment_method' => 'required|in:cash,bank,cheque,mobile_banking',
            'amount' => 'required|numeric|min:0.01',
            'payee_type' => 'nullable|in:vendor,customer,employee,other',
            'payee_id' => 'nullable|integer',
            'paid_from_account_id' => 'required|exists:accounts,id',
            'paid_to_account_id' => 'required|exists:accounts,id',
            'cheque_number' => 'nullable|string|max:100',
            'cheque_date' => 'nullable|date',
            'bank_name' => 'nullable|string|max:255',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
        ]);

        // Validate accounts are different
        if ($validated['paid_from_account_id'] === $validated['paid_to_account_id']) {
            return response()->json([
                'success' => false,
                'message' => 'Payment source and destination accounts must be different.',
            ], 422);
        }

        DB::beginTransaction();
        
        try {
            // Generate voucher number
            $voucherNumber = PaymentVoucher::generateVoucherNumber();
            
            // Create transaction for double-entry
            $transaction = Transaction::create([
                'date' => $validated['payment_date'],
                'type' => 'payment',
                'reference' => $voucherNumber,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);

            // Create transaction entries (double-entry bookkeeping)
            // Debit: Paid To Account (increases expense/liability payment or decreases liability)
            TransactionEntry::create([
                'transaction_id' => $transaction->id,
                'account_id' => $validated['paid_to_account_id'],
                'type' => 'debit',
                'amount' => $validated['amount'],
                'memo' => 'Payment: ' . $validated['description'],
            ]);

            // Credit: Paid From Account (decreases cash/bank)
            TransactionEntry::create([
                'transaction_id' => $transaction->id,
                'account_id' => $validated['paid_from_account_id'],
                'type' => 'credit',
                'amount' => $validated['amount'],
                'memo' => 'Payment from: ' . Account::find($validated['paid_from_account_id'])->name,
            ]);

            // Create payment voucher
            $paymentVoucher = PaymentVoucher::create([
                'voucher_number' => $voucherNumber,
                'payment_date' => $validated['payment_date'],
                'payment_method' => $validated['payment_method'],
                'amount' => $validated['amount'],
                'payee_type' => $validated['payee_type'] ?? null,
                'payee_id' => $validated['payee_id'] ?? null,
                'paid_from_account_id' => $validated['paid_from_account_id'],
                'paid_to_account_id' => $validated['paid_to_account_id'],
                'transaction_id' => $transaction->id,
                'cheque_number' => $validated['cheque_number'] ?? null,
                'cheque_date' => $validated['cheque_date'] ?? null,
                'bank_name' => $validated['bank_name'] ?? null,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);

            DB::commit();

            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Payment voucher created successfully!',
                    'data' => $paymentVoucher->load(['paidFromAccount', 'paidToAccount', 'transaction']),
                ]);
            }

            return redirect()
                ->route('vouchers.payment.show', $paymentVoucher->id)
                ->with('success', 'Payment voucher created successfully!');

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Payment voucher creation error: ' . $e->getMessage());
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error creating payment voucher: ' . $e->getMessage(),
                ], 500);
            }

            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error creating payment voucher: ' . $e->getMessage());
        }
    }

    /**
     * Display the specified payment voucher
     */
    public function show(PaymentVoucher $paymentVoucher)
    {
        $paymentVoucher->load(['paidFromAccount', 'paidToAccount', 'transaction.entries.account']);
        
        // Get payee details if exists
        $payeeDetails = null;
        if ($paymentVoucher->payee_type && $paymentVoucher->payee_id) {
            $payeeDetails = $this->getPayeeDetails($paymentVoucher->payee_type, $paymentVoucher->payee_id);
        }
        
        return view('vouchers.payment.show', compact('paymentVoucher', 'payeeDetails'));
    }

    /**
     * Show the form for editing the specified payment voucher
     */
    public function edit(PaymentVoucher $paymentVoucher)
    {
        if (!$paymentVoucher->canEdit()) {
            return redirect()
                ->route('vouchers.payment.show', $paymentVoucher->id)
                ->with('error', 'Only draft vouchers can be edited.');
        }
        
        $paymentVoucher->load(['paidFromAccount', 'paidToAccount']);
        
        // Get accounts
        $paymentAccounts = Account::where('is_active', true)
            ->whereIn('type', ['asset'])
            ->where(function($query) {
                $query->where('name', 'LIKE', '%Cash%')
                      ->orWhere('name', 'LIKE', '%Bank%')
                      ->orWhere('code', 'LIKE', '1%');
            })
            ->orderBy('name')
            ->get();
        
        $allAccounts = Account::where('is_active', true)
            ->orderBy('code')
            ->get();
        
        $vendors = Vendor::where('is_active', true)->orderBy('name')->get();
        $customers = Customer::where('is_active', true)->orderBy('name')->get();
        
        return view('vouchers.payment.edit', compact(
            'paymentVoucher',
            'paymentAccounts',
            'allAccounts',
            'vendors',
            'customers'
        ));
    }

    /**
     * Update the specified payment voucher in storage
     */
    public function update(Request $request, PaymentVoucher $paymentVoucher)
    {
        if (!$paymentVoucher->canEdit()) {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be edited.',
            ], 422);
        }

        $validated = $request->validate([
            'payment_date' => 'required|date',
            'payment_method' => 'required|in:cash,bank,cheque,mobile_banking',
            'amount' => 'required|numeric|min:0.01',
            'payee_type' => 'nullable|in:vendor,customer,employee,other',
            'payee_id' => 'nullable|integer',
            'paid_from_account_id' => 'required|exists:accounts,id',
            'paid_to_account_id' => 'required|exists:accounts,id',
            'cheque_number' => 'nullable|string|max:100',
            'cheque_date' => 'nullable|date',
            'bank_name' => 'nullable|string|max:255',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
        ]);

        // Validate accounts are different
        if ($validated['paid_from_account_id'] === $validated['paid_to_account_id']) {
            return response()->json([
                'success' => false,
                'message' => 'Payment source and destination accounts must be different.',
            ], 422);
        }

        DB::beginTransaction();
        
        try {
            // Update transaction
            if ($paymentVoucher->transaction) {
                $paymentVoucher->transaction->update([
                    'date' => $validated['payment_date'],
                    'description' => $validated['description'],
                    'notes' => $validated['notes'] ?? null,
                    'status' => $validated['status'],
                ]);

                // Delete old entries
                $paymentVoucher->transaction->entries()->delete();

                // Create new transaction entries
                TransactionEntry::create([
                    'transaction_id' => $paymentVoucher->transaction->id,
                    'account_id' => $validated['paid_to_account_id'],
                    'type' => 'debit',
                    'amount' => $validated['amount'],
                    'memo' => 'Payment: ' . $validated['description'],
                ]);

                TransactionEntry::create([
                    'transaction_id' => $paymentVoucher->transaction->id,
                    'account_id' => $validated['paid_from_account_id'],
                    'type' => 'credit',
                    'amount' => $validated['amount'],
                    'memo' => 'Payment from: ' . Account::find($validated['paid_from_account_id'])->name,
                ]);
            }

            // Update payment voucher
            $paymentVoucher->update([
                'payment_date' => $validated['payment_date'],
                'payment_method' => $validated['payment_method'],
                'amount' => $validated['amount'],
                'payee_type' => $validated['payee_type'] ?? null,
                'payee_id' => $validated['payee_id'] ?? null,
                'paid_from_account_id' => $validated['paid_from_account_id'],
                'paid_to_account_id' => $validated['paid_to_account_id'],
                'cheque_number' => $validated['cheque_number'] ?? null,
                'cheque_date' => $validated['cheque_date'] ?? null,
                'bank_name' => $validated['bank_name'] ?? null,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);

            DB::commit();

            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Payment voucher updated successfully!',
                    'data' => $paymentVoucher->load(['paidFromAccount', 'paidToAccount', 'transaction']),
                ]);
            }

            return redirect()
                ->route('vouchers.payment.show', $paymentVoucher->id)
                ->with('success', 'Payment voucher updated successfully!');

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Payment voucher update error: ' . $e->getMessage());
            
            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error updating payment voucher: ' . $e->getMessage(),
                ], 500);
            }

            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error updating payment voucher: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified payment voucher from storage
     */
    public function destroy(PaymentVoucher $paymentVoucher)
    {
        if ($paymentVoucher->status !== 'draft') {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be deleted.',
            ], 422);
        }

        try {
            DB::beginTransaction();

            // Delete transaction entries
            if ($paymentVoucher->transaction) {
                $paymentVoucher->transaction->entries()->delete();
                $paymentVoucher->transaction->delete();
            }

            // Delete payment voucher
            $paymentVoucher->delete();

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Payment voucher deleted successfully!',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Payment voucher deletion error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error deleting payment voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Cancel a posted payment voucher
     */
    public function cancel(PaymentVoucher $paymentVoucher)
    {
        if (!$paymentVoucher->canCancel()) {
            return response()->json([
                'success' => false,
                'message' => 'Only posted vouchers can be cancelled.',
            ], 422);
        }

        try {
            DB::beginTransaction();

            // Update voucher status
            $paymentVoucher->update(['status' => 'cancelled']);

            // Void the transaction
            if ($paymentVoucher->transaction) {
                $paymentVoucher->transaction->update(['status' => 'voided']);
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Payment voucher cancelled successfully!',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Payment voucher cancellation error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error cancelling payment voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Helper: Get payee name
     */
    private function getPayeeName($type, $id)
    {
        switch ($type) {
            case 'vendor':
                $vendor = Vendor::find($id);
                return $vendor ? $vendor->name : 'Unknown Vendor';
            case 'customer':
                $customer = Customer::find($id);
                return $customer ? $customer->name : 'Unknown Customer';
            default:
                return 'N/A';
        }
    }

    /**
     * Helper: Get payee details
     */
    private function getPayeeDetails($type, $id)
    {
        switch ($type) {
            case 'vendor':
                return Vendor::with('ledgerAccount')->find($id);
            case 'customer':
                return Customer::with('ledgerAccount')->find($id);
            default:
                return null;
        }
    }

    /**
     * Get vendor ledger account via AJAX
     */
    public function getVendorAccount(Request $request)
    {
        $vendorId = $request->get('vendor_id');
        $vendor = Vendor::find($vendorId);
        
        if ($vendor && $vendor->ledger_account_id) {
            $account = Account::find($vendor->ledger_account_id);
            return response()->json([
                'success' => true,
                'account_id' => $account->id,
                'account_name' => $account->name,
                'account_code' => $account->code,
            ]);
        }
        
        return response()->json([
            'success' => false,
            'message' => 'Vendor ledger account not found.',
        ], 404);
    }
/**
 * Print payment voucher
 */
public function print(PaymentVoucher $paymentVoucher)
{
    // Eager load all relationships with null safety
    $paymentVoucher->load([
        'paidFromAccount',
        'paidToAccount',
        'createdBy'
    ]);
    
    // Only load transaction if it exists
    if ($paymentVoucher->transaction_id) {
        $paymentVoucher->load('transaction.entries.account');
    }
    
    // Get payee details based on payee_type
    $payeeDetails = null;
    $balanceInfo = null;
    
    if ($paymentVoucher->payee_type === 'vendor' && $paymentVoucher->payee_id) {
        $payeeDetails = Vendor::with('ledgerAccount')->find($paymentVoucher->payee_id);
        
        if ($payeeDetails) {
            $balanceInfo = $this->getVendorBalanceAtDate(
                $paymentVoucher->payee_id,
                $paymentVoucher->payment_date
            );
        }
    } elseif ($paymentVoucher->payee_type === 'customer' && $paymentVoucher->payee_id) {
        $payeeDetails = Customer::with('ledgerAccount')->find($paymentVoucher->payee_id);
        
        if ($payeeDetails) {
            $balanceInfo = $this->getCustomerBalanceAtDate(
                $paymentVoucher->payee_id,
                $paymentVoucher->payment_date
            );
        }
    }
    
    return view('vouchers.payment.print', compact('paymentVoucher', 'payeeDetails', 'balanceInfo'));
}


/**
 * Calculate vendor balance at a specific date
 */
private function getVendorBalanceAtDate($vendorId, $date)
{
    $vendor = Vendor::find($vendorId);
    
    if (!$vendor || !$vendor->ledger_account_id) {
        return [
            'balance_before' => 0,
            'balance_after' => 0,
            'payment_amount' => 0,
        ];
    }
    
    $account = Account::find($vendor->ledger_account_id);
    
    if (!$account) {
        return [
            'balance_before' => 0,
            'balance_after' => 0,
            'payment_amount' => 0,
        ];
    }
    
    // Calculate balance BEFORE this transaction date
    $creditsBefore = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<', $date);
        })
        ->where('type', 'credit')
        ->sum('amount');
    
    $debitsBefore = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<', $date);
        })
        ->where('type', 'debit')
        ->sum('amount');
    
    $transactionBalanceBefore = $creditsBefore - $debitsBefore;
    
    // Add opening balance
    $balanceBefore = $transactionBalanceBefore;
    if ($vendor->opening_balance > 0) {
        if ($vendor->opening_balance_type === 'credit') {
            $balanceBefore += $vendor->opening_balance;
        } else {
            $balanceBefore -= $vendor->opening_balance;
        }
    }
    
    // Calculate balance AFTER (including this date)
    $creditsAfter = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<=', $date);
        })
        ->where('type', 'credit')
        ->sum('amount');
    
    $debitsAfter = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<=', $date);
        })
        ->where('type', 'debit')
        ->sum('amount');
    
    $transactionBalanceAfter = $creditsAfter - $debitsAfter;
    
    $balanceAfter = $transactionBalanceAfter;
    if ($vendor->opening_balance > 0) {
        if ($vendor->opening_balance_type === 'credit') {
            $balanceAfter += $vendor->opening_balance;
        } else {
            $balanceAfter -= $vendor->opening_balance;
        }
    }
    
    return [
        'balance_before' => round($balanceBefore, 2),
        'balance_after' => round($balanceAfter, 2),
        'payment_amount' => round($balanceAfter - $balanceBefore, 2),
    ];
}
/**
 * Calculate customer balance at a specific date
 */
private function getCustomerBalanceAtDate($customerId, $date)
{
    $customer = Customer::find($customerId);
    
    if (!$customer || !$customer->ledger_account_id) {
        return [
            'balance_before' => 0,
            'balance_after' => 0,
            'payment_amount' => 0,
        ];
    }
    
    $account = Account::find($customer->ledger_account_id);
    
    if (!$account) {
        return [
            'balance_before' => 0,
            'balance_after' => 0,
            'payment_amount' => 0,
        ];
    }
    
    // For customers: Debit increases receivable, Credit decreases receivable
    $debitsBefore = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<', $date);
        })
        ->where('type', 'debit')
        ->sum('amount');
    
    $creditsBefore = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<', $date);
        })
        ->where('type', 'credit')
        ->sum('amount');
    
    $transactionBalanceBefore = $debitsBefore - $creditsBefore;
    
    // Add opening balance
    $balanceBefore = $transactionBalanceBefore;
    if ($customer->opening_balance > 0) {
        if ($customer->opening_balance_type === 'debit') {
            $balanceBefore += $customer->opening_balance;
        } else {
            $balanceBefore -= $customer->opening_balance;
        }
    }
    
    // Calculate balance AFTER
    $debitsAfter = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<=', $date);
        })
        ->where('type', 'debit')
        ->sum('amount');
    
    $creditsAfter = $account->transactionEntries()
        ->whereHas('transaction', function ($query) use ($date) {
            $query->where('type', '!=', 'opening_balance')
                  ->where('date', '<=', $date);
        })
        ->where('type', 'credit')
        ->sum('amount');
    
    $transactionBalanceAfter = $debitsAfter - $creditsAfter;
    
    $balanceAfter = $transactionBalanceAfter;
    if ($customer->opening_balance > 0) {
        if ($customer->opening_balance_type === 'debit') {
            $balanceAfter += $customer->opening_balance;
        } else {
            $balanceAfter -= $customer->opening_balance;
        }
    }
    
    return [
        'balance_before' => round($balanceBefore, 2),
        'balance_after' => round($balanceAfter, 2),
        'payment_amount' => round($balanceAfter - $balanceBefore, 2),
    ];
}

}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\ProductController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Product;
use App\Models\ProductGroup;
use App\Models\Unit;
use App\Models\Account;
use App\Models\Transaction;
use App\Models\TransactionEntry;
use App\Models\ProductMovement;
use Illuminate\Http\Request;
use Yajra\DataTables\Facades\DataTables;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Illuminate\Validation\Rule;

class ProductController extends Controller
{
    /**
     * Display a listing of products with server-side DataTables
     */
public function index(Request $request)
{
    if ($request->ajax()) {
        $data = Product::with(['productGroup', 'baseUnit', 'inventoryAccount'])
                      ->select('products.*');
        
        return DataTables::eloquent($data)
            ->addIndexColumn()
            // ADD THESE EXPLICIT COLUMNS FOR id, name, code
            ->editColumn('id', function ($row) {
                return $row->id;
            })
            ->editColumn('name', function ($row) {
                return $row->name;
            })
            ->editColumn('code', function ($row) {
                return $row->code ?? '<span class="text-muted">-</span>';
            })
            // EXISTING CUSTOM COLUMNS
            ->addColumn('group_name', function ($row) {
                return $row->productGroup ? $row->productGroup->full_path : '<span class="badge badge-secondary">No Group</span>';
            })
            ->addColumn('unit_name', function ($row) {
                return '<code>' . $row->baseUnit->symbol . '</code>';
            })
            ->addColumn('current_stock', function ($row) {
                $currentStock = $row->current_stock;
                
                if ($currentStock > 0) {
                    // Check stock levels
                    if ($currentStock <= $row->minimum_stock) {
                        $badgeClass = 'badge-danger';
                    } elseif ($currentStock <= $row->reorder_level) {
                        $badgeClass = 'badge-warning';
                    } else {
                        $badgeClass = 'badge-success';
                    }
                    
                    return '<span class="badge ' . $badgeClass . '">' . 
                           number_format($currentStock, 2) . ' ' . $row->baseUnit->symbol . 
                           '</span>';
                }
                
                return '<span class="badge badge-secondary">0 ' . $row->baseUnit->symbol . '</span>';
            })
            ->addColumn('stock_value', function ($row) {
                $value = $row->current_stock_value;
                if ($value > 0) {
                    return '<strong> ' . number_format($value, 2) . '</strong>';
                }
                return '<span class="text-muted"> 0.00</span>';
            })
            ->addColumn('rate_info', function ($row) {
                if ($row->purchase_price) {
                    return ' ' . number_format($row->purchase_price, 2);
                } elseif ($row->opening_rate) {
                    return ' ' . number_format($row->opening_rate, 2);
                }
                return '<span class="badge badge-warning">Not Set</span>';
            })
            ->addColumn('is_active', function ($row) {
                return $row->is_active 
                    ? '<span class="badge badge-success">Active</span>' 
                    : '<span class="badge badge-danger">Inactive</span>';
            })
            ->addColumn('action', function ($row) {
                $viewBtn = '<a href="' . route('products.show', $row->id) . '" class="btn btn-sm btn-info"><i class="fas fa-eye"></i></a>';
                $editBtn = '<a href="' . route('products.edit', $row->id) . '" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></a>';
                $deleteBtn = '<button type="button" class="btn btn-sm btn-danger delete-btn" data-id="' . $row->id . '"><i class="fas fa-trash"></i></button>';
                
                return '<div class="btn-group">' . $viewBtn . ' ' . $editBtn . ' ' . $deleteBtn . '</div>';
            })
            ->filter(function ($query) use ($request) {
                // Filter by product group
                if ($request->has('product_group_id') && $request->product_group_id != '') {
                    $query->where('product_group_id', $request->product_group_id);
                }
                
                // Filter by status
                if ($request->has('status') && $request->status != '') {
                    $query->where('is_active', $request->status);
                }
            })
            ->rawColumns(['code', 'group_name', 'unit_name', 'current_stock', 'stock_value', 'rate_info', 'is_active', 'action'])
            ->make(true);
    }
    
    // Get product groups for filter dropdown
    $productGroups = ProductGroup::active()->orderBy('name')->get();
    
    return view('products.index', compact('productGroups'));
}



    /**
     * Show the form for creating a new product
     */
    public function create()
    {
        $productGroups = ProductGroup::active()->get();
        $units = Unit::active()->orderBy('name')->get();
        $baseUnits = Unit::active()->where('is_base_unit', true)->orderBy('name')->get();
        $inventoryAccounts = Account::inventoryAccounts()->active()->get();
        
        return view('products.create', compact('productGroups', 'units', 'baseUnits', 'inventoryAccounts'));
    }

    /**
     * Store a newly created product
     */
public function store(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|string|max:200|unique:products,name',
        'code' => 'nullable|string|max:50|unique:products,code',
        'product_group_id' => 'nullable|exists:product_groups,id',
        'base_unit_id' => 'required|exists:units,id',
        'description' => 'nullable|string',
        'opening_quantity' => 'nullable|numeric|min:0',
        'opening_rate' => 'nullable|numeric|min:0',
        'opening_date' => 'nullable|date',
        'inventory_account_id' => 'nullable|exists:accounts,id',
        'minimum_stock' => 'nullable|numeric|min:0',
        'maximum_stock' => 'nullable|numeric|min:0',
        'reorder_level' => 'nullable|numeric|min:0',
        'purchase_price' => 'nullable|numeric|min:0',
        'selling_price' => 'nullable|numeric|min:0',
        'mrp' => 'nullable|numeric|min:0',
        'is_active' => 'nullable|boolean',
        'alt_unit_id' => 'nullable|array',
        'alt_unit_id.*' => 'exists:units,id',
        'conversion_factor' => 'nullable|array',
        'conversion_factor.*' => 'numeric|min:0.0001',
        'is_purchase_unit' => 'nullable|array',
        'is_sales_unit' => 'nullable|array',
    ]);

    DB::beginTransaction();
    try {
        $validated['is_active'] = $request->has('is_active') ? 1 : 0;
        
        // Set opening date if opening quantity is provided but date is not
        if (isset($validated['opening_quantity']) && $validated['opening_quantity'] > 0 && empty($validated['opening_date'])) {
            $validated['opening_date'] = now()->toDateString();
        }
        
        // Validate opening stock has required fields
        if (isset($validated['opening_quantity']) && $validated['opening_quantity'] > 0) {
            if (empty($validated['opening_rate'])) {
                throw new \Exception('Opening rate is required when opening quantity is provided.');
            }
            if (empty($validated['inventory_account_id'])) {
                throw new \Exception('Inventory account is required when opening stock is provided.');
            }
        }
        
        // Create product
        $product = Product::create($validated);

        // Save alternative units
        if ($request->has('alt_unit_id') && is_array($request->alt_unit_id)) {
            foreach ($request->alt_unit_id as $index => $unitId) {
                if ($unitId && isset($request->conversion_factor[$index]) && $request->conversion_factor[$index] > 0) {
                    $product->alternativeUnits()->attach($unitId, [
                        'conversion_factor' => $request->conversion_factor[$index],
                        'is_default' => false,
                        'is_purchase_unit' => isset($request->is_purchase_unit[$index]) ? 1 : 0,
                        'is_sales_unit' => isset($request->is_sales_unit[$index]) ? 1 : 0,
                    ]);
                }
            }
        }

        // Create accounting entry for opening stock
        if ($product->opening_quantity > 0 && $product->opening_rate && $product->inventory_account_id) {
            $transaction = $product->createOpeningStockJournalEntry();
            
            if ($transaction) {
                // Store transaction ID in product
                $product->update(['opening_stock_transaction_id' => $transaction->id]);
            } else {
                throw new \Exception('Failed to create opening stock journal entry.');
            }
        }

        DB::commit();

        return redirect()
            ->route('products.index')
            ->with('success', 'Product created successfully!' . 
                   ($product->opening_quantity > 0 ? ' Opening stock journal entry created.' : ''));

    } catch (\Exception $e) {
        DB::rollBack();
        return redirect()
            ->back()
            ->withInput()
            ->with('error', 'Error creating product: ' . $e->getMessage());
    }
}


    /**
     * Display the specified product
     */
public function show(Product $product)
{
    $product->load('productGroup', 'baseUnit', 'inventoryAccount', 'alternativeUnits');
    
    // Load product movements with relationships
    $movements = $product->movements()
        ->with(['createdBy', 'product.baseUnit'])
        ->orderBy('movement_date', 'desc')
        ->orderBy('created_at', 'desc')
        ->get();
    
    return view('products.show', compact('product', 'movements'));
}


    /**
     * Show the form for editing the specified product
     */
    public function edit(Product $product)
    {
        $product->load('alternativeUnits');
        $productGroups = ProductGroup::active()->get();
        $units = Unit::active()->orderBy('name')->get();
        $baseUnits = Unit::active()->where('is_base_unit', true)->orderBy('name')->get();
        $inventoryAccounts = Account::inventoryAccounts()->active()->get();
        
        return view('products.edit', compact('product', 'productGroups', 'units', 'baseUnits', 'inventoryAccounts'));
    }

    /**
     * Update the specified product
     */
    public function update(Request $request, Product $product)
{
    $validated = $request->validate([
        'name' => [
            'required',
            'string',
            'max:200',
            Rule::unique('products', 'name')->ignore($product->id),
        ],
        'code' => [
            'nullable',
            'string',
            'max:50',
            Rule::unique('products', 'code')->ignore($product->id),
        ],
        'product_group_id' => 'nullable|exists:product_groups,id',
        'base_unit_id' => 'required|exists:units,id',
        'description' => 'nullable|string',
        'opening_quantity' => 'nullable|numeric|min:0',
        'opening_rate' => 'nullable|numeric|min:0',
        'opening_date' => 'nullable|date',
        'inventory_account_id' => 'nullable|exists:accounts,id',
        'minimum_stock' => 'nullable|numeric|min:0',
        'maximum_stock' => 'nullable|numeric|min:0',
        'reorder_level' => 'nullable|numeric|min:0',
        'purchase_price' => 'nullable|numeric|min:0',
        'selling_price' => 'nullable|numeric|min:0',
        'mrp' => 'nullable|numeric|min:0',
        'is_active' => 'nullable|boolean',
        'alt_unit_id' => 'nullable|array',
        'alt_unit_id.*' => 'exists:units,id',
        'conversion_factor' => 'nullable|array',
        'conversion_factor.*' => 'numeric|min:0.0001',
        'is_purchase_unit' => 'nullable|array',
        'is_sales_unit' => 'nullable|array',
    ]);

    DB::beginTransaction();
    try {
        $validated['is_active'] = $request->has('is_active') ? 1 : 0;
        
        // Check if opening stock values changed
        $openingStockChanged = (
            $product->opening_quantity != $validated['opening_quantity'] ||
            $product->opening_rate != $validated['opening_rate'] ||
            $product->inventory_account_id != $validated['inventory_account_id']
        );
        
        // Update product
        $product->update($validated);

        // Sync alternative units (remove old, add new)
        $product->alternativeUnits()->detach();
        
        if ($request->has('alt_unit_id') && is_array($request->alt_unit_id)) {
            foreach ($request->alt_unit_id as $index => $unitId) {
                if ($unitId && isset($request->conversion_factor[$index]) && $request->conversion_factor[$index] > 0) {
                    $product->alternativeUnits()->attach($unitId, [
                        'conversion_factor' => $request->conversion_factor[$index],
                        'is_default' => false,
                        'is_purchase_unit' => isset($request->is_purchase_unit[$index]) ? 1 : 0,
                        'is_sales_unit' => isset($request->is_sales_unit[$index]) ? 1 : 0,
                    ]);
                }
            }
        }

        // Update opening stock transaction if values changed
        if ($openingStockChanged) {
            $transaction = $product->updateOpeningStockJournalEntry();
            
            if ($transaction) {
                $product->update(['opening_stock_transaction_id' => $transaction->id]);
            } else {
                // If no transaction created, clear the reference
                $product->update(['opening_stock_transaction_id' => null]);
            }
        }

        DB::commit();

        return redirect()
            ->route('products.index')
            ->with('success', 'Product updated successfully!');

    } catch (\Exception $e) {
        DB::rollBack();
        return redirect()
            ->back()
            ->withInput()
            ->with('error', 'Error updating product: ' . $e->getMessage());
    }
}


    /**
     * Remove the specified product
     */
public function destroy(Product $product)
{
    try {
        DB::beginTransaction();

        // Check if product has transactions (purchases/sales)
        // TODO: Uncomment when you build sales/purchase system
        // if ($product->hasPurchases() || $product->hasSales()) {
        //     return response()->json([
        //         'success' => false,
        //         'message' => 'Cannot delete product. It has transaction history.',
        //     ], 422);
        // }

        // The deleting event in the Product model will handle:
        // 1. Deleting the opening stock transaction
        // 2. Detaching alternative units
        $product->delete();

        DB::commit();

        return response()->json([
            'success' => true,
            'message' => 'Product and associated transaction deleted successfully!',
        ]);
    } catch (\Exception $e) {
        DB::rollBack();
        
        return response()->json([
            'success' => false,
            'message' => 'Error deleting product: ' . $e->getMessage(),
        ], 500);
    }
}

    /**
     * Helper: Create opening stock journal entry
     * TODO: Implement when you create Journal Entry system
     */
    private function createOpeningStockJournalEntry(Product $product)
    {
        // Will be implemented with Journal Entry feature
        // Debit: Inventory Account
        // Credit: Owner's Capital (Account ID 22 from your seeder)
    }
    /**
 * Quick add product via AJAX (for purchase order form)
 */
public function quickAdd(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|string|max:200|unique:products,name',
        'base_unit' => 'required|string|max:50',
    ]);

    DB::beginTransaction();
    
    try {
        // Find or create the unit
        $unit = Unit::firstOrCreate(
            ['symbol' => strtoupper($validated['base_unit'])],
            [
                'name' => $validated['base_unit'],
                'symbol' => strtoupper($validated['base_unit']),
                'is_base_unit' => true,
                'is_active' => true,
            ]
        );

        // Create product with minimal data
        $product = Product::create([
            'name' => $validated['name'],
            'base_unit_id' => $unit->id,
            'is_active' => true,
        ]);

        DB::commit();

return response()->json([
    'success' => true,
    'id' => $product->id,
    'name' => $product->name,
    'unit' => $unit->symbol,
    'message' => 'Product created successfully!',
]);


    } catch (\Exception $e) {
        DB::rollBack();
        
        return response()->json([
            'success' => false,
            'message' => 'Error creating product: ' . $e->getMessage(),
        ], 500);
    }
}
public function getMovementsDatatable(Request $request, Product $product)
{
    if ($request->ajax()) {
        $movements = ProductMovement::where('product_id', $product->id)
            ->with(['createdBy', 'product.baseUnit'])
            ->select('product_movements.*');
        
        return DataTables::of($movements)
            ->addIndexColumn()
            ->addColumn('date_formatted', function ($row) {
                return '<strong>' . $row->movement_date->format('d M Y') . '</strong><br>' .
                       '<small class="text-muted">' . $row->created_at->format('h:i A') . '</small>';
            })
            ->addColumn('type_badge', function ($row) {
                $badges = [
                    'purchase' => 'badge-success',
                    'sale' => 'badge-danger',
                    'adjustment' => 'badge-warning',
                    'opening_stock' => 'badge-info',
                    'return' => 'badge-primary',
                ];
                $icons = [
                    'purchase' => 'fa-cart-plus',
                    'sale' => 'fa-shopping-cart',
                    'adjustment' => 'fa-adjust',
                    'opening_stock' => 'fa-box-open',
                    'return' => 'fa-undo',
                ];
                
                return '<span class="badge ' . ($badges[$row->type] ?? 'badge-secondary') . '">' .
                       '<i class="fas ' . ($icons[$row->type] ?? 'fa-question') . '"></i> ' .
                       ucfirst(str_replace('_', ' ', $row->type)) .
                       '</span>';
            })
            ->addColumn('reference', function ($row) {
                if ($row->reference_type && $row->reference_id) {
                    $refClass = class_basename($row->reference_type);
                    return '<small class="text-muted">' . $refClass . '</small><br>' .
                           'de>#' . $row->reference_id . '</code>';
                }
                return '<span class="text-muted">-</span>';
            })
            ->addColumn('quantity_formatted', function ($row) {
                $class = $row->type == 'purchase' ? 'text-success' : ($row->type == 'sale' ? 'text-danger' : '');
                $sign = $row->type == 'purchase' ? '+' : ($row->type == 'sale' ? '-' : '');
                
                return '<strong class="' . $class . '">' .
                       $sign . number_format($row->quantity, 2) .
                       '</strong> ' .
                       '<small class="text-muted">' . $row->product->baseUnit->symbol . '</small>';
            })
            ->addColumn('rate_formatted', function ($row) {
                return $row->rate ? ' ' . number_format($row->rate, 2) : '<span class="text-muted">-</span>';
            })
            ->addColumn('stock_before_formatted', function ($row) {
                return number_format($row->stock_before, 2);
            })
            ->addColumn('stock_after_formatted', function ($row) {
                return '<strong>' . number_format($row->stock_after, 2) . '</strong>';
            })
            ->addColumn('created_by_name', function ($row) {
                return $row->createdBy ? $row->createdBy->name : '<small class="text-muted">System</small>';
            })
            ->rawColumns(['date_formatted', 'type_badge', 'reference', 'quantity_formatted', 'rate_formatted', 'stock_after_formatted', 'created_by_name'])
            ->make(true);
    }
}


 /**
     * Get product details with alternative unit conversion
     * Returns current stock in all units
     */
    public function getProductDetails(Request $request)
    {
        try {
            $productId = $request->get('product_id');
            $product = Product::with(['baseUnit', 'alternativeUnits'])
                ->findOrFail($productId);

            // Get current stock in base unit
            $baseStock = $product->currentstock ?? 0;

            // Build alternative unit stocks
            $alternativeUnitStocks = [];
            foreach ($product->alternativeUnits as $altUnit) {
                $conversionFactor = $altUnit->pivot->conversion_factor;
                $altStock = $baseStock / $conversionFactor;
                
                $alternativeUnitStocks[] = [
                    'unit_id' => $altUnit->id,
                    'unit_name' => $altUnit->name,
                    'unit_symbol' => $altUnit->symbol,
                    'conversion_factor' => $conversionFactor,
                    'stock' => round($altStock, 4),
                    'is_purchase_unit' => (bool) $altUnit->pivot->is_purchase_unit,
                    'is_sales_unit' => (bool) $altUnit->pivot->is_sales_unit,
                ];
            }

            return response()->json([
                'success' => true,
                'data' => [
                    'id' => $product->id,
                    'name' => $product->name,
                    'code' => $product->code,
                    'base_unit' => [
                        'id' => $product->baseUnit->id,
                        'name' => $product->baseUnit->name,
                        'symbol' => $product->baseUnit->symbol,
                    ],
                    'current_stock' => [
                        'base_unit' => round($baseStock, 4),
                        'base_unit_symbol' => $product->baseUnit->symbol,
                        'alternative_units' => $alternativeUnitStocks,
                    ],
                    'purchase_price' => $product->purchase_price,
                    'selling_price' => $product->selling_price,
                ],
            ]);
        } catch (\Exception $e) {
            Log::error('Get product details error: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error fetching product details',
            ], 500);
        }
    }
/**
     * Calculate quantity in base unit from alternative unit
     * Used when receiving purchase orders or creating invoices
     */
    public function convertToBaseUnit(Request $request)
    {
        try {
            $validated = $request->validate([
                'product_id' => 'required|exists:products,id',
                'quantity' => 'required|numeric|min:0.001',
                'unit_id' => 'required|exists:units,id',
            ]);

            $product = Product::with('alternativeUnits', 'baseUnit')
                ->findOrFail($validated['product_id']);

            // If unit is the base unit
            if ($validated['unit_id'] == $product->base_unit_id) {
                return response()->json([
                    'success' => true,
                    'quantity_in_base_unit' => $validated['quantity'],
                    'base_unit_symbol' => $product->baseUnit->symbol,
                ]);
            }

            // Find conversion factor for alternative unit
            $altUnit = $product->alternativeUnits()
                ->where('unit_id', $validated['unit_id'])
                ->first();

            if (!$altUnit) {
                return response()->json([
                    'success' => false,
                    'message' => 'Unit not configured for this product',
                ], 422);
            }

            $conversionFactor = $altUnit->pivot->conversion_factor;
            $quantityInBase = $validated['quantity'] * $conversionFactor;

            return response()->json([
                'success' => true,
                'quantity_in_base_unit' => round($quantityInBase, 4),
                'base_unit_symbol' => $product->baseUnit->symbol,
                'conversion_factor' => $conversionFactor,
            ]);
        } catch (\Exception $e) {
            Log::error('Convert to base unit error: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error converting quantity',
            ], 500);
        }
    }
/**
     * Get DataTables data for products with stock in alternative units
     */
    public function getProductsWithAlternativeStock(Request $request)
    {
        try {
            $products = Product::with([
                'productGroup',
                'baseUnit',
                'alternativeUnits',
                'inventoryAccount'
            ])->get();

            // Transform data to include alternative unit stocks
            $transformedProducts = $products->map(function ($product) {
                $baseStock = $product->currentstock ?? 0;
                
                // Prepare alternative unit display
                $altUnitDisplay = '';
                foreach ($product->alternativeUnits as $altUnit) {
                    if ($altUnit->pivot->is_sales_unit) {
                        $conversionFactor = $altUnit->pivot->conversion_factor;
                        $altStock = $baseStock / $conversionFactor;
                        $altUnitDisplay .= round($altStock, 2) . ' ' . $altUnit->symbol . ' | ';
                    }
                }
                $altUnitDisplay = rtrim($altUnitDisplay, ' | ');

                return [
                    'id' => $product->id,
                    'name' => $product->name,
                    'code' => $product->code,
                    'group_name' => $product->productGroup ? $product->productGroup->fullpath : 'No Group',
                    'base_unit' => $product->baseUnit->symbol,
                    'current_stock' => round($baseStock, 4),
                    'alternative_units_display' => $altUnitDisplay ?: 'N/A',
                    'is_active' => $product->is_active,
                ];
            });

            return DataTables::of($transformedProducts)
                ->addIndexColumn()
                ->rawColumns(['alternative_units_display'])
                ->make(true);
        } catch (\Exception $e) {
            Log::error('Get products with alternative stock error: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error fetching product data',
            ], 500);
        }
    }
 /**
     * Record product movement with alternative unit support
     * Call this when stock is updated (purchase, sale, adjustment)
     */
    private function recordProductMovement(
        $productId,
        $movementType,
        $quantityInBaseUnit,
        $rate = null,
        $referenceType = null,
        $referenceId = null,
        $notes = null,
        $unitId = null
    ) {
        try {
            $product = Product::findOrFail($productId);
            $stockBefore = $product->currentstock ?? 0;

            // Update product stock
            if ($movementType == 'purchase' || $movementType == 'opening_stock') {
                $newStock = $stockBefore + $quantityInBaseUnit;
            } else if ($movementType == 'sale' || $movementType == 'return') {
                $newStock = $stockBefore - $quantityInBaseUnit;
            } else if ($movementType == 'adjustment') {
                $newStock = $quantityInBaseUnit; // Direct set for adjustments
            }

            $newStock = max(0, $newStock); // Prevent negative stock

            // If unit was provided and it's not the base unit, get the conversion factor
            $conversionNote = '';
            if ($unitId && $unitId != $product->base_unit_id) {
                $altUnit = $product->alternativeUnits()
                    ->where('unit_id', $unitId)
                    ->first();
                
                if ($altUnit) {
                    $conversionFactor = $altUnit->pivot->conversion_factor;
                    $quantityInAltUnit = $quantityInBaseUnit / $conversionFactor;
                    $conversionNote = " ({$quantityInAltUnit} {$altUnit->symbol})";
                }
            }

            // Create movement record
            ProductMovement::create([
                'product_id' => $productId,
                'type' => $movementType,
                'reference_type' => $referenceType,
                'reference_id' => $referenceId,
                'quantity' => $quantityInBaseUnit,
                'rate' => $rate,
                'stock_before' => $stockBefore,
                'stock_after' => $newStock,
                'movement_date' => now(),
                'notes' => ($notes ?? '') . $conversionNote,
                'created_by' => auth()->id(),
            ]);

            // Update product stock
            $product->update(['currentstock' => $newStock]);

            return true;
        } catch (\Exception $e) {
            Log::error('Record product movement error: ' . $e->getMessage());
            throw $e;
        }
    }

 /**
     * Get stock status with alternative units
     * Useful for dashboard/reports showing stock in different units
     */
    public function getStockStatus(Request $request)
    {
        try {
            $productId = $request->get('product_id');
            $product = Product::with([
                'baseUnit',
                'alternativeUnits',
                'inventoryAccount'
            ])->findOrFail($productId);

            $baseStock = $product->currentstock ?? 0;
            $value = $baseStock * ($product->purchase_price ?? 0);

            // Get minimum/reorder/maximum in base units
            $stockLevels = [
                'minimum' => $product->minimum_stock,
                'reorder' => $product->reorder_level,
                'maximum' => $product->maximum_stock,
                'status' => 'normal',
            ];

            if ($baseStock < $stockLevels['minimum']) {
                $stockLevels['status'] = 'critical';
            } else if ($baseStock < $stockLevels['reorder']) {
                $stockLevels['status'] = 'low';
            } else if ($baseStock > $stockLevels['maximum']) {
                $stockLevels['status'] = 'overstock';
            }

            // Build alternative unit representation
            $alternativeUnits = [];
            foreach ($product->alternativeUnits as $altUnit) {
                $conversionFactor = $altUnit->pivot->conversion_factor;
                $altStock = $baseStock / $conversionFactor;
                
                $alternativeUnits[] = [
                    'unit_name' => $altUnit->name,
                    'unit_symbol' => $altUnit->symbol,
                    'stock' => round($altStock, 4),
                    'is_purchase_unit' => (bool) $altUnit->pivot->is_purchase_unit,
                    'is_sales_unit' => (bool) $altUnit->pivot->is_sales_unit,
                ];
            }

            return response()->json([
                'success' => true,
                'data' => [
                    'product_name' => $product->name,
                    'base_unit' => [
                        'symbol' => $product->baseUnit->symbol,
                        'stock' => round($baseStock, 4),
                    ],
                    'alternative_units' => $alternativeUnits,
                    'stock_value' => round($value, 2),
                    'stock_levels' => $stockLevels,
                    'inventory_account' => $product->inventoryAccount ? [
                        'code' => $product->inventoryAccount->code,
                        'name' => $product->inventoryAccount->name,
                    ] : null,
                ],
            ]);
        } catch (\Exception $e) {
            Log::error('Get stock status error: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Error fetching stock status',
            ], 500);
        }
    }
}


================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\ProductGroupController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\ProductGroup;
use Illuminate\Http\Request;
use Illuminate\Validation\Rule;

class ProductGroupController extends Controller
{
    /**
     * Display tree view of product groups
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            // Return jsTree formatted data
            return response()->json($this->buildTree());
        }
        
        return view('product-groups.index');
    }

    /**
     * Build tree structure for jsTree
     */
    private function buildTree($parentId = null)
    {
        $groups = ProductGroup::where('parent_id', $parentId)
                             ->orderBy('name')
                             ->get();
        
        $tree = [];
        
        foreach ($groups as $group) {
            $children = $this->buildTree($group->id);
            
            $node = [
                'id' => $group->id,
                'text' => $group->name . 
                         ($group->description ? ' <small class="text-muted">(' . $group->description . ')</small>' : ''),
                'icon' => 'fas fa-folder text-warning',
                'state' => [
                    'opened' => false,
                    'disabled' => !$group->is_active
                ],
                'a_attr' => [
                    'data-id' => $group->id,
                    'data-active' => $group->is_active
                ]
            ];
            
            if (count($children) > 0) {
                $node['children'] = $children;
            }
            
            $tree[] = $node;
        }
        
        return $tree;
    }

    /**
     * Store a newly created product group
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:100|unique:product_groups,name',
            'parent_id' => 'nullable|exists:product_groups,id',
            'description' => 'nullable|string|max:500',
            'is_active' => 'nullable|boolean',
        ]);

        $validated['is_active'] = $request->has('is_active') ? 1 : 0;

        $group = ProductGroup::create($validated);

        return response()->json([
            'success' => true,
            'message' => 'Product group created successfully!',
            'data' => $group,
        ]);
    }

    /**
     * Show the form for creating a new product group
     */
    public function create()
    {
        $parentGroups = ProductGroup::active()->orderBy('name')->get();
        return view('product-groups.create', compact('parentGroups'));
    }

    /**
     * Show the form for editing the specified product group
     */
    public function edit(ProductGroup $productGroup)
    {
        $parentGroups = ProductGroup::active()
                                    ->where('id', '!=', $productGroup->id)
                                    ->orderBy('name')
                                    ->get();
        
        return view('product-groups.edit', compact('productGroup', 'parentGroups'));
    }

    /**
     * Update the specified product group
     */
    public function update(Request $request, ProductGroup $productGroup)
    {
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'max:100',
                Rule::unique('product_groups', 'name')->ignore($productGroup->id),
            ],
            'parent_id' => [
                'nullable',
                'exists:product_groups,id',
                Rule::notIn([$productGroup->id]),
            ],
            'description' => 'nullable|string|max:500',
            'is_active' => 'nullable|boolean',
        ]);

        $validated['is_active'] = $request->has('is_active') ? 1 : 0;

        $productGroup->update($validated);

        return response()->json([
            'success' => true,
            'message' => 'Product group updated successfully!',
            'data' => $productGroup,
        ]);
    }

    /**
     * Remove the specified product group
     */
    public function destroy(ProductGroup $productGroup)
    {
        if (!$productGroup->canBeDeleted()) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete group. It has sub-groups or products.',
            ], 422);
        }

        $productGroup->delete();

        return response()->json([
            'success' => true,
            'message' => 'Product group deleted successfully!',
        ]);
    }

    /**
     * Get groups for dropdown (AJAX)
     */
    public function getGroups(Request $request)
    {
        $groups = ProductGroup::active()
                             ->orderBy('name')
                             ->get()
                             ->map(function ($group) {
                                 return [
                                     'id' => $group->id,
                                     'text' => $group->full_path,
                                 ];
                             });

        return response()->json($groups);
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\ProfileController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Http\Requests\ProfileUpdateRequest;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Redirect;
use Illuminate\View\View;

class ProfileController extends Controller
{
    /**
     * Display the user's profile form.
     */
    public function edit(Request $request): View
    {
        return view('profile.edit', [
            'user' => $request->user(),
        ]);
    }

    /**
     * Update the user's profile information.
     */
    public function update(ProfileUpdateRequest $request): RedirectResponse
    {
        $request->user()->fill($request->validated());

        if ($request->user()->isDirty('email')) {
            $request->user()->email_verified_at = null;
        }

        $request->user()->save();

        return Redirect::route('profile.edit')->with('status', 'profile-updated');
    }

    /**
     * Delete the user's account.
     */
    public function destroy(Request $request): RedirectResponse
    {
        $request->validateWithBag('userDeletion', [
            'password' => ['required', 'current_password'],
        ]);

        $user = $request->user();

        Auth::logout();

        $user->delete();

        $request->session()->invalidate();
        $request->session()->regenerateToken();

        return Redirect::to('/');
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\PurchaseOrderController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Vendor;
use App\Models\Account;
use App\Models\Product;
use App\Models\Transaction;
use Illuminate\Http\Request;
use App\Models\PurchaseOrder;
use App\Models\ProductMovement;
use App\Models\TransactionEntry;
use Yajra\DataTables\DataTables;
use App\Models\PurchaseOrderItem;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;

class PurchaseOrderController extends Controller
{
public function index(Request $request)
{
    if ($request->ajax()) {
        $query = PurchaseOrder::with('vendor')->select('purchase_orders.*');
        
        // ADD THIS: Filter by status
        if ($request->filled('status')) {
            $query->where('status', $request->status);
        }
        
        return DataTables::of($query)  // Change $data to $query
            ->addIndexColumn()
            ->addColumn('vendor_name', function ($row) {
                return $row->vendor ? $row->vendor->name : '-';
            })
            ->addColumn('order_date_formatted', function ($row) {
                // Fix: Check if it's already a string or convert from Carbon
                if (is_string($row->order_date)) {
                    return \Carbon\Carbon::parse($row->order_date)->format('d M Y');
                }
                return $row->order_date ? $row->order_date->format('d M Y') : '-';
            })
            ->addColumn('status_badge', function ($row) {
                if ($row->status === 'received') {
                    return '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Received</span>';
                }
                return '<span class="badge badge-warning"><i class="fas fa-clock"></i> Pending</span>';
            })
            ->addColumn('amount_formatted', function ($row) {
                return ' ' . number_format($row->total_amount, 2);
            })
            ->addColumn('action', function ($row) {
                $viewBtn = '<a href="' . route('purchase-orders.show', $row->id) . '" class="btn btn-info btn-sm" title="View"><i class="fas fa-eye"></i></a>';
                $editBtn = '';
                $receiveBtn = '';
                $deleteBtn = '';
                
                // Only show edit and delete for pending orders
                if ($row->status === 'pending') {
                    $editBtn = '<a href="' . route('purchase-orders.edit', $row->id) . '" class="btn btn-primary btn-sm" title="Edit"><i class="fas fa-edit"></i></a>';
                    $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-btn" data-id="' . $row->id . '" title="Delete"><i class="fas fa-trash"></i></button>';
                    
                    // Safe vendor name retrieval
                    $vendorName = $row->vendor ? e($row->vendor->name) : 'N/A';
                    
                    // Add "Mark as Received" button
                    $receiveBtn = '<button type="button" class="btn btn-success btn-sm receive-btn" data-id="' . $row->id . '" data-vendor="' . $vendorName . '" data-amount="' . number_format($row->total_amount, 2) . '" title="Mark as Received"><i class="fas fa-check-circle"></i> Receive</button>';
                }
                
                return '<div class="btn-group">' . $viewBtn . ' ' . $receiveBtn . ' ' . $editBtn . ' ' . $deleteBtn . '</div>';
            })
            ->rawColumns(['status_badge', 'action'])
            ->make(true);
    }

    return view('purchase_orders.index');
}



 public function create(Request $request)
    {
        $vendors = Vendor::where('is_active', true)->orderBy('name')->get();
        $products = Product::where('is_active', true)->orderBy('name')->get();
        
        // Get expense accounts for purchase account selection
        $purchaseAccounts = Account::where('type', 'expense')
            ->where('is_active', true)
            ->orderBy('code')
            ->get();
        
        // Get default purchase account (code 5100 or first expense account)
        $defaultPurchaseAccount = Account::where('code', '5100')->first() 
            ?? $purchaseAccounts->first();
        
        return view('purchase_orders.create', compact('vendors', 'products', 'purchaseAccounts', 'defaultPurchaseAccount'));
    }

    // public function store(Request $request)
    // {
    //     $validated = $request->validate([
    //         'vendor_id' => 'required|exists:vendors,id',
    //         'purchase_account_id' => 'required|exists:accounts,id',
    //         'order_date' => 'required|date',
    //         'items.*.product_id' => 'required|exists:products,id',
    //         'items.*.quantity' => 'required|numeric|min:0.001',
    //         'items.*.rate' => 'required|numeric|min:0.01',
    //         'notes' => 'nullable|string',
    //     ]);

    //     DB::beginTransaction();
    //     try {
    //         // Create purchase order
    //         $order = PurchaseOrder::create([
    //             'vendor_id' => $validated['vendor_id'],
    //             'purchase_account_id' => $validated['purchase_account_id'],
    //             'order_number' => 'PO-' . now()->format('Ymd') . '-' . str_pad(PurchaseOrder::count() + 1, 4, '0', STR_PAD_LEFT),
    //             'order_date' => $validated['order_date'],
    //             'status' => 'pending',
    //             'notes' => $validated['notes'] ?? null,
    //             'total_amount' => collect($validated['items'])->sum(function($item) {
    //                 return $item['quantity'] * $item['rate'];
    //             }),
    //         ]);

    //         // Create order items
    //         foreach ($validated['items'] as $item) {
    //             PurchaseOrderItem::create([
    //                 'purchase_order_id' => $order->id,
    //                 'product_id' => $item['product_id'],
    //                 'quantity' => $item['quantity'],
    //                 'rate' => $item['rate'],
    //                 'amount' => $item['quantity'] * $item['rate'],
    //             ]);
    //         }

    //         DB::commit();
    //         return response()->json(['success' => true, 'data' => $order]);
            
    //     } catch (\Exception $e) {
    //         DB::rollBack();
    //         Log::error('Purchase order creation failed: ' . $e->getMessage());
    //         return response()->json(['success' => false, 'message' => $e->getMessage()], 500);
    //     }
    // }


    /**
     * Mark purchase order as received and create accounting entries
     */
public function markAsReceived(PurchaseOrder $order)
    {
        if ($order->status == 'received') {
            return response()->json([
                'success' => false,
                'error' => 'Already marked as received',
            ], 422);
        }

        DB::beginTransaction();
        try {
            // Update order status
            $order->status = 'received';
            $order->received_date = now();
            $order->save();

            // 1. Update stock for all items AND log movements
            foreach ($order->items as $item) {
                $product = $item->product;

                // Get current stock before update (handle null)
                $stockBefore = $product->currentstock ?? 0;

                // Item quantity is stored in base unit already
                // If it was recorded with alternative unit, conversion happened at entry time
                $quantityInBase = $item->quantity;

                // Calculate new stock
                $newStock = $stockBefore + $quantityInBase;

                // Update product stock
                $product->update(['currentstock' => $newStock]);

                // Log the movement with conversion info
                $conversionNote = "Purchase from {$order->vendor->name} - Order #{$order->order_number}";

                ProductMovement::create([
                    'product_id' => $product->id,
                    'type' => 'purchase',
                    'reference_type' => 'PurchaseOrder',
                    'reference_id' => $order->id,
                    'quantity' => $quantityInBase,
                    'rate' => $item->rate,
                    'stock_before' => $stockBefore,
                    'stock_after' => $newStock,
                    'movement_date' => $order->received_date ?? now(),
                    'notes' => $conversionNote,
                    'created_by' => auth()->id(),
                ]);

                Log::info("Stock updated for product {$product->name}", [
                    'before' => $stockBefore,
                    'added' => $quantityInBase,
                    'after' => $newStock,
                ]);
            }

            // 2. Create double-entry accounting transaction
            $vendor = $order->vendor;
            if (!$vendor->ledger_account_id) {
                throw new \Exception('Vendor does not have a ledger account. Please update vendor settings.');
            }

            // Use the selected purchase account from the order
            $purchaseAccount = $order->purchaseAccount;
            if (!$purchaseAccount) {
                throw new \Exception('Purchase account not found for this order.');
            }

            // Create transaction
            $transaction = Transaction::create([
                'date' => $order->received_date ?? now(),
                'type' => 'purchase',
                'reference' => $order->order_number,
                'description' => "Purchase from {$vendor->name} - {$order->order_number}",
                'notes' => $order->notes,
                'status' => 'posted',
            ]);

            // Dr. Purchase Account (Expense increases)
            TransactionEntry::create([
                'transaction_id' => $transaction->id,
                'account_id' => $purchaseAccount->id,
                'amount' => $order->total_amount,
                'type' => 'debit',
                'memo' => "Purchase - {$order->order_number}",
            ]);

            // Cr. Vendor Account (Liability increases - we owe vendor)
            TransactionEntry::create([
                'transaction_id' => $transaction->id,
                'account_id' => $vendor->ledger_account_id,
                'amount' => $order->total_amount,
                'type' => 'credit',
                'memo' => "Payable to {$vendor->name}",
            ]);

            // Link transaction to purchase order
            $order->transaction_id = $transaction->id;
            $order->save();

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Purchase order marked as received successfully! Stock updated and accounting entry created.',
                'data' => $order->fresh('vendor', 'items.product', 'transaction'),
            ]);
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Mark as received failed', [
                'order_id' => $order->id,
                'trace' => $e->getTraceAsString(),
                'error' => $e->getMessage(),
            ]);

            return response()->json([
                'success' => false,
                'error' => $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Store purchase order with alternative unit conversion
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'vendor_id' => 'required|exists:vendors,id',
            'purchase_account_id' => 'required|exists:accounts,id',
            'order_date' => 'required|date',
            'items.*.product_id' => 'required|exists:products,id',
            'items.*.quantity' => 'required|numeric|min:0.001',
            'items.*.rate' => 'required|numeric|min:0.01',
            'items.*.unit_id' => 'nullable|exists:units,id',
            'notes' => 'nullable|string',
        ]);

        DB::beginTransaction();
        try {
            // Process quantities - convert to base unit if alternative unit provided
            $processedItems = [];
            $totalAmount = 0;

            foreach ($validated['items'] as $item) {
                $product = Product::with('alternativeUnits', 'baseUnit')
                    ->findOrFail($item['product_id']);

                $quantityInBase = $item['quantity'];
                $unitId = $item['unit_id'] ?? $product->base_unit_id;

                // If alternative unit provided, convert to base unit
                if ($unitId != $product->base_unit_id) {
                    $altUnit = $product->alternativeUnits()
                        ->where('unit_id', $unitId)
                        ->first();

                    if (!$altUnit) {
                        throw new \Exception("Unit not configured for product {$product->name}");
                    }

                    $conversionFactor = $altUnit->pivot->conversion_factor;
                    $quantityInBase = $item['quantity'] * $conversionFactor;
                }

                $amount = $quantityInBase * $item['rate'];
                $totalAmount += $amount;

                $processedItems[] = [
                    'product_id' => $item['product_id'],
                    'quantity' => $quantityInBase, // Store in base unit
                    'rate' => $item['rate'],
                    'amount' => $amount,
                ];
            }

            // Create purchase order
            $order = PurchaseOrder::create([
                'vendor_id' => $validated['vendor_id'],
                'purchase_account_id' => $validated['purchase_account_id'],
                'order_number' => 'PO-' . now()->format('Ymd') . '-' . str_pad(PurchaseOrder::count() + 1, 4, '0', STR_PAD_LEFT),
                'order_date' => $validated['order_date'],
                'status' => 'pending',
                'notes' => $validated['notes'] ?? null,
                'total_amount' => $totalAmount,
            ]);

            // Create order items
            foreach ($processedItems as $item) {
                $order->items()->create($item);
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'data' => $order,
            ]);
        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Purchase order creation failed: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => $e->getMessage(),
            ], 500);
        }
    }



    public function destroy(PurchaseOrder $purchaseOrder)
    {
        try {
            // Only allow deletion of pending orders
            if ($purchaseOrder->status !== 'pending') {
                return response()->json([
                    'success' => false,
                    'message' => 'Only pending purchase orders can be deleted. This order has already been received.'
                ], 422);
            }

            DB::beginTransaction();
            
            // Delete items first
            $purchaseOrder->items()->delete();
            
            // Delete the order
            $purchaseOrder->delete();
            
            DB::commit();

            return response()->json(['success' => true, 'message' => 'Purchase order deleted successfully.']);
            
        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json(['success' => false, 'message' => 'Error deleting purchase order: ' . $e->getMessage()], 500);
        }
    }

    public function show(PurchaseOrder $purchaseOrder)
    {
        $purchaseOrder->load('vendor', 'items.product');
        return view('purchase_orders.show', compact('purchaseOrder'));
    }

    public function edit(PurchaseOrder $purchaseOrder)
    {
        $purchaseOrder->load('vendor', 'items.product');
        $vendors = Vendor::where('is_active', true)->get();
        $products = Product::where('is_active', true)->get();
        
        return view('purchase_orders.edit', compact('purchaseOrder', 'vendors', 'products'));
    }

    public function update(Request $request, PurchaseOrder $purchaseOrder)
    {
        $validated = $request->validate([
            'vendor_id' => 'required|exists:vendors,id',
            'order_date' => 'required|date',
            'items.*.product_id' => 'required|exists:products,id',
            'items.*.quantity' => 'required|numeric|min:1',
            'items.*.rate' => 'required|numeric|min:0.01',
            'notes' => 'nullable|string',
        ]);

        DB::beginTransaction();
        try {
            // Update purchase order
            $purchaseOrder->update([
                'vendor_id' => $validated['vendor_id'],
                'order_date' => $validated['order_date'],
                'notes' => $validated['notes'] ?? null,
                'total_amount' => collect($validated['items'])->sum(function($item) {
                    return $item['quantity'] * $item['rate'];
                }),
            ]);

            // Delete old items
            $purchaseOrder->items()->delete();

            // Create new items
            foreach ($validated['items'] as $item) {
                PurchaseOrderItem::create([
                    'purchase_order_id' => $purchaseOrder->id,
                    'product_id' => $item['product_id'],
                    'quantity' => $item['quantity'],
                    'rate' => $item['rate'],
                    'amount' => $item['quantity'] * $item['rate'],
                ]);
            }

            DB::commit();
            return response()->json(['success' => true, 'data' => $purchaseOrder]);
            
        } catch (\Exception $e) {
            DB::rollBack();
            return response()->json(['success' => false, 'error' => $e->getMessage()], 500);
        }
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\ReceiptVoucherController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\ReceiptVoucher;
use App\Models\Customer;
use App\Models\Account;
use App\Models\Transaction;
use App\Models\TransactionEntry;
use App\Models\CustomerLedgerTransaction;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Yajra\DataTables\Facades\DataTables;

class ReceiptVoucherController extends Controller
{
    /**
     * Display a listing of receipt vouchers with server-side DataTables
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $query = ReceiptVoucher::with('customer', 'receivedInAccount', 'customerAccount')
                ->select('receipt_vouchers.*');

            // Filter by date range
            if ($request->filled('start_date')) {
                $query->whereDate('receipt_date', '>=', $request->start_date);
            }
            if ($request->filled('end_date')) {
                $query->whereDate('receipt_date', '<=', $request->end_date);
            }

            // Filter by status
            if ($request->filled('status')) {
                $query->where('status', $request->status);
            }

            // Filter by payment method
            if ($request->filled('payment_method')) {
                $query->where('payment_method', $request->payment_method);
            }

            // Filter by customer
            if ($request->filled('customer_id')) {
                $query->where('customer_id', $request->customer_id);
            }

            return DataTables::eloquent($query)
                ->addIndexColumn()
                ->addColumn('voucher_number', function ($row) {
                    return '<a href="' . route('vouchers.receipt.show', $row->id) . '"><strong>' . $row->voucher_number . '</strong></a>';
                })
                ->addColumn('receipt_date', function ($row) {
                    return $row->receipt_date->format('d M Y');
                })
                ->addColumn('customer', function ($row) {
                    if ($row->customer) {
                        return '<span class="badge badge-info">' . $row->customer->customer_code . '</span><br>' .
                               '<small>' . $row->customer->name . '</small>';
                    }
                    return '<span class="badge badge-secondary">N/A</span>';
                })
                ->addColumn('received_in', function ($row) {
                    return '<span class="badge badge-success">' . $row->receivedInAccount->name . '</span>';
                })
                ->addColumn('amount', function ($row) {
                    return '<strong>' . number_format($row->amount, 2) . '</strong>';
                })
                ->addColumn('payment_method', function ($row) {
                    $badges = [
                        'cash' => 'badge-success',
                        'bank' => 'badge-primary',
                        'cheque' => 'badge-info',
                        'mobile_banking' => 'badge-warning',
                    ];
                    $badge = $badges[$row->payment_method] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . ucfirst(str_replace('_', ' ', $row->payment_method)) . '</span>';
                })
                ->addColumn('status', function ($row) {
                    $badges = [
                        'draft' => 'badge-secondary',
                        'posted' => 'badge-success',
                        'cancelled' => 'badge-danger',
                    ];
                    $badge = $badges[$row->status] ?? 'badge-secondary';
                    return '<span class="badge ' . $badge . '">' . ucfirst($row->status) . '</span>';
                })
                ->addColumn('action', function ($row) {
                    $viewBtn = '<a href="' . route('vouchers.receipt.show', $row->id) . '" class="btn btn-info btn-sm" title="View"><i class="fas fa-eye"></i></a>';
                    
                    $editBtn = '';
                    if ($row->canEdit()) {
                        $editBtn = '<a href="' . route('vouchers.receipt.edit', $row->id) . '" class="btn btn-primary btn-sm" title="Edit"><i class="fas fa-edit"></i></a>';
                    }
                    
                    $cancelBtn = '';
                    if ($row->canCancel()) {
                        $cancelBtn = '<button type="button" class="btn btn-warning btn-sm cancel-btn" data-id="' . $row->id . '" title="Cancel"><i class="fas fa-ban"></i></button>';
                    }
                    
                    $deleteBtn = '';
                    if ($row->status === 'draft') {
                        $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-btn" data-id="' . $row->id . '" title="Delete"><i class="fas fa-trash"></i></button>';
                    }
                    
                    return '<div class="btn-group">' . $viewBtn . ' ' . $editBtn . ' ' . $cancelBtn . ' ' . $deleteBtn . '</div>';
                })
                ->rawColumns(['voucher_number', 'customer', 'received_in', 'amount', 'payment_method', 'status', 'action'])
                ->make(true);
        }

        // Get customers for filter dropdown
        $customers = Customer::where('is_active', true)->orderBy('name')->get();

        return view('vouchers.receipt.index', compact('customers'));
    }

    /**
     * Show the form for creating a new receipt voucher
     */
public function create(Request $request)
{
    // Get accounts for receiving payment (Cash, Bank accounts)
    $receiptAccounts = Account::where('is_active', true)
        ->whereIn('type', ['asset'])
        ->where(function($query) {
            $query->where('name', 'LIKE', '%Cash%')
                  ->orWhere('name', 'LIKE', '%Bank%')
                  ->orWhere('code', 'LIKE', '1%');
        })
        ->orderBy('name')
        ->get();

    // Pre-fill from request parameters
    $preselectedCustomer = null;
    if ($request->filled('customer_id')) {
        $preselectedCustomer = Customer::with('ledgerAccount', 'group')->find($request->customer_id);
    }

    // Generate voucher number
    $voucherNumber = ReceiptVoucher::generateVoucherNumber();

    return view('vouchers.receipt.create', compact(
        'receiptAccounts',
        'preselectedCustomer',
        'voucherNumber'
    ));
}

    /**
     * Store a newly created receipt voucher in storage
     */
public function store(Request $request)
{
    $validated = $request->validate([
        'receipt_date' => 'required|date',
        'payment_method' => 'required|in:cash,bank,cheque,mobile_banking',
        'amount' => 'required|numeric|min:0.01',
        'customer_id' => 'required|exists:customers,id',
        'received_in_account_id' => 'required|exists:accounts,id',
        'cheque_number' => 'nullable|string|max:100',
        'cheque_date' => 'nullable|date',
        'bank_name' => 'nullable|string|max:255',
        'description' => 'required|string|max:500',
        'notes' => 'nullable|string',
        'status' => 'required|in:draft,posted',
    ]);

    DB::beginTransaction();

    try {
        // Get customer and their ledger account
        $customer = Customer::with('ledgerAccount')->findOrFail($validated['customer_id']);

        if (!$customer->ledger_account_id) {
            throw new \Exception('Customer does not have a ledger account.');
        }

        // Generate voucher number
        $voucherNumber = ReceiptVoucher::generateVoucherNumber();

        // Create transaction for double-entry
        $transaction = Transaction::create([
            'date' => $validated['receipt_date'],
            'type' => 'receipt',
            'reference' => $voucherNumber,
            'description' => $validated['description'],
            'notes' => $validated['notes'] ?? null,
            'status' => $validated['status'],
        ]);

        // Create transaction entries (double-entry bookkeeping)
        // 1. Debit: Received In Account (Cash/Bank increases)
        TransactionEntry::create([
            'transaction_id' => $transaction->id,
            'account_id' => $validated['received_in_account_id'],
            'type' => 'debit',
            'amount' => $validated['amount'],
            'memo' => 'Receipt from ' . $customer->name,
        ]);

        // 2. Credit: Customer Account (Reduces receivable/outstanding)
        TransactionEntry::create([
            'transaction_id' => $transaction->id,
            'account_id' => $customer->ledger_account_id,
            'type' => 'credit',
            'amount' => $validated['amount'],
            'memo' => 'Payment received - ' . $validated['description'],
        ]);

        // Create receipt voucher
        $receiptVoucher = ReceiptVoucher::create([
            'voucher_number' => $voucherNumber,
            'receipt_date' => $validated['receipt_date'],
            'payment_method' => $validated['payment_method'],
            'amount' => $validated['amount'],
            'customer_id' => $validated['customer_id'],
            'received_in_account_id' => $validated['received_in_account_id'],
            'customer_account_id' => $customer->ledger_account_id,
            'transaction_id' => $transaction->id,
            'cheque_number' => $validated['cheque_number'] ?? null,
            'cheque_date' => $validated['cheque_date'] ?? null,
            'bank_name' => $validated['bank_name'] ?? null,
            'description' => $validated['description'],
            'notes' => $validated['notes'] ?? null,
            'status' => $validated['status'],
        ]);

        //  ADD THIS: Manually sync to customer ledger AFTER entries are created
        if ($transaction->status === 'posted') {
            \App\Observers\TransactionObserver::syncToCustomerLedger($transaction);
        }

        DB::commit();

        if ($request->ajax()) {
            return response()->json([
                'success' => true,
                'message' => 'Receipt voucher created successfully!',
                'data' => $receiptVoucher->load('customer', 'receivedInAccount', 'customerAccount', 'transaction'),
            ]);
        }

        return redirect()
            ->route('vouchers.receipt.show', $receiptVoucher->id)
            ->with('success', 'Receipt voucher created successfully!');

    } catch (\Exception $e) {
        DB::rollBack();
        
        Log::error('Receipt voucher creation error: ' . $e->getMessage());

        if ($request->ajax()) {
            return response()->json([
                'success' => false,
                'message' => 'Error creating receipt voucher: ' . $e->getMessage(),
            ], 500);
        }

        return redirect()
            ->back()
            ->withInput()
            ->with('error', 'Error creating receipt voucher: ' . $e->getMessage());
    }
}

    /**
     * Display the specified receipt voucher
     */
    public function show(ReceiptVoucher $receiptVoucher)
    {
        $receiptVoucher->load('customer', 'receivedInAccount', 'customerAccount', 'transaction.entries.account');

        return view('vouchers.receipt.show', compact('receiptVoucher'));
    }

    /**
     * Show the form for editing the specified receipt voucher
     */
    public function edit(ReceiptVoucher $receiptVoucher)
    {
        if (!$receiptVoucher->canEdit()) {
            return redirect()
                ->route('vouchers.receipt.show', $receiptVoucher->id)
                ->with('error', 'Only draft vouchers can be edited.');
        }

        $receiptVoucher->load('customer', 'receivedInAccount', 'customerAccount');

        // Get accounts
        $receiptAccounts = Account::where('is_active', true)
            ->whereIn('type', ['asset'])
            ->where(function($query) {
                $query->where('name', 'LIKE', '%Cash%')
                      ->orWhere('name', 'LIKE', '%Bank%')
                      ->orWhere('code', 'LIKE', '1%');
            })
            ->orderBy('name')
            ->get();

        $customers = Customer::where('is_active', true)
            ->with('ledgerAccount')
            ->orderBy('name')
            ->get();

        return view('vouchers.receipt.edit', compact(
            'receiptVoucher',
            'receiptAccounts',
            'customers'
        ));
    }

    /**
     * Update the specified receipt voucher in storage
     */
    public function update(Request $request, ReceiptVoucher $receiptVoucher)
    {
        if (!$receiptVoucher->canEdit()) {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be edited.',
            ], 422);
        }

        $validated = $request->validate([
            'receipt_date' => 'required|date',
            'payment_method' => 'required|in:cash,bank,cheque,mobile_banking',
            'amount' => 'required|numeric|min:0.01',
            'customer_id' => 'required|exists:customers,id',
            'received_in_account_id' => 'required|exists:accounts,id',
            'cheque_number' => 'nullable|string|max:100',
            'cheque_date' => 'nullable|date',
            'bank_name' => 'nullable|string|max:255',
            'description' => 'required|string|max:500',
            'notes' => 'nullable|string',
            'status' => 'required|in:draft,posted',
        ]);

        DB::beginTransaction();
        try {
            // Get customer and their ledger account
            $customer = Customer::with('ledgerAccount')->findOrFail($validated['customer_id']);
            
            if (!$customer->ledger_account_id) {
                throw new \Exception('Customer does not have a ledger account.');
            }

            // Update transaction
            if ($receiptVoucher->transaction) {
                $receiptVoucher->transaction->update([
                    'date' => $validated['receipt_date'],
                    'description' => $validated['description'],
                    'notes' => $validated['notes'] ?? null,
                    'status' => $validated['status'],
                ]);

                // Delete old entries
                $receiptVoucher->transaction->entries()->delete();

                // Create new transaction entries
                TransactionEntry::create([
                    'transaction_id' => $receiptVoucher->transaction->id,
                    'account_id' => $validated['received_in_account_id'],
                    'type' => 'debit',
                    'amount' => $validated['amount'],
                    'memo' => 'Receipt from ' . $customer->name,
                ]);

                TransactionEntry::create([
                    'transaction_id' => $receiptVoucher->transaction->id,
                    'account_id' => $customer->ledger_account_id,
                    'type' => 'credit',
                    'amount' => $validated['amount'],
                    'memo' => 'Payment received - ' . $validated['description'],
                ]);
            }

            // Update receipt voucher
            $receiptVoucher->update([
                'receipt_date' => $validated['receipt_date'],
                'payment_method' => $validated['payment_method'],
                'amount' => $validated['amount'],
                'customer_id' => $validated['customer_id'],
                'received_in_account_id' => $validated['received_in_account_id'],
                'customer_account_id' => $customer->ledger_account_id,
                'cheque_number' => $validated['cheque_number'] ?? null,
                'cheque_date' => $validated['cheque_date'] ?? null,
                'bank_name' => $validated['bank_name'] ?? null,
                'description' => $validated['description'],
                'notes' => $validated['notes'] ?? null,
                'status' => $validated['status'],
            ]);

            DB::commit();

            if ($request->ajax()) {
                return response()->json([
                    'success' => true,
                    'message' => 'Receipt voucher updated successfully!',
                    'data' => $receiptVoucher->load('customer', 'receivedInAccount', 'customerAccount', 'transaction'),
                ]);
            }

            return redirect()
                ->route('vouchers.receipt.show', $receiptVoucher->id)
                ->with('success', 'Receipt voucher updated successfully!');

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Receipt voucher update error: ' . $e->getMessage());

            if ($request->ajax()) {
                return response()->json([
                    'success' => false,
                    'message' => 'Error updating receipt voucher: ' . $e->getMessage(),
                ], 500);
            }

            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error updating receipt voucher: ' . $e->getMessage());
        }
    }

    /**
     * Remove the specified receipt voucher from storage
     */
    public function destroy(ReceiptVoucher $receiptVoucher)
    {
        if ($receiptVoucher->status !== 'draft') {
            return response()->json([
                'success' => false,
                'message' => 'Only draft vouchers can be deleted.',
            ], 422);
        }

        try {
            DB::beginTransaction();

            // Delete transaction entries
            if ($receiptVoucher->transaction) {
                $receiptVoucher->transaction->entries()->delete();
                $receiptVoucher->transaction->delete();
            }

            // Delete receipt voucher
            $receiptVoucher->delete();

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Receipt voucher deleted successfully!',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Receipt voucher deletion error: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Error deleting receipt voucher: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Cancel a posted receipt voucher
     */
    public function cancel(ReceiptVoucher $receiptVoucher)
    {
        if (!$receiptVoucher->canCancel()) {
            return response()->json([
                'success' => false,
                'message' => 'Only posted vouchers can be cancelled.',
            ], 422);
        }

        try {
            DB::beginTransaction();

            // Update voucher status
            $receiptVoucher->update(['status' => 'cancelled']);

            // Void the transaction
            if ($receiptVoucher->transaction) {
                $receiptVoucher->transaction->update(['status' => 'voided']);
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Receipt voucher cancelled successfully!',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Receipt voucher cancellation error: ' . $e->getMessage());

            return response()->json([
                'success' => false,
                'message' => 'Error cancelling receipt voucher: ' . $e->getMessage(),
            ], 500);
        }
    }
/**
 * Search customers via AJAX for Select2 (by name, code, or phone)
 */
public function searchCustomers(Request $request)
{
    $search = $request->get('q', '');
    $page = $request->get('page', 1);
    $perPage = 20;

    $query = Customer::where('is_active', true)
        ->with('ledgerAccount', 'group');

    // Search by name, customer code, OR phone number
    if (!empty($search)) {
        $query->where(function($q) use ($search) {
            $q->where('name', 'LIKE', "%{$search}%")
              ->orWhere('customer_code', 'LIKE', "%{$search}%")
              ->orWhere('phone', 'LIKE', "%{$search}%");
        });
    }

    $total = $query->count();
    
    $customers = $query->orderBy('name')
        ->skip(($page - 1) * $perPage)
        ->take($perPage)
        ->get();

    // Format for Select2
    $results = $customers->map(function($customer) {
        // Calculate current balance
        $currentBalance = $customer->transactions()->sum(DB::raw('debit - credit'));
        $openingBalance = $customer->opening_balance_type === 'debit' 
            ? $customer->opening_balance 
            : -$customer->opening_balance;
        $totalBalance = $openingBalance + $currentBalance;
        $balanceFormatted = number_format(abs($totalBalance), 2);
        $balanceLabel = $totalBalance >= 0 ? 'Dr' : 'Cr';

        return [
            'id' => $customer->id,
            'text' => $customer->customer_code . ' - ' . $customer->name . ' | ' . $customer->phone,
            'customer_code' => $customer->customer_code,
            'name' => $customer->name,
            'phone' => $customer->phone,
            'ledger_account_id' => $customer->ledger_account_id,
            'balance' => $balanceFormatted . ' ' . $balanceLabel,
        ];
    });

    return response()->json([
        'results' => $results,
        'pagination' => [
            'more' => ($page * $perPage) < $total
        ]
    ]);
}

    /**
     * Get customer details via AJAX for fast searching
     */
    public function getCustomerDetails(Customer $customer)
    {
        try {
            $customer->load('ledgerAccount', 'group');

            // Calculate current balance
            $currentBalance = $customer->transactions()->sum(DB::raw('debit - credit'));
            $openingBalance = $customer->opening_balance_type === 'debit' 
                ? $customer->opening_balance 
                : -$customer->opening_balance;
            $totalBalance = $openingBalance + $currentBalance;

            // Get recent outstanding invoices
            $outstandingInvoices = CustomerLedgerTransaction::where('customer_id', $customer->id)
                ->where('voucher_type', 'Sales Invoice')
                ->where('balance', '>', 0)
                ->orderBy('transaction_date', 'desc')
                ->limit(5)
                ->get()
                ->map(function ($invoice) {
                    return [
                        'voucher_number' => $invoice->voucher_number,
                        'date' => $invoice->transaction_date->format('d M Y'),
                        'amount' => number_format($invoice->debit, 2),
                        'balance' => number_format($invoice->balance, 2),
                        'due_date' => $invoice->due_date ? $invoice->due_date->format('d M Y') : 'N/A',
                        'is_overdue' => $invoice->due_date && $invoice->due_date->isPast(),
                    ];
                });

            return response()->json([
                'success' => true,
                'data' => [
                    'customer_code' => $customer->customer_code,
                    'name' => $customer->name,
                    'phone' => $customer->phone,
                    'email' => $customer->email,
                    'address' => $customer->address,
                    'city' => $customer->city,
                    'group' => $customer->group ? $customer->group->name : 'N/A',
                    'ledger_account_id' => $customer->ledger_account_id,
                    'ledger_account_name' => $customer->ledgerAccount->name ?? 'N/A',
                    'current_balance' => $totalBalance,
                    'current_balance_formatted' => number_format(abs($totalBalance), 2),
                    'balance_type' => $totalBalance >= 0 ? 'Dr (Receivable)' : 'Cr (Advance)',
                    'balance_class' => $totalBalance >= 0 ? 'text-danger' : 'text-success',
                    'credit_limit' => number_format($customer->credit_limit, 2),
                    'credit_period_days' => $customer->credit_period_days,
                    'current_due_date' => $customer->current_due_date ? $customer->current_due_date->format('d M Y') : 'N/A',
                    'is_overdue' => $customer->current_due_date && $customer->current_due_date->isPast() && $totalBalance > 0,
                    'outstanding_invoices' => $outstandingInvoices,
                ],
            ]);

        } catch (\Exception $e) {
            return response()->json([
                'success' => false,
                'message' => 'Error fetching customer details: ' . $e->getMessage(),
            ], 500);
        }
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\ReportController.php
================================================================================

<?php

namespace App\Http\Controllers;

use Carbon\Carbon;
use App\Models\Vendor;
use App\Models\Account;
use App\Models\Product;
use App\Models\Transaction;
use Illuminate\Http\Request;
use App\Models\PurchaseOrder;
use Illuminate\Support\Facades\DB;
use Yajra\DataTables\Facades\DataTables;

class ReportController extends Controller
{
    // ==================== TRIAL BALANCE REPORT ====================
    
    /**
     * Display Trial Balance Report
     */
    public function trialBalance(Request $request)
    {
        $asOfDate = $request->input('as_of_date', now()->toDateString());
        $accountType = $request->input('account_type', 'all');
        $showZeroBalance = $request->boolean('show_zero_balance', false);
        
        // Get account types for filter
        $accountTypes = [
            'all' => 'All Accounts',
            'asset' => 'Assets',
            'liability' => 'Liabilities',
            'equity' => 'Equity',
            'income' => 'Income',
            'expense' => 'Expenses',
        ];
        
        // AJAX request for data refresh
        if ($request->ajax()) {
            $accounts = $this->getTrialBalanceData($asOfDate, $accountType, $showZeroBalance);
            
            return response()->json([
                'accounts' => $accounts,
                'totalDebit' => number_format($accounts->sum('debit_balance'), 2),
                'totalCredit' => number_format($accounts->sum('credit_balance'), 2),
                'difference' => number_format(abs($accounts->sum('debit_balance') - $accounts->sum('credit_balance')), 2),
                'isBalanced' => abs($accounts->sum('debit_balance') - $accounts->sum('credit_balance')) < 0.01,
            ]);
        }
        
        return view('reports.trial-balance', compact('asOfDate', 'accountType', 'showZeroBalance', 'accountTypes'));
    }
    
    /**
     * Get trial balance data
     */
    private function getTrialBalanceData($asOfDate, $accountType = 'all', $showZeroBalance = false)
    {
        $query = Account::where('is_active', true)
            ->with(['transactionEntries' => function($query) use ($asOfDate) {
                $query->whereHas('transaction', function($q) use ($asOfDate) {
                    $q->where('date', '<=', $asOfDate)
                      ->where('status', 'posted');
                });
            }]);
        
        // Filter by account type
        if ($accountType !== 'all') {
            $query->where('type', $accountType);
        }
        
        $accounts = $query->get()->map(function($account) {
            $debits = $account->transactionEntries->where('type', 'debit')->sum('amount');
            $credits = $account->transactionEntries->where('type', 'credit')->sum('amount');
            
            // Calculate balance based on account type
            if (in_array($account->type, ['asset', 'expense'])) {
                // Normal debit balance accounts
                $netBalance = $debits - $credits;
                $debitBalance = $netBalance > 0 ? $netBalance : 0;
                $creditBalance = $netBalance < 0 ? abs($netBalance) : 0;
            } else {
                // Normal credit balance accounts (liability, equity, income)
                $netBalance = $credits - $debits;
                $creditBalance = $netBalance > 0 ? $netBalance : 0;
                $debitBalance = $netBalance < 0 ? abs($netBalance) : 0;
            }
            
            return [
                'id' => $account->id,
                'code' => $account->code,
                'name' => $account->name,
                'type' => $account->type,
                'debit_total' => $debits,
                'credit_total' => $credits,
                'debit_balance' => round($debitBalance, 2),
                'credit_balance' => round($creditBalance, 2),
            ];
        });
        
        // Filter out zero balances if requested
        if (!$showZeroBalance) {
            $accounts = $accounts->filter(function($account) {
                return $account['debit_balance'] != 0 || $account['credit_balance'] != 0;
            });
        }
        
        return $accounts->sortBy('code')->values();
    }
    
    /**
     * Export Trial Balance to CSV
     */
    public function trialBalanceCsv(Request $request)
    {
        $asOfDate = $request->input('as_of_date', now()->toDateString());
        $accountType = $request->input('account_type', 'all');
        $accounts = $this->getTrialBalanceData($asOfDate, $accountType, true);
        
        $filename = 'trial-balance-' . $asOfDate . '.csv';
        
        return $this->generateCsvResponse($filename, function($file) use ($accounts, $asOfDate) {
            // Header
            fputcsv($file, ['TRIAL BALANCE REPORT']);
            fputcsv($file, ['As of: ' . Carbon::parse($asOfDate)->format('d M Y')]);
            fputcsv($file, ['Generated: ' . now()->format('d M Y h:i A')]);
            fputcsv($file, []); // Empty row
            
            // Column headers
            fputcsv($file, ['Account Code', 'Account Name', 'Type', 'Debit Balance', 'Credit Balance']);
            
            // Data rows
            $totalDebit = 0;
            $totalCredit = 0;
            
            foreach ($accounts as $account) {
                fputcsv($file, [
                    $account['code'],
                    $account['name'],
                    ucfirst($account['type']),
                    number_format($account['debit_balance'], 2),
                    number_format($account['credit_balance'], 2),
                ]);
                
                $totalDebit += $account['debit_balance'];
                $totalCredit += $account['credit_balance'];
            }
            
            // Total row
            fputcsv($file, []);
            fputcsv($file, ['', 'TOTAL:', '', number_format($totalDebit, 2), number_format($totalCredit, 2)]);
            fputcsv($file, ['', 'DIFFERENCE:', '', '', number_format(abs($totalDebit - $totalCredit), 2)]);
        });
    }
    
    /**
     * Print Trial Balance
     */
    public function trialBalancePrint(Request $request)
    {
        $asOfDate = $request->input('as_of_date', now()->toDateString());
        $accountType = $request->input('account_type', 'all');
        $accounts = $this->getTrialBalanceData($asOfDate, $accountType, false);
        
        $totals = [
            'debit' => $accounts->sum('debit_balance'),
            'credit' => $accounts->sum('credit_balance'),
            'difference' => abs($accounts->sum('debit_balance') - $accounts->sum('credit_balance')),
        ];
        
        return view('reports.trial-balance-print', compact('accounts', 'asOfDate', 'totals'));
    }
    
    // ==================== PURCHASE REGISTER REPORT ====================
    
    /**
     * Display Purchase Register Report
     */
    public function purchaseRegister(Request $request)
    {
        if ($request->ajax()) {
            $query = PurchaseOrder::with(['vendor', 'items.product'])
                ->select('purchase_orders.*');
            
            // Apply filters
            if ($request->filled('start_date')) {
                $query->whereDate('order_date', '>=', $request->start_date);
            }
            
            if ($request->filled('end_date')) {
                $query->whereDate('order_date', '<=', $request->end_date);
            }
            
            if ($request->filled('vendor_id')) {
                $query->where('vendor_id', $request->vendor_id);
            }
            
            if ($request->filled('status')) {
                $query->where('status', $request->status);
            }
            
            if ($request->filled('product_id')) {
                $query->whereHas('items', function($q) use ($request) {
                    $q->where('product_id', $request->product_id);
                });
            }
            
            return DataTables::eloquent($query)
                ->addIndexColumn()
                ->addColumn('order_number', function ($row) {
                    return '<a href="' . route('purchase-orders.show', $row->id) . '" class="text-primary">' .
                           '<strong>' . $row->order_number . '</strong></a>';
                })
                ->addColumn('order_date_formatted', function ($row) {
                    return Carbon::parse($row->order_date)->format('d M Y');
                })
                ->addColumn('vendor_name', function ($row) {
                    return $row->vendor ? $row->vendor->name : '-';
                })
                ->addColumn('items_count', function ($row) {
                    return '<span class="badge badge-info">' . $row->items->count() . ' items</span>';
                })
                ->addColumn('total_quantity', function ($row) {
                    return '<strong>' . number_format($row->items->sum('quantity'), 2) . '</strong>';
                })
                ->addColumn('total_amount_formatted', function ($row) {
                    return '<strong class="text-success"> ' . number_format($row->total_amount, 2) . '</strong>';
                })
                ->addColumn('status_badge', function ($row) {
                    if ($row->status === 'received') {
                        $date = $row->received_date ? '<br><small>' . Carbon::parse($row->received_date)->format('d M Y') . '</small>' : '';
                        return '<span class="badge badge-success"><i class="fas fa-check-circle"></i> Received</span>' . $date;
                    }
                    return '<span class="badge badge-warning"><i class="fas fa-clock"></i> Pending</span>';
                })
                ->addColumn('action', function ($row) {
                    return '<a href="' . route('purchase-orders.show', $row->id) . '" class="btn btn-info btn-sm">' .
                           '<i class="fas fa-eye"></i></a>';
                })
                ->rawColumns(['order_number', 'items_count', 'total_quantity', 'total_amount_formatted', 'status_badge', 'action'])
                ->make(true);
        }
        
        $vendors = Vendor::where('is_active', true)->orderBy('name')->get();
        $products = Product::where('is_active', true)->orderBy('name')->get();
        
        return view('reports.purchase-register', compact('vendors', 'products'));
    }
    
    /**
     * Export Purchase Register to CSV
     */
    public function purchaseRegisterCsv(Request $request)
    {
        $query = PurchaseOrder::with(['vendor', 'items.product']);
        
        // Apply same filters
        if ($request->filled('start_date')) {
            $query->whereDate('order_date', '>=', $request->start_date);
        }
        if ($request->filled('end_date')) {
            $query->whereDate('order_date', '<=', $request->end_date);
        }
        if ($request->filled('vendor_id')) {
            $query->where('vendor_id', $request->vendor_id);
        }
        if ($request->filled('status')) {
            $query->where('status', $request->status);
        }
        
        $orders = $query->orderBy('order_date', 'desc')->get();
        
        $filename = 'purchase-register-' . now()->format('Y-m-d') . '.csv';
        
        return $this->generateCsvResponse($filename, function($file) use ($orders, $request) {
            // Header
            fputcsv($file, ['PURCHASE REGISTER REPORT']);
            fputcsv($file, ['Period: ' . ($request->start_date ?? 'All') . ' to ' . ($request->end_date ?? 'All')]);
            fputcsv($file, ['Generated: ' . now()->format('d M Y h:i A')]);
            fputcsv($file, []);
            
            // Column headers
            fputcsv($file, [
                'Order Number', 'Order Date', 'Vendor Name', 'Items Count', 
                'Total Quantity', 'Total Amount', 'Status', 'Received Date'
            ]);
            
            // Data rows
            $totalAmount = 0;
            
            foreach ($orders as $order) {
                fputcsv($file, [
                    $order->order_number,
                    Carbon::parse($order->order_date)->format('d M Y'),
                    $order->vendor ? $order->vendor->name : '-',
                    $order->items->count(),
                    number_format($order->items->sum('quantity'), 2),
                    number_format($order->total_amount, 2),
                    ucfirst($order->status),
                    $order->received_date ? Carbon::parse($order->received_date)->format('d M Y') : '-',
                ]);
                
                $totalAmount += $order->total_amount;
            }
            
            // Total row
            fputcsv($file, []);
            fputcsv($file, ['', '', '', '', 'TOTAL:', number_format($totalAmount, 2), '', '']);
        });
    }
    
    // ==================== VENDOR-WISE PURCHASE REPORT ====================
    
    /**
     * Display Vendor-wise Purchase Report
     */
    public function vendorWisePurchase(Request $request)
    {
        if ($request->ajax()) {
            $query = Vendor::with(['purchaseOrders' => function($q) use ($request) {
                if ($request->filled('start_date')) {
                    $q->whereDate('order_date', '>=', $request->start_date);
                }
                if ($request->filled('end_date')) {
                    $q->whereDate('order_date', '<=', $request->end_date);
                }
                if ($request->filled('status')) {
                    $q->where('status', $request->status);
                }
            }])
            ->withCount(['purchaseOrders as total_orders' => function($q) use ($request) {
                if ($request->filled('start_date')) {
                    $q->whereDate('order_date', '>=', $request->start_date);
                }
                if ($request->filled('end_date')) {
                    $q->whereDate('order_date', '<=', $request->end_date);
                }
                if ($request->filled('status')) {
                    $q->where('status', $request->status);
                }
            }])
            ->withSum(['purchaseOrders as total_amount' => function($q) use ($request) {
                if ($request->filled('start_date')) {
                    $q->whereDate('order_date', '>=', $request->start_date);
                }
                if ($request->filled('end_date')) {
                    $q->whereDate('order_date', '<=', $request->end_date);
                }
                if ($request->filled('status')) {
                    $q->where('status', $request->status);
                }
            }], 'total_amount');
            
            // Filter by vendor
            if ($request->filled('vendor_id')) {
                $query->where('id', $request->vendor_id);
            }
            
            // Only show vendors with purchase orders
            $query->has('purchaseOrders');
            
            return DataTables::of($query)
                ->addIndexColumn()
                ->addColumn('vendor_name', function ($row) {
                    $phone = $row->phone ? '<br><small class="text-muted">' . $row->phone . '</small>' : '';
                    return '<strong>' . $row->name . '</strong>' . $phone;
                })
                ->addColumn('total_orders', function ($row) {
                    return '<span class="badge badge-primary">' . $row->total_orders . '</span>';
                })
                ->addColumn('total_amount_formatted', function ($row) {
                    return '<strong class="text-success"> ' . number_format($row->total_amount ?? 0, 2) . '</strong>';
                })
                ->addColumn('action', function ($row) {
                    return '<a href="' . route('vendors.show', $row->id) . '" class="btn btn-info btn-sm">' .
                           '<i class="fas fa-eye"></i></a>';
                })
                ->rawColumns(['vendor_name', 'total_orders', 'total_amount_formatted', 'action'])
                ->make(true);
        }
        
        $vendors = Vendor::where('is_active', true)->orderBy('name')->get();
        
        return view('reports.vendor-wise-purchase', compact('vendors'));
    }
    
    // ==================== PAYABLES REPORT ====================
    
    /**
     * Display Payables Report
     */
    public function payables(Request $request)
    {
        $liabilityAccounts = Account::where('type', 'liability')
            ->where('is_active', true)
            ->orderBy('code')
            ->get();
        
        $vendors = Vendor::where('is_active', true)
            ->whereNotNull('ledger_account_id')
            ->orderBy('name')
            ->get();
        
        $startDate = $request->input('start_date', now()->startOfMonth()->toDateString());
        $endDate = $request->input('end_date', now()->toDateString());
        
        return view('reports.payables', compact('liabilityAccounts', 'vendors', 'startDate', 'endDate'));
    }
    
    /**
     * Get Payables Data for DataTables
     */
    public function getPayablesData(Request $request)
    {
        $startDate = $request->input('start_date');
        $endDate = $request->input('end_date');
        $accountId = $request->input('account_id');
        $vendorId = $request->input('vendor_id');
        $showZeroBalance = $request->boolean('show_zero_balance', false);
        
        $query = Account::where('type', 'liability')
            ->where('is_active', true)
            ->with(['parentAccount', 'transactionEntries' => function($q) use ($startDate, $endDate) {
                $q->whereHas('transaction', function($query) use ($startDate, $endDate) {
                    $query->where('status', 'posted');
                    
                    if ($startDate) {
                        $query->whereDate('date', '>=', $startDate);
                    }
                    if ($endDate) {
                        $query->whereDate('date', '<=', $endDate);
                    }
                });
            }])
            ->select('accounts.*');
        
        // Apply filters
        if ($accountId) {
            $query->where('id', $accountId);
        }
        
        if ($vendorId) {
            $vendor = Vendor::find($vendorId);
            if ($vendor && $vendor->ledger_account_id) {
                $query->where('id', $vendor->ledger_account_id);
            }
        }
        
        return DataTables::eloquent($query)
            ->addIndexColumn()
            ->addColumn('account_code', function($account) {
                return '<span class="badge badge-primary">' . e($account->code) . '</span>';
            })
            ->addColumn('account_name', function($account) {
                $html = '<strong>' . e($account->name) . '</strong>';
                if ($account->parentAccount) {
                    $html .= '<br><small class="text-muted">Parent: ' . e($account->parentAccount->name) . '</small>';
                }
                return $html;
            })
            ->addColumn('opening_balance', function($account) {
                $openingBalance = $account->opening_balance ?? 0;
                $class = $openingBalance > 0 ? 'text-success' : ($openingBalance < 0 ? 'text-danger' : 'text-muted');
                return '<span class="' . $class . '"> ' . number_format(abs($openingBalance), 2) . '</span>';
            })
            ->addColumn('total_debits', function($account) {
                $debits = $account->transactionEntries->where('type', 'debit')->sum('amount');
                return '<span class="text-danger"> ' . number_format($debits, 2) . '</span>';
            })
            ->addColumn('total_credits', function($account) {
                $credits = $account->transactionEntries->where('type', 'credit')->sum('amount');
                return '<span class="text-success"> ' . number_format($credits, 2) . '</span>';
            })
            ->addColumn('current_balance', function($account) {
                $openingBalance = $account->opening_balance ?? 0;
                $debits = $account->transactionEntries->where('type', 'debit')->sum('amount');
                $credits = $account->transactionEntries->where('type', 'credit')->sum('amount');
                
                // For liability: Credit increases, Debit decreases
                $currentBalance = $openingBalance + $credits - $debits;
                
                $class = $currentBalance > 0 ? 'text-danger font-weight-bold' : ($currentBalance < 0 ? 'text-success' : 'text-muted');
                $label = $currentBalance > 0 ? ' (Payable)' : ($currentBalance < 0 ? ' (Advance)' : '');
                
                return '<span class="' . $class . '"> ' . number_format(abs($currentBalance), 2) . $label . '</span>';
            })
            ->addColumn('transaction_count', function($account) {
                $count = $account->transactionEntries->count();
                return '<span class="badge badge-info">' . $count . ' transactions</span>';
            })
            ->addColumn('vendor_info', function($account) {
                $vendor = Vendor::where('ledger_account_id', $account->id)->first();
                
                if ($vendor) {
                    return '<span class="badge badge-warning">' . e($vendor->name) . '</span><br>' .
                           '<small class="text-muted">' . e($vendor->phone ?? 'No phone') . '</small>';
                }
                
                return '<span class="text-muted">-</span>';
            })
            ->addColumn('actions', function($account) {
                $detailsBtn = '<button type="button" class="btn btn-info btn-sm view-details" ' .
                             'data-account-id="' . $account->id . '" ' .
                             'data-account-name="' . e($account->name) . '" ' .
                             'title="View Transactions">' .
                             '<i class="fas fa-eye"></i></button>';
                
                $vendor = Vendor::where('ledger_account_id', $account->id)->first();
                
                $paymentBtn = '<a href="' . route('vouchers.payment.create', [
                    'vendor_id' => $vendor->id ?? null,
                    'paid_to_account_id' => $account->id
                ]) . '" class="btn btn-success btn-sm" title="Make Payment">' .
                '<i class="fas fa-money-bill-wave"></i></a>';
                
                $ledgerBtn = '<a href="' . route('accounts.show', $account->id) . '" ' .
                            'class="btn btn-primary btn-sm" title="View Ledger" target="_blank">' .
                            '<i class="fas fa-book"></i></a>';
                
                return '<div class="btn-group">' . $detailsBtn . ' ' . $paymentBtn . ' ' . $ledgerBtn . '</div>';
            })
            ->filterColumn('account_name', function($query, $keyword) {
                $query->where('name', 'like', "%{$keyword}%")
                      ->orWhere('code', 'like', "%{$keyword}%");
            })
            ->rawColumns(['account_code', 'account_name', 'opening_balance', 'total_debits', 
                         'total_credits', 'current_balance', 'transaction_count', 'vendor_info', 'actions'])
            ->make(true);
    }
    
    /**
     * Get detailed transactions for a payable account
     */
    public function getPayableTransactions(Request $request, Account $account)
    {
        if ($account->type !== 'liability') {
            return response()->json([
                'success' => false,
                'message' => 'This account is not a liability account.'
            ], 400);
        }
        
        $startDate = $request->input('start_date');
        $endDate = $request->input('end_date');
        
        $query = DB::table('transaction_entries as te')
            ->join('transactions as t', 'te.transaction_id', '=', 't.id')
            ->where('te.account_id', $account->id)
            ->where('t.status', 'posted')
            ->whereNull('t.deleted_at')
            ->whereNull('te.deleted_at')
            ->select(
                't.id as transaction_id',
                't.date',
                't.reference',
                't.description',
                't.type as transaction_type',
                'te.type as entry_type',
                'te.amount',
                'te.memo'
            )
            ->orderBy('t.date', 'desc');
        
        if ($startDate) {
            $query->whereDate('t.date', '>=', $startDate);
        }
        if ($endDate) {
            $query->whereDate('t.date', '<=', $endDate);
        }
        
        return DataTables::of($query)
            ->editColumn('date', function($entry) {
                return Carbon::parse($entry->date)->format('d M Y');
            })
            ->addColumn('reference_link', function($entry) {
                return '<a href="' . route('transactions.show', $entry->transaction_id) . '" target="_blank">' .
                       '<strong>' . e($entry->reference ?? 'TXN-' . $entry->transaction_id) . '</strong></a>';
            })
            ->addColumn('debit', function($entry) {
                if ($entry->entry_type === 'debit') {
                    return '<span class="text-danger font-weight-bold"> ' . number_format($entry->amount, 2) . '</span>';
                }
                return '<span class="text-muted">-</span>';
            })
            ->addColumn('credit', function($entry) {
                if ($entry->entry_type === 'credit') {
                    return '<span class="text-success font-weight-bold"> ' . number_format($entry->amount, 2) . '</span>';
                }
                return '<span class="text-muted">-</span>';
            })
            ->addColumn('transaction_type_badge', function($entry) {
                $badges = [
                    'payment' => 'badge-success',
                    'receipt' => 'badge-info',
                    'purchase' => 'badge-warning',
                    'journal' => 'badge-primary',
                ];
                $badge = $badges[$entry->transaction_type] ?? 'badge-secondary';
                return '<span class="badge ' . $badge . '">' . ucfirst(str_replace('_', ' ', $entry->transaction_type)) . '</span>';
            })
            ->addColumn('description_full', function($entry) {
                $html = '<strong>' . e($entry->description) . '</strong>';
                if ($entry->memo) {
                    $html .= '<br><small class="text-muted">' . e($entry->memo) . '</small>';
                }
                return $html;
            })
            ->rawColumns(['reference_link', 'debit', 'credit', 'transaction_type_badge', 'description_full'])
            ->make(true);
    }
    
    /**
     * Export Payables Report to CSV
     */
    public function payablesCsv(Request $request)
    {
        $startDate = $request->input('start_date', now()->startOfMonth()->toDateString());
        $endDate = $request->input('end_date', now()->toDateString());
        $accountId = $request->input('account_id');
        $vendorId = $request->input('vendor_id');
        
        $accounts = $this->getPayablesReportData($startDate, $endDate, $accountId, $vendorId);
        
        $filename = 'payables-report-' . $startDate . '-to-' . $endDate . '.csv';
        
        return $this->generateCsvResponse($filename, function($file) use ($accounts, $startDate, $endDate) {
            // Header
            fputcsv($file, ['PAYABLES REPORT']);
            fputcsv($file, ['Period: ' . Carbon::parse($startDate)->format('d M Y') . ' to ' . Carbon::parse($endDate)->format('d M Y')]);
            fputcsv($file, ['Generated: ' . now()->format('d M Y h:i A')]);
            fputcsv($file, []);
            
            // Column headers
            fputcsv($file, [
                'Account Code',
                'Account Name',
                'Opening Balance',
                'Total Debits',
                'Total Credits',
                'Current Balance',
                'Balance Type',
                'Vendor Name',
                'Transaction Count'
            ]);
            
            // Data rows
            $totalDebits = 0;
            $totalCredits = 0;
            $totalBalance = 0;
            
            foreach ($accounts as $item) {
                $account = $item['account'];
                $vendor = $item['vendor'];
                
                fputcsv($file, [
                    $account->code,
                    $account->name,
                    number_format($item['opening_balance'], 2),
                    number_format($item['total_debits'], 2),
                    number_format($item['total_credits'], 2),
                    number_format(abs($item['current_balance']), 2),
                    $item['current_balance'] > 0 ? 'Payable' : ($item['current_balance'] < 0 ? 'Advance' : 'Zero'),
                    $vendor ? $vendor->name : '-',
                    $account->transactionEntries->count()
                ]);
                
                $totalDebits += $item['total_debits'];
                $totalCredits += $item['total_credits'];
                $totalBalance += $item['current_balance'];
            }
            
            // Total row
            fputcsv($file, []);
            fputcsv($file, [
                '',
                'TOTAL:',
                '',
                number_format($totalDebits, 2),
                number_format($totalCredits, 2),
                number_format(abs($totalBalance), 2),
                $totalBalance > 0 ? 'Payable' : 'Advance',
                '',
                ''
            ]);
        });
    }
    
    /**
     * Print view for Payables Report
     */
    public function payablesPrint(Request $request)
    {
        $startDate = $request->input('start_date', now()->startOfMonth()->toDateString());
        $endDate = $request->input('end_date', now()->toDateString());
        $accountId = $request->input('account_id');
        $vendorId = $request->input('vendor_id');
        
        $accounts = $this->getPayablesReportData($startDate, $endDate, $accountId, $vendorId);
        
        $totals = [
            'opening_balance' => $accounts->sum('opening_balance'),
            'total_debits' => $accounts->sum('total_debits'),
            'total_credits' => $accounts->sum('total_credits'),
            'current_balance' => $accounts->sum('current_balance'),
            'total_payable' => $accounts->where('current_balance', '>', 0)->sum('current_balance'),
            'total_advance' => abs($accounts->where('current_balance', '<', 0)->sum('current_balance')),
        ];
        
        return view('reports.payables-print', compact('accounts', 'startDate', 'endDate', 'totals'));
    }
    
    /**
     * Helper: Get payables report data
     */
    private function getPayablesReportData($startDate, $endDate, $accountId = null, $vendorId = null)
    {
        $query = Account::where('type', 'liability')
            ->where('is_active', true)
            ->with(['parentAccount', 'transactionEntries' => function($q) use ($startDate, $endDate) {
                $q->whereHas('transaction', function($query) use ($startDate, $endDate) {
                    $query->where('status', 'posted')
                          ->whereDate('date', '>=', $startDate)
                          ->whereDate('date', '<=', $endDate);
                });
            }]);
        
        if ($accountId) {
            $query->where('id', $accountId);
        }
        
        if ($vendorId) {
            $vendor = Vendor::find($vendorId);
            if ($vendor && $vendor->ledger_account_id) {
                $query->where('id', $vendor->ledger_account_id);
            }
        }
        
        return $query->orderBy('code')
            ->get()
            ->map(function($account) {
                $openingBalance = $account->opening_balance ?? 0;
                $debits = $account->transactionEntries->where('type', 'debit')->sum('amount');
                $credits = $account->transactionEntries->where('type', 'credit')->sum('amount');
                $currentBalance = $openingBalance + $credits - $debits;
                
                return [
                    'account' => $account,
                    'opening_balance' => $openingBalance,
                    'total_debits' => $debits,
                    'total_credits' => $credits,
                    'current_balance' => $currentBalance,
                    'vendor' => Vendor::where('ledger_account_id', $account->id)->first()
                ];
            });
    }
    
    // ==================== HELPER METHODS ====================
    
    /**
     * Generate CSV Response with UTF-8 BOM
     */
    private function generateCsvResponse($filename, $callback)
    {
        $headers = [
            'Content-Type' => 'text/csv',
            'Content-Disposition' => 'attachment; filename="' . $filename . '"',
            'Cache-Control' => 'no-cache, no-store, must-revalidate',
            'Pragma' => 'no-cache',
            'Expires' => '0',
        ];
        
        return response()->stream(function() use ($callback) {
            $file = fopen('php://output', 'w');
            
            // Add UTF-8 BOM for proper Excel opening
            fprintf($file, chr(0xEF).chr(0xBB).chr(0xBF));
            
            // Execute callback to write data
            $callback($file);
            
            fclose($file);
        }, 200, $headers);
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\SalesController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Invoice;
use App\Models\InvoiceItem;
use App\Models\InvoicePayment;
use App\Models\Customer;
use App\Models\Product;
use App\Models\Unit;
use App\Models\Account;
use App\Services\Sales\InvoiceService;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Yajra\DataTables\Facades\DataTables;

class SalesController extends Controller
{
    protected $invoiceService;

    public function __construct(InvoiceService $invoiceService)
    {
        $this->invoiceService = $invoiceService;
    }

    // ===== VIEW METHODS =====
    public function index(Request $request)
    {
        if ($request->ajax()) {
            return $this->getInvoicesDataTable($request);
        }

        return view('sales.index');
    }

    public function create()
    {
        $salesAccounts = Account::where('type', 'income')
            ->where('is_active', true)
            ->orderBy('code')
            ->get();

        $products = Product::active()
            ->select('id', 'name', 'code', 'base_unit_id', 'selling_price', 'current_stock')
            ->with('baseUnit')
            ->limit(50)
            ->get();

        return view('sales.create', compact('salesAccounts', 'products'));
    }

    public function show(Invoice $invoice)
    {
        $invoice->load(['customer', 'items.product', 'items.unit', 'deliveries', 'payments']);
        return view('sales.show', compact('invoice'));
    }
 /**
     * Update invoice (NEW - for edit functionality)
     */
    public function update(Request $request, Invoice $invoice)
    {
        $validated = $request->validate([
            'customer_id'                 => 'required|exists:customers,id',
            'invoice_date'                => 'required|date',
            'due_date'                    => 'nullable|date',
            'sales_account_id'            => 'nullable|exists:accounts,id',
            'items'                       => 'required|array|min:1',
            'items.*.product_id'          => 'required_if:items.*.item_type,product|exists:products,id',
            'items.*.quantity'            => 'required|numeric|min:0.01',
            'items.*.unit_id'             => 'nullable|exists:units,id', // Always defaults to base unit in service
            'items.*.unit_price'          => 'required|numeric|min:0',
            'items.*.discount_percent'    => 'nullable|numeric|min:0|max:100',
            'internal_notes'              => 'nullable|string',
            'customer_notes'              => 'nullable|string',
        ]);

        try {
            // TODO: Implement update logic via InvoiceService (void old transaction, create new)
            // For Phase 3, just redirect to show
            return redirect()->route('sales.show', $invoice)
                ->with('success', 'Invoice updated successfully!');
        } catch (\Exception $e) {
            Log::error('Invoice update error: ' . $e->getMessage());
            return back()->withInput()->with('error', 'Failed to update invoice');
        }
    }

    /**
     * Edit invoice form (NEW)
     */
    public function edit(Invoice $invoice)
    {
        $salesAccounts = Account::where('type', 'income')
            ->where('is_active', true)
            ->orderBy('code')
            ->get();

        $products = Product::active()
            ->select('id', 'name', 'code', 'base_unit_id', 'selling_price', 'current_stock')
            ->with('baseUnit')
            ->limit(50)
            ->get();

        return view('sales.edit', compact('invoice', 'salesAccounts', 'products'));
    }
    // ===== AJAX ENDPOINTS =====

    /**
     * Search customers with pagination
     * Returns: name, phone, customer_code, outstanding_balance
     */
/**
 * Search customers for Select2 AJAX
 */
public function searchCustomers(Request $request)
{
    try {
        $search = $request->get('q', '');
        $page = $request->get('page', 1);
        $perPage = 10;

        $query = Customer::where('is_active', true);

        if ($search) {
            $query->where(function ($q) use ($search) {
                $q->where('name', 'LIKE', "%{$search}%")
                    ->orWhere('customer_code', 'LIKE', "%{$search}%")
                    ->orWhere('phone', 'LIKE', "%{$search}%");
            });
        }

        $total = $query->count();
        $customers = $query->orderBy('name')
            ->skip(($page - 1) * $perPage)
            ->take($perPage)
            ->get();

        $results = $customers->map(function ($customer) {
            return [
                'id' => $customer->id,
                'text' => "{$customer->customer_code} - {$customer->name}",
                'customercode' => $customer->customer_code,
                'name' => $customer->name,
                'phone' => $customer->phone,
            ];
        });

        // FIXED: Proper response structure
        return response()->json([
            'results' => $results->values()->all(),  // Convert to array
            'pagination' => [
                'more' => ($page * $perPage) < $total,
            ],
        ]);
    } catch (\Exception $e) {
        Log::error('Search customers error: ' . $e->getMessage());
        return response()->json([
            'results' => [],
            'pagination' => ['more' => false]
        ]);
    }
}


public function searchProducts(Request $request)
{
    try {
        $search = $request->get('q', '');

        $query = Product::where('is_active', true)
            ->with('baseUnit', 'alternativeUnits');

        if ($search) {
            $query->where(function ($q) use ($search) {
                $q->where('name', 'LIKE', "%{$search}%")
                    ->orWhere('code', 'LIKE', "%{$search}%");
            });
        }

        $products = $query->orderBy('name')
            ->limit(20)
            ->get();

        $results = $products->map(function ($product) {
            // FIX: Check both column names
            $stock = $product->current_stock ?? $product->currentstock ?? 0;
            
            return [
                'id' => $product->id,
                'text' => $product->name . ($product->code ? ' (' . $product->code . ')' : ''),
                'data' => [  //  SIMPLIFIED: no HTML in data
                    'id' => $product->id,
                    'name' => $product->name,
                    'code' => $product->code ?? '',
                    'stock' => $stock,
                    'unit' => $product->baseUnit->symbol ?? 'pc',
                    'price' => $product->selling_price ?? 0,
                ],
            ];
        });

        return response()->json([
            'results' => $results->values()->all(),
            'pagination' => [
                'more' => false
            ],
        ]);
    } catch (\Exception $e) {
        Log::error('Search products error: ' . $e->getMessage());
        return response()->json([
            'results' => [],
            'pagination' => ['more' => false]
        ]);
    }
}






    /**
     * Quick add customer
     */
    public function quickAddCustomer(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:200',
            'phone' => 'required|string|max:20',
            'address' => 'nullable|string|max:500',
            'city' => 'nullable|string|max:100',
        ]);

        try {
            // Get or create ledger account
            $accountName = "AR - {$validated['name']}";
            $arAccount = Account::where('name', $accountName)->first();
            
            if (!$arAccount) {
                $arAccount = Account::create([
                    'code' => 'AR-CUST-' . str_pad(Customer::count() + 1, 4, '0', STR_PAD_LEFT),
                    'name' => $accountName,
                    'type' => 'asset',
                    'description' => "Accounts Receivable for {$validated['name']}",
                    'is_active' => true,
                ]);
            }

            $customer = Customer::create([
                'customer_code' => Customer::generateCustomerCode(),
                'name' => $validated['name'],
                'phone' => $validated['phone'],
                'address' => $validated['address'] ?? '',
                'city' => $validated['city'] ?? '',
                'ledger_account_id' => $arAccount->id,
                'is_active' => true,
            ]);

            return response()->json([
                'success' => true,
                'customer' => $customer->getCustomerInfo(),
            ]);

        } catch (\Exception $e) {
            Log::error('Quick add customer error: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to create customer: ' . $e->getMessage(),
            ], 422);
        }
    }

    /**
     * Get invoices data table
     */
    private function getInvoicesDataTable(Request $request)
    {
        $query = Invoice::with('customer')
            ->select('invoices.*');

        // Filters
        $deliveryStatus = $request->get('delivery_status');
        $showDeleted = $request->get('show_deleted', 'no') === 'yes';

        if ($deliveryStatus) {
            $query->where('delivery_status', $deliveryStatus);
        }

        if ($showDeleted) {
            $query->onlyTrashed();
        } else {
            $query->whereNull('deleted_at');
        }

        return DataTables::eloquent($query)
            ->addColumn('invoice_number', function($invoice) {
                return $invoice->invoice_number;
            })
            ->addColumn('customer_name', function($invoice) {
                return $invoice->customer->name ?? '-';
            })
            ->addColumn('invoice_date', function($invoice) {
                return $invoice->invoice_date->format('d M Y');
            })
            ->addColumn('total_amount', function($invoice) {
                return ' ' . number_format($invoice->total_amount, 2);
            })
            ->addColumn('total_paid', function($invoice) {
                return ' ' . number_format($invoice->total_paid, 2);
            })
            ->addColumn('outstanding', function($invoice) {
                $outstanding = $invoice->outstanding_balance;
                $class = $outstanding > 0 ? 'text-danger' : 'text-success';
                return '<span class="' . $class . '"> ' . number_format(abs($outstanding), 2) . '</span>';
            })
            ->addColumn('delivery_badge', function($invoice) {
                $badges = [
                    'pending' => '<span class="badge badge-warning">Pending</span>',
                    'partial' => '<span class="badge badge-info">Partial</span>',
                    'delivered' => '<span class="badge badge-success">Delivered</span>',
                ];
                return $badges[$invoice->delivery_status] ?? '-';
            })
            ->addColumn('actions', function($invoice) {
                $viewBtn = '<a href="' . route('sales.show', $invoice) . '" class="btn btn-info btn-sm" title="View"><i class="fas fa-eye"></i></a>';
                
                if ($invoice->deleted_at) {
                    return '<span class="text-muted">Deleted on ' . $invoice->deleted_at->format('d M Y') . '</span> ' . $viewBtn;
                }

                $editBtn = '<a href="' . route('sales.edit', $invoice) . '" class="btn btn-warning btn-sm" title="Edit"><i class="fas fa-edit"></i></a>';
                $deliveryBtn = '<button class="btn btn-success btn-sm delivery-btn" data-id="' . $invoice->id . '" title="Create Delivery"><i class="fas fa-box"></i></button>';
                $paymentBtn = '<button class="btn btn-primary btn-sm payment-btn" data-id="' . $invoice->id . '" title="Add Payment"><i class="fas fa-money-bill"></i></button>';
                $deleteBtn = '<button class="btn btn-danger btn-sm delete-invoice" data-id="' . $invoice->id . '" title="Delete"><i class="fas fa-trash"></i></button>';

                return $viewBtn . ' ' . $editBtn . ' ' . $deliveryBtn . ' ' . $paymentBtn . ' ' . $deleteBtn;
            })
            ->rawColumns(['outstanding', 'delivery_badge', 'actions'])
            ->make(true);
    }

    // ===== STORE/UPDATE =====
    public function store(Request $request)
    {
        $validated = $request->validate([
            'customer_id' => 'required|exists:customers,id',
            'invoice_date' => 'required|date',
            'due_date' => 'nullable|date',
            'sales_account_id' => 'nullable|exists:accounts,id',
            'items' => 'required|array|min:1',
            'items.*.product_id'          => 'nullable|exists:products,id',
            'items.*.quantity' => 'required|numeric|min:0.01',
            'items.*.unit_id' => 'nullable|exists:units,id',
            'items.*.unit_price' => 'required|numeric|min:0',
            'items.*.discount_percent' => 'nullable|numeric|min:0|max:100',
            'internal_notes' => 'nullable|string',
            'customer_notes' => 'nullable|string',
        ]);

        try {
            $invoice = $this->invoiceService->createInvoice($validated);

             if ($request->ajax() || $request->wantsJson()) {
            return response()->json([
                'success' => true,
                'message' => 'Invoice created successfully!',
                'invoice_id' => $invoice->id,
                'redirect' => route('sales.show', $invoice)
            ]);
        }
            return redirect()
                ->route('sales.show', $invoice)
                ->with('success', 'Invoice created successfully!');
        } catch (\Exception $e) {
            Log::error('Invoice creation error: ' . $e->getMessage());
            return back()
                ->withInput()
                ->with('error', 'Failed to create invoice: ' . $e->getMessage());
        }
    }

    // ===== DELETE =====
    public function destroy(Invoice $invoice)
    {
        try {
            $this->invoiceService->deleteInvoice($invoice, auth()->id());

            return response()->json([
                'success' => true,
                'message' => 'Invoice deleted successfully!',
            ]);
        } catch (\Exception $e) {
            Log::error('Invoice deletion error: ' . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Failed to delete invoice: ' . $e->getMessage(),
            ], 422);
        }
    }

     public function getCustomerDetails($customerId)
    {
       try {
        $customer = Customer::with('ledgerAccount')->findOrFail($customerId);

        // Calculate outstanding balance
        $outstandingBalance = $this->calculateCustomerBalance($customer->id);

        return response()->json([
            'success' => true,
            'data' => [
                'id' => $customer->id,
                'name' => $customer->name,
                'customer_code' => $customer->customer_code,
                'phone' => $customer->phone,
                'city' => $customer->city,
                'outstandingbalance' => round($outstandingBalance, 2),
            ],
        ]);
    } catch (\Exception $e) {
        Log::error('Get customer details error: ' . $e->getMessage());
        return response()->json(['success' => false, 'message' => 'Customer not found'], 404);
    }
}
    private function calculateCustomerBalance($customerId)
    {
        $customer = Customer::findOrFail($customerId);

        if (!$customer->ledger_account_id) {
            return 0;
        }

        $account = Account::find($customer->ledger_account_id);
        if (!$account) {
            return 0;
        }

        // Get total debits (sales/invoices)
        $debits = $account->transactionEntries()
            ->where('type', 'debit')
            ->sum('amount');

        // Get total credits (payments received)
        $credits = $account->transactionEntries()
            ->where('type', 'credit')
            ->sum('amount');

        // Outstanding = Debits - Credits (what customer owes us)
        $outstanding = $debits - $credits;

        // Add opening balance if exists
        if ($customer->opening_balance > 0) {
            if ($customer->opening_balance_type === 'debit') {
                $outstanding += $customer->opening_balance;
            } else {
                $outstanding -= $customer->opening_balance;
            }
        }

        return $outstanding;
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\TransactionController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Account;
use App\Models\Customer;
use App\Models\Transaction;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use App\Http\Requests\StoreTransactionRequest;
use App\Http\Requests\UpdateTransactionRequest;

class TransactionController extends Controller
{
    public function index(Request $request)
    {
        $query = Transaction::with('entries.account');
        
        // Filter by date range
        if ($request->filled('date_from')) {
            $query->where('date', '>=', $request->date_from);
        }
        
        if ($request->filled('date_to')) {
            $query->where('date', '<=', $request->date_to);
        }
        
        // Filter by status
        if ($request->filled('status')) {
            $query->where('status', $request->status);
        }
        
        // Search
        if ($request->filled('search')) {
            $query->where(function($q) use ($request) {
                $q->where('description', 'like', '%' . $request->search . '%')
                  ->orWhere('reference', 'like', '%' . $request->search . '%');
            });
        }
        
        $transactions = $query->latest('date')->paginate(15);
        
        return view('transactions.index', compact('transactions'));
    }

public function create(Request $request)
{
    $accounts = Account::where('is_active', true)
        ->orderBy('code')
        ->get();
    
    $preselectedAccountId = $request->query('account_id'); // Get from URL
    
    return view('transactions.create', compact('accounts', 'preselectedAccountId'));
}


    public function store(StoreTransactionRequest $request)
    {
        DB::beginTransaction();
        
        try {
            // Create transaction
            $transaction = Transaction::create([
                'date' => $request->date,
                'reference' => $request->reference,
                'description' => $request->description,
                'notes' => $request->notes,
                'status' => $request->status ?? 'posted',
            ]);
            
            // Create entries
            foreach ($request->entries as $entry) {
                $transaction->entries()->create([
                    'account_id' => $entry['account_id'],
                    'amount' => $entry['amount'],
                    'type' => $entry['type'],
                    'memo' => $entry['memo'] ?? null,
                ]);
            }
            
            DB::commit();
            
            return redirect()
                ->route('transactions.show', $transaction)
                ->with('success', 'Transaction created successfully.');
                
        } catch (\Exception $e) {
            DB::rollBack();
            
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error creating transaction: ' . $e->getMessage());
        }
    }

    public function show(Transaction $transaction)
    {
        $transaction->load('entries.account');
        
        return view('transactions.show', compact('transaction'));
    }

    public function edit(Transaction $transaction)
    {
        // Only allow editing draft transactions
        if ($transaction->status !== 'draft') {
            return redirect()
                ->route('transactions.show', $transaction)
                ->with('error', 'Only draft transactions can be edited.');
        }
        
        $transaction->load('entries.account');
        
        $accounts = Account::where('is_active', true)
            ->orderBy('code')
            ->get();
        
        return view('transactions.edit', compact('transaction', 'accounts'));
    }

    public function update(UpdateTransactionRequest $request, Transaction $transaction)
    {
        // Only allow updating draft transactions
        if ($transaction->status !== 'draft') {
            return redirect()
                ->route('transactions.show', $transaction)
                ->with('error', 'Only draft transactions can be updated.');
        }
        
        DB::beginTransaction();
        
        try {
            // Update transaction
            $transaction->update([
                'date' => $request->date,
                'reference' => $request->reference,
                'description' => $request->description,
                'notes' => $request->notes,
                'status' => $request->status ?? 'posted',
            ]);
            
            // Delete old entries
            $transaction->entries()->delete();
            
            // Create new entries
            foreach ($request->entries as $entry) {
                $transaction->entries()->create([
                    'account_id' => $entry['account_id'],
                    'amount' => $entry['amount'],
                    'type' => $entry['type'],
                    'memo' => $entry['memo'] ?? null,
                ]);
            }
            
            DB::commit();
            
            return redirect()
                ->route('transactions.show', $transaction)
                ->with('success', 'Transaction updated successfully.');
                
        } catch (\Exception $e) {
            DB::rollBack();
            
            return redirect()
                ->back()
                ->withInput()
                ->with('error', 'Error updating transaction: ' . $e->getMessage());
        }
    }

public function destroy(Transaction $transaction)
{
    try {
        // Delete transaction (will cascade delete all entries)
        $transaction->delete();
        
        return response()->json([
            'success' => true,
            'message' => 'Transaction deleted successfully.'
        ]);
        
    } catch (\Exception $e) {
        return response()->json([
            'success' => false,
            'message' => 'Error deleting transaction: ' . $e->getMessage()
        ], 500);
    }
}
    
    // Additional method to void a transaction
    public function void(Transaction $transaction)
    {
        if ($transaction->status === 'voided') {
            return redirect()
                ->route('transactions.show', $transaction)
                ->with('error', 'Transaction is already voided.');
        }
        
        $transaction->void();
        
        return redirect()
            ->route('transactions.show', $transaction)
            ->with('success', 'Transaction voided successfully.');
    }

    public function createForCustomer(Customer $customer)
{
    $accounts = Account::where('is_active', true)
        ->orderBy('code')
        ->get();
    
    $preselectedAccountId = $customer->ledger_account_id;
    
    return view('transactions.create', compact('accounts', 'preselectedAccountId', 'customer'));
}
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\UnitController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Unit;
use Illuminate\Http\Request;
use Illuminate\Validation\Rule;
use Yajra\DataTables\Facades\DataTables;

class UnitController extends Controller
{
    /**
     * Display a listing of the units.
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $data = Unit::query();
            
            return DataTables::eloquent($data)
                ->addIndexColumn()
                ->addColumn('is_base_unit', function ($row) {
                    return $row->is_base_unit 
                        ? '<span class="badge badge-success">Yes</span>' 
                        : '<span class="badge badge-secondary">No</span>';
                })
                ->addColumn('is_active', function ($row) {
                    return $row->is_active 
                        ? '<span class="badge badge-success">Active</span>' 
                        : '<span class="badge badge-danger">Inactive</span>';
                })
                ->addColumn('action', function ($row) {
                    $editBtn = '<a href="' . route('units.edit', $row->id) . '" class="btn btn-sm btn-primary"><i class="fas fa-edit"></i></a>';
                    $deleteBtn = '<button type="button" class="btn btn-sm btn-danger delete-btn" data-id="' . $row->id . '"><i class="fas fa-trash"></i></button>';
                    
                    return '<div class="btn-group">' . $editBtn . ' ' . $deleteBtn . '</div>';
                })
                ->rawColumns(['is_base_unit', 'is_active', 'action'])
                ->make(true);
        }
        
        return view('units.index');
    }

    /**
     * Show the form for creating a new unit.
     */
    public function create()
    {
        return view('units.create');
    }

    /**
     * Store a newly created unit in storage.
     */
    public function store(Request $request)
    {
        $validated = $request->validate([
            'name' => 'required|string|max:50|unique:units,name',
            'symbol' => 'required|string|max:10|unique:units,symbol',
            'type' => 'required|in:simple,compound',
            'is_base_unit' => 'nullable|boolean',
            'description' => 'nullable|string|max:500',
            'is_active' => 'nullable|boolean',
        ]);

        // Set default values for checkboxes
        $validated['is_base_unit'] = $request->has('is_base_unit') ? 1 : 0;
        $validated['is_active'] = $request->has('is_active') ? 1 : 0;

        Unit::create($validated);

        return redirect()
            ->route('units.index')
            ->with('success', 'Unit created successfully!');
    }

    /**
     * Display the specified unit.
     */
    public function show(Unit $unit)
    {
        return view('units.show', compact('unit'));
    }

    /**
     * Show the form for editing the specified unit.
     */
    public function edit(Unit $unit)
    {
        return view('units.edit', compact('unit'));
    }

    /**
     * Update the specified unit in storage.
     */
    public function update(Request $request, Unit $unit)
    {
        $validated = $request->validate([
            'name' => [
                'required',
                'string',
                'max:50',
                Rule::unique('units', 'name')->ignore($unit->id),
            ],
            'symbol' => [
                'required',
                'string',
                'max:10',
                Rule::unique('units', 'symbol')->ignore($unit->id),
            ],
            'type' => 'required|in:simple,compound',
            'is_base_unit' => 'nullable|boolean',
            'description' => 'nullable|string|max:500',
            'is_active' => 'nullable|boolean',
        ]);

        // Set default values for checkboxes
        $validated['is_base_unit'] = $request->has('is_base_unit') ? 1 : 0;
        $validated['is_active'] = $request->has('is_active') ? 1 : 0;

        $unit->update($validated);

        return redirect()
            ->route('units.index')
            ->with('success', 'Unit updated successfully!');
    }

    /**
     * Remove the specified unit from storage.
     */
    public function destroy(Unit $unit)
    {
        // Check if unit is in use
        if ($unit->isInUse()) {
            return response()->json([
                'success' => false,
                'message' => 'Cannot delete unit. It is being used by products.'
            ], 422);
        }

        $unit->delete();

        return response()->json([
            'success' => true,
            'message' => 'Unit deleted successfully!'
        ]);
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\VendorController.php
================================================================================

<?php

namespace App\Http\Controllers;

use App\Models\Vendor;
use App\Models\Account;
use App\Models\Transaction;
use App\Models\TransactionEntry;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\DB;
use Illuminate\Support\Facades\Log;
use Yajra\DataTables\Facades\DataTables;

class VendorController extends Controller
{
    /**
     * Display a listing of vendors with server-side DataTables
     */
    public function index(Request $request)
    {
        if ($request->ajax()) {
            $query = Vendor::with('ledgerAccount')->select('vendors.*');
            
            return DataTables::eloquent($query)
                ->addIndexColumn()
                ->addColumn('ledger_account', function ($row) {
                    if ($row->ledgerAccount) {
                        return '<a href="' . route('accounts.show', $row->ledger_account_id) . '">' .
                               '<span class="badge badge-info">' . $row->ledgerAccount->name . '</span></a>';
                    }
                    return '<span class="badge badge-secondary">Not Set</span>';
                })
                ->addColumn('opening_balance', function ($row) {
                    if ($row->opening_balance > 0) {
                        $type = ucfirst($row->opening_balance_type);
                        $badge = $row->opening_balance_type === 'credit' ? 'badge-success' : 'badge-warning';
                        return '<span class="badge ' . $badge . '">' . 
                               ' ' . number_format($row->opening_balance, 2) . ' (' . $type . ')' .
                               '</span>';
                    }
                    return '<span class="badge badge-secondary"> 0.00</span>';
                })
                ->addColumn('current_balance', function ($row) {
                    $balance = $this->calculateVendorBalance($row);
                    $badge = $balance > 0 ? 'badge-danger' : 'badge-success';
                    return '<span class="badge ' . $badge . '">' . 
                           ' ' . number_format(abs($balance), 2) .
                           '</span>';
                })
                ->addColumn('action', function ($row) {
    $viewBtn = '<a href="' . route('vendors.show', $row->id) . '" class="btn btn-info btn-sm" title="View">
                    <i class="fas fa-eye"></i>
                </a>';
    
    $paymentBtn = '<a href="' . route('vouchers.payment.create', ['payee_type' => 'vendor', 'vendor_id' => $row->id]) . '" class="btn btn-success btn-sm" title="Make Payment">
                    <i class="fas fa-money-bill-wave"></i>
                </a>';
    
    $editBtn = '<a href="' . route('vendors.edit', $row->id) . '" class="btn btn-primary btn-sm" title="Edit">
                    <i class="fas fa-edit"></i>
                </a>';
    
    $deleteBtn = '<button type="button" class="btn btn-danger btn-sm delete-btn" data-id="' . $row->id . '" title="Delete">
                    <i class="fas fa-trash"></i>
                </button>';
    
    return '<div class="btn-group">' . $viewBtn . ' ' . $paymentBtn . ' ' . $editBtn . ' ' . $deleteBtn . '</div>';
})

                ->rawColumns(['ledger_account', 'opening_balance', 'current_balance', 'action'])
                ->make(true);
        }
        
        return view('vendors.index');
    }

    /**
     * Show the form for creating a new vendor
     */
    public function create()
    {
        return view('vendors.create');
    }

    /**
     * Store a newly created vendor in storage
     */
public function store(Request $request)
{
    $validated = $request->validate([
        'name' => 'required|string|max:255|unique:vendors,name',
        'description' => 'nullable|string',
        'opening_balance' => 'nullable|numeric|min:0',
        'opening_balance_type' => 'required_with:opening_balance|in:debit,credit',
        'opening_balance_date' => 'nullable|date',
        'is_active' => 'nullable|boolean', // Add this
    ]);

    DB::beginTransaction();
    
    try {
        // Create Sundry Creditor ledger account for vendor
        $account = Account::create([
            'name' => $validated['name'],
            'code' => 'VEND-' . strtoupper(substr($validated['name'], 0, 4)) . '-' . rand(1000, 9999),
            'type' => 'liability',
            'description' => 'Vendor Account: ' . $validated['name'],
            'is_active' => true,
            'parent_account_id' => null,
        ]);

        // Create vendor and link to ledger account
        $vendor = Vendor::create([
            'name' => $validated['name'],
            'description' => $validated['description'] ?? null,
            'ledger_account_id' => $account->id,
            'opening_balance' => $validated['opening_balance'] ?? 0,
            'opening_balance_type' => $validated['opening_balance_type'] ?? 'credit',
            'opening_balance_date' => $validated['opening_balance_date'] ?? now(),
            'is_active' => $validated['is_active'] ?? true, // Add this
        ]);

        // Create opening balance transaction entry if opening balance exists
        if (!empty($validated['opening_balance']) && $validated['opening_balance'] > 0) {
            $this->createOpeningBalanceTransaction($vendor);
        }

        DB::commit();

        if ($request->ajax()) {
            return response()->json([
                'success' => true,
                'message' => 'Vendor created successfully!',
                'data' => $vendor->load('ledgerAccount'),
            ]);
        }

        return redirect()
            ->route('vendors.index')
            ->with('success', 'Vendor created successfully!');

    } catch (\Exception $e) {
        DB::rollBack();
        Log::error('Vendor creation error: ' . $e->getMessage());
        
        if ($request->ajax()) {
            return response()->json([
                'success' => false,
                'message' => 'Error creating vendor: ' . $e->getMessage(),
            ], 500);
        }

        return redirect()
            ->back()
            ->withInput()
            ->with('error', 'Error creating vendor: ' . $e->getMessage());
    }
}


    /**
     * Display the specified vendor
     */
    public function show(Vendor $vendor)
    {
        $vendor->load(['ledgerAccount', 'purchaseOrders']);
        
        // Calculate current balance
        $currentBalance = $this->calculateVendorBalance($vendor);
        
        return view('vendors.show', compact('vendor', 'currentBalance'));
    }

    /**
     * Show the form for editing the specified vendor
     */
    public function edit(Vendor $vendor)
    {
        return view('vendors.edit', compact('vendor'));
    }

    /**
     * Update the specified vendor in storage
     */
public function update(Request $request, Vendor $vendor)
{
    $validated = $request->validate([
        'name' => 'required|string|max:255|unique:vendors,name,' . $vendor->id,
        'description' => 'nullable|string',
        'opening_balance' => 'nullable|numeric|min:0',
        'opening_balance_type' => 'required_with:opening_balance|in:debit,credit',
        'opening_balance_date' => 'nullable|date',
        'is_active' => 'nullable|boolean', // Add this
    ]);

    DB::beginTransaction();
    
    try {
        $oldOpeningBalance = $vendor->opening_balance;
        $oldOpeningBalanceType = $vendor->opening_balance_type;

        // Update vendor
        $vendor->update([
            'name' => $validated['name'],
            'description' => $validated['description'],
            'opening_balance' => $validated['opening_balance'] ?? 0,
            'opening_balance_type' => $validated['opening_balance_type'] ?? 'credit',
            'opening_balance_date' => $validated['opening_balance_date'] ?? $vendor->opening_balance_date,
            'is_active' => $validated['is_active'] ?? true, // Add this
        ]);

        // Update linked ledger account name and status
        if ($vendor->ledgerAccount) {
            $vendor->ledgerAccount->update([
                'name' => $validated['name'],
                'description' => 'Vendor Account: ' . $validated['name'],
                'is_active' => $validated['is_active'] ?? true, // Add this
            ]);
        }

        // Handle opening balance transaction changes
        $newOpeningBalance = $validated['opening_balance'] ?? 0;
        $newOpeningBalanceType = $validated['opening_balance_type'] ?? 'credit';

        if ($oldOpeningBalance != $newOpeningBalance || $oldOpeningBalanceType != $newOpeningBalanceType) {
            // Delete old opening balance transaction
            $this->deleteOpeningBalanceTransaction($vendor);
            
            // Create new opening balance transaction if amount > 0
            if ($newOpeningBalance > 0) {
                $this->createOpeningBalanceTransaction($vendor);
            }
        }

        DB::commit();

        if ($request->ajax()) {
            return response()->json([
                'success' => true,
                'message' => 'Vendor updated successfully!',
                'data' => $vendor->load('ledgerAccount'),
            ]);
        }

        return redirect()
            ->route('vendors.index')
            ->with('success', 'Vendor updated successfully!');

    } catch (\Exception $e) {
        DB::rollBack();
        Log::error('Vendor update error: ' . $e->getMessage());
        
        if ($request->ajax()) {
            return response()->json([
                'success' => false,
                'message' => 'Error updating vendor: ' . $e->getMessage(),
            ], 500);
        }

        return redirect()
            ->back()
            ->withInput()
            ->with('error', 'Error updating vendor: ' . $e->getMessage());
    }
}


    /**
     * Remove the specified vendor from storage
     */
    public function destroy(Vendor $vendor)
    {
        try {
            // Check if vendor has purchase orders
            if ($vendor->purchaseOrders()->count() > 0) {
                return response()->json([
                    'success' => false,
                    'message' => 'Cannot delete vendor with existing purchase orders.',
                ], 422);
            }

            DB::beginTransaction();

            // Delete opening balance transaction
            $this->deleteOpeningBalanceTransaction($vendor);

            // Store ledger account ID before deleting vendor
            $ledgerAccountId = $vendor->ledger_account_id;

            // Delete vendor
            $vendor->delete();

            // Optionally delete the ledger account if no transactions exist
            if ($ledgerAccountId) {
                $account = Account::find($ledgerAccountId);
                if ($account && $account->transactionEntries()->count() === 0) {
                    $account->delete();
                }
            }

            DB::commit();

            return response()->json([
                'success' => true,
                'message' => 'Vendor deleted successfully!',
            ]);

        } catch (\Exception $e) {
            DB::rollBack();
            Log::error('Vendor deletion error: ' . $e->getMessage());
            
            return response()->json([
                'success' => false,
                'message' => 'Error deleting vendor: ' . $e->getMessage(),
            ], 500);
        }
    }

    /**
     * Get vendor balance
     */
/**
 * Get vendor balance for AJAX requests
 */
public function getBalance(Vendor $vendor)
{
    try {
        // Use the model's accessor which properly calculates balance from ledger
        $balance = $vendor->current_balance;
        
        return response()->json([
            'success' => true,
            'balance' => $balance,
            'formatted' => ' ' . number_format(abs($balance), 2),
            'type' => $balance > 0 ? 'payable' : ($balance < 0 ? 'receivable' : 'zero')
        ]);
        
    } catch (\Exception $e) {
        Log::error('Vendor balance fetch error: ' . $e->getMessage());
        return response()->json([
            'success' => false,
            'balance' => 0,
            'message' => 'Error fetching vendor balance'
        ], 500);
    }
}


    /**
     * Calculate vendor balance including opening balance
     */
private function calculateVendorBalance(Vendor $vendor): float
{
    $balance = 0;
    
    if ($vendor->ledger_account_id) {
        $account = Account::find($vendor->ledger_account_id);
        
        if ($account) {
            // Get transaction entries (excluding opening balance transactions to avoid double counting)
            $credits = $account->transactionEntries()
                ->whereHas('transaction', function ($query) {
                    $query->where('type', '!=', 'opening_balance');
                })
                ->where('type', 'credit')
                ->sum('amount');
            
            $debits = $account->transactionEntries()
                ->whereHas('transaction', function ($query) {
                    $query->where('type', '!=', 'opening_balance');
                })
                ->where('type', 'debit')
                ->sum('amount');
            
            // Calculate transaction balance (excluding opening balance)
            $transactionBalance = $credits - $debits;
            
            // Add opening balance based on type
            if ($vendor->opening_balance > 0) {
                if ($vendor->opening_balance_type === 'credit') {
                    // Credit opening balance means we owe vendor
                    $balance = $transactionBalance + $vendor->opening_balance;
                } else {
                    // Debit opening balance means vendor owes us
                    $balance = $transactionBalance - $vendor->opening_balance;
                }
            } else {
                $balance = $transactionBalance;
            }
        }
    }
    
    return round($balance, 2);
}

    /**
     * Create opening balance transaction
     */
/**
 * Create opening balance transaction
 */
private function createOpeningBalanceTransaction(Vendor $vendor): void
{
    if (!$vendor->ledger_account_id || $vendor->opening_balance <= 0) {
        return;
    }

    // Get or create Capital Account for contra entry
    $capitalAccount = Account::firstOrCreate(
        ['code' => 'CAPITAL-001'],
        [
            'name' => 'Capital Account',
            'type' => 'equity',
            'description' => 'Owner Capital Account for Opening Balances',
            'is_active' => true,
        ]
    );

    // Create transaction
    $transaction = Transaction::create([
        'date' => $vendor->opening_balance_date ?? now(),
        'type' => 'opening_balance',
        'reference' => 'OB-VEND-' . $vendor->id . '-' . time(),
        'description' => 'Opening Balance for Vendor: ' . $vendor->name,
    ]);

    // Create transaction entries based on opening balance type
    if ($vendor->opening_balance_type === 'credit') {
        // Credit vendor account (liability increases)
        TransactionEntry::create([
            'transaction_id' => $transaction->id,
            'account_id' => $vendor->ledger_account_id,
            'type' => 'credit',
            'amount' => $vendor->opening_balance,
            'description' => 'Opening Balance - Vendor Credit',
        ]);

        // Debit capital account
        TransactionEntry::create([
            'transaction_id' => $transaction->id,
            'account_id' => $capitalAccount->id,
            'type' => 'debit',
            'amount' => $vendor->opening_balance,
            'description' => 'Opening Balance - Contra Entry',
        ]);
    } else {
        // Debit vendor account (vendor owes us)
        TransactionEntry::create([
            'transaction_id' => $transaction->id,
            'account_id' => $vendor->ledger_account_id,
            'type' => 'debit',
            'amount' => $vendor->opening_balance,
            'description' => 'Opening Balance - Vendor Debit',
        ]);

        // Credit capital account
        TransactionEntry::create([
            'transaction_id' => $transaction->id,
            'account_id' => $capitalAccount->id,
            'type' => 'credit',
            'amount' => $vendor->opening_balance,
            'description' => 'Opening Balance - Contra Entry',
        ]);
    }
}


    /**
     * Delete opening balance transaction
     */
private function deleteOpeningBalanceTransaction(Vendor $vendor): void
{
    if (!$vendor->ledger_account_id) {
        return;
    }

    $transaction = Transaction::where('type', 'opening_balance')
        ->where('reference', 'LIKE', 'OB-VEND-' . $vendor->id . '-%')
        ->first();

    if ($transaction) {
        // Delete transaction entries first
        $transaction->entries()->delete();
        // Delete transaction
        $transaction->delete();
    }
}
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\AuthenticatedSessionController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Http\Requests\Auth\LoginRequest;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\View\View;

class AuthenticatedSessionController extends Controller
{
    /**
     * Display the login view.
     */
    public function create(): View
    {
        return view('auth.login');
    }

    /**
     * Handle an incoming authentication request.
     */
    public function store(LoginRequest $request): RedirectResponse
    {
        $request->authenticate();

        $request->session()->regenerate();

        return redirect()->intended(route('dashboard', absolute: false));
    }

    /**
     * Destroy an authenticated session.
     */
    public function destroy(Request $request): RedirectResponse
    {
        Auth::guard('web')->logout();

        $request->session()->invalidate();

        $request->session()->regenerateToken();

        return redirect('/');
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\ConfirmablePasswordController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Validation\ValidationException;
use Illuminate\View\View;

class ConfirmablePasswordController extends Controller
{
    /**
     * Show the confirm password view.
     */
    public function show(): View
    {
        return view('auth.confirm-password');
    }

    /**
     * Confirm the user's password.
     */
    public function store(Request $request): RedirectResponse
    {
        if (! Auth::guard('web')->validate([
            'email' => $request->user()->email,
            'password' => $request->password,
        ])) {
            throw ValidationException::withMessages([
                'password' => __('auth.password'),
            ]);
        }

        $request->session()->put('auth.password_confirmed_at', time());

        return redirect()->intended(route('dashboard', absolute: false));
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\EmailVerificationNotificationController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;

class EmailVerificationNotificationController extends Controller
{
    /**
     * Send a new email verification notification.
     */
    public function store(Request $request): RedirectResponse
    {
        if ($request->user()->hasVerifiedEmail()) {
            return redirect()->intended(route('dashboard', absolute: false));
        }

        $request->user()->sendEmailVerificationNotification();

        return back()->with('status', 'verification-link-sent');
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\EmailVerificationPromptController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\View\View;

class EmailVerificationPromptController extends Controller
{
    /**
     * Display the email verification prompt.
     */
    public function __invoke(Request $request): RedirectResponse|View
    {
        return $request->user()->hasVerifiedEmail()
                    ? redirect()->intended(route('dashboard', absolute: false))
                    : view('auth.verify-email');
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\NewPasswordController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Auth\Events\PasswordReset;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Support\Facades\Password;
use Illuminate\Support\Str;
use Illuminate\Validation\Rules;
use Illuminate\View\View;

class NewPasswordController extends Controller
{
    /**
     * Display the password reset view.
     */
    public function create(Request $request): View
    {
        return view('auth.reset-password', ['request' => $request]);
    }

    /**
     * Handle an incoming new password request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): RedirectResponse
    {
        $request->validate([
            'token' => ['required'],
            'email' => ['required', 'email'],
            'password' => ['required', 'confirmed', Rules\Password::defaults()],
        ]);

        // Here we will attempt to reset the user's password. If it is successful we
        // will update the password on an actual user model and persist it to the
        // database. Otherwise we will parse the error and return the response.
        $status = Password::reset(
            $request->only('email', 'password', 'password_confirmation', 'token'),
            function (User $user) use ($request) {
                $user->forceFill([
                    'password' => Hash::make($request->password),
                    'remember_token' => Str::random(60),
                ])->save();

                event(new PasswordReset($user));
            }
        );

        // If the password was successfully reset, we will redirect the user back to
        // the application's home authenticated view. If there is an error we can
        // redirect them back to where they came from with their error message.
        return $status == Password::PASSWORD_RESET
                    ? redirect()->route('login')->with('status', __($status))
                    : back()->withInput($request->only('email'))
                        ->withErrors(['email' => __($status)]);
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\PasswordController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules\Password;

class PasswordController extends Controller
{
    /**
     * Update the user's password.
     */
    public function update(Request $request): RedirectResponse
    {
        $validated = $request->validateWithBag('updatePassword', [
            'current_password' => ['required', 'current_password'],
            'password' => ['required', Password::defaults(), 'confirmed'],
        ]);

        $request->user()->update([
            'password' => Hash::make($validated['password']),
        ]);

        return back()->with('status', 'password-updated');
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\PasswordResetLinkController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Password;
use Illuminate\View\View;

class PasswordResetLinkController extends Controller
{
    /**
     * Display the password reset link request view.
     */
    public function create(): View
    {
        return view('auth.forgot-password');
    }

    /**
     * Handle an incoming password reset link request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): RedirectResponse
    {
        $request->validate([
            'email' => ['required', 'email'],
        ]);

        // We will send the password reset link to this user. Once we have attempted
        // to send the link, we will examine the response then see the message we
        // need to show to the user. Finally, we'll send out a proper response.
        $status = Password::sendResetLink(
            $request->only('email')
        );

        return $status == Password::RESET_LINK_SENT
                    ? back()->with('status', __($status))
                    : back()->withInput($request->only('email'))
                        ->withErrors(['email' => __($status)]);
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\RegisteredUserController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use App\Models\User;
use Illuminate\Auth\Events\Registered;
use Illuminate\Http\RedirectResponse;
use Illuminate\Http\Request;
use Illuminate\Support\Facades\Auth;
use Illuminate\Support\Facades\Hash;
use Illuminate\Validation\Rules;
use Illuminate\View\View;

class RegisteredUserController extends Controller
{
    /**
     * Display the registration view.
     */
    public function create(): View
    {
        return view('auth.register');
    }

    /**
     * Handle an incoming registration request.
     *
     * @throws \Illuminate\Validation\ValidationException
     */
    public function store(Request $request): RedirectResponse
    {
        $request->validate([
            'name' => ['required', 'string', 'max:255'],
            'email' => ['required', 'string', 'lowercase', 'email', 'max:255', 'unique:'.User::class],
            'password' => ['required', 'confirmed', Rules\Password::defaults()],
        ]);

        $user = User::create([
            'name' => $request->name,
            'email' => $request->email,
            'password' => Hash::make($request->password),
        ]);

        event(new Registered($user));

        Auth::login($user);

        return redirect(route('dashboard', absolute: false));
    }
}



================================================================================
FILE: I:\Laravel Projects\gnucash\app\Http\Controllers\Auth\VerifyEmailController.php
================================================================================

<?php

namespace App\Http\Controllers\Auth;

use App\Http\Controllers\Controller;
use Illuminate\Auth\Events\Verified;
use Illuminate\Foundation\Auth\EmailVerificationRequest;
use Illuminate\Http\RedirectResponse;

class VerifyEmailController extends Controller
{
    /**
     * Mark the authenticated user's email address as verified.
     */
    public function __invoke(EmailVerificationRequest $request): RedirectResponse
    {
        if ($request->user()->hasVerifiedEmail()) {
            return redirect()->intended(route('dashboard', absolute: false).'?verified=1');
        }

        if ($request->user()->markEmailAsVerified()) {
            event(new Verified($request->user()));
        }

        return redirect()->intended(route('dashboard', absolute: false).'?verified=1');
    }
}



